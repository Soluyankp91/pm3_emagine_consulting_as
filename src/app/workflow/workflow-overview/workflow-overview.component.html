<div class="workflow-overview" *ngIf="componentInitalized">
    <div *ngFor="let item of workflowProcesses">
        <div class="workflow-overview--team" fxLayout="row" fxLayoutGap="60px" [ngClass]="{'flex-items-center': !item.typeId}">
            <div fxLayout="column" fxLayoutAlign="start start" fxFlex="15%">
                <span class="flex-row flex-items-center" [ngClass]="{'u-mb--10': item.typeId}">
                    <ng-container [ngSwitch]="item.typeId">
                        <ng-container *ngSwitchCase="workflowProcessType.StartClientPeriod">
                            <mat-icon svgIcon="workflowAdd"></mat-icon>
                        </ng-container>
                        <ng-container *ngSwitchCase="workflowProcessType.ExtendClientPeriod">
                            <mat-icon svgIcon="workflowStartOrExtend"></mat-icon>
                        </ng-container>
                        <ng-container *ngSwitchCase="workflowProcessType.TerminateWorkflow">
                            <mat-icon svgIcon="workflowTerminate"></mat-icon>
                        </ng-container>
                        <ng-container *ngSwitchCase="workflowProcessType.ChangeClientPeriod">
                            <mat-icon svgIcon="workflowEdit"></mat-icon>
                        </ng-container>
                        <ng-container *ngSwitchCase="workflowProcessType.StartConsultantPeriod">
                            <mat-icon svgIcon="workflowAdd"></mat-icon>
                        </ng-container>
                        <ng-container *ngSwitchCase="workflowProcessType.ChangeConsultantPeriod">
                            <mat-icon svgIcon="workflowEdit"></mat-icon>
                        </ng-container>
                        <ng-container *ngSwitchCase="workflowProcessType.ExtendConsultantPeriod">
                            <mat-icon svgIcon="workflowStartOrExtend"></mat-icon>
                        </ng-container>
                        <ng-container *ngSwitchCase="workflowProcessType.TerminateConsultant">
                            <mat-icon svgIcon="workflowTerminate"></mat-icon>
                        </ng-container>
                        <ng-container *ngSwitchDefault>
                            <mat-icon svgIcon="what-next-icon" class="u-mr--10"></mat-icon>
                        </ng-container>
                    </ng-container>
                    <span class="workflow-overview--process">
                        {{item.name ? item.name : 'What next?'}}
                    </span>
                </span>
                <span class="workflow-overview--process-daterange u-ml--5">{{(item.periodStartDate | momentFormat) + ' - ' + (item.periodEndDate ? (item.periodEndDate | momentFormat) : '...')}}</span>
            </div>
            <div fxLayout="row" fxLayoutAlign="start center" *ngFor="let step of item.steps; trackBy: stepsTrackBy" [fxFlex]="step.isFakeActiveStep ? 'auto' : '20%'">
                <ng-container *ngIf="!step.isFakeActiveStep; else fakeActiveStepTemplate">
                    <div class="workflow-overview--team__user column">
                        <div fxLayout="row" fxLayoutAlign="start center">
                            <div class="workflow-overview--team__user-img u-mr--16" [ngClass]="{'completed-step': step.status === workflowStepStatus.Completed}">
                                <app-manager-search
                                    appPreventDoubleClick (throttledClick)="$event.stopPropagation()"
                                    [formFieldLabel]="step.name + ' Manager'"
                                    [periodId]="item.consultantPeriodId!"
                                    [consultantPeriodId]="item.consultantPeriodId!"
                                    [stepType]="step.typeId!"
                                    [periodType]="step.typeId!"
                                    [workflowId]="workflowId"
                                    [managerStatus]="step.status!"
                                    [responsiblePerson]="step.responsiblePerson!"
                                    [readonly]="item.consultantPeriodId === null || item.consultantPeriodId === undefined"
                                    [width]="30"
                                    [height]="30">
                                </app-manager-search>
                            </div>
                            <div class="column">
                                <h2 class="workflow-overview--team__user-position">{{step.name}}</h2>
                                <p class="workflow-overview--team__user-name">{{step.responsiblePerson?.name}}</p>
                            </div>
                        </div>
                        <div class="workflow-overview--team__user-progress u-w--100" [ngClass]="{'finished': step.status === workflowStepStatus.Completed, 'in-progress': step.status === workflowStepStatus.Pending}" [matTooltip]="displayStepActionTooltip(step)" matTooltipClass="white-tooltip">
                        </div>
                        <div fxLayout="row" fxLayoutAlign="end center" class="u-w--100">
                            <span class="icon-in-progress u-mr--5">
                                <mat-icon svgIcon="{{step.status === workflowStepStatus.Completed ? 'completed-icon' : 'in-progress-icon'}}"></mat-icon>
                            </span>
                            <span class="workflow-overview--team__user-status" [ngClass]="{'finished': step.status !== workflowStepStatus.Completed}">
                                {{displayStepAction(step)}}
                            </span>
                        </div>
                    </div>
                </ng-container>
                <ng-template #fakeActiveStepTemplate>
                    <div class="workflow-overview--team__user column">
                        <div fxLayout="row" fxLayoutAlign="start center">
                            <div class="workflow-overview--team__user-img u-mr--16" [ngClass]="{'completed-step': step.status === workflowStepStatus.Completed}">
                                <app-manager-search
                                    appPreventDoubleClick (throttledClick)="$event.stopPropagation()"
                                    [formFieldLabel]="step.name + ' Manager'"
                                    [periodId]="periodId!"
                                    [consultantPeriodId]="periodId!"
                                    [stepType]="step.typeId!"
                                    [periodType]="step.typeId!"
                                    [workflowId]="workflowId"
                                    [managerStatus]="step.status!"
                                    [responsiblePerson]="step.responsiblePerson!"
                                    [readonly]="periodId === null || periodId === undefined"
                                    [isFakeActiveStep]="step.isFakeActiveStep!"
                                    [width]="30"
                                    [height]="30">
                                </app-manager-search>
                            </div>
                            <div class="column">
                                <h2 class="workflow-overview--team__user-position">Account manager</h2>
                                <p class="workflow-overview--team__user-name">{{step.responsiblePerson?.name}}</p>
                            </div>
                        </div>
                    </div>
                    <div fxLayout="row" fxLayoutAlign="end center" class="u-w--100">
                        <button
                            class="button-outlined"
                            mat-flat-button
                            (click)="getAvailableConsultantForChangeOrExtend()">
                            Extend workflow
                        </button>
                    </div>
                </ng-template>
            </div>
        </div>
    </div>
    <div class="workflow-overview--timeline" fxLayout="row" fxLayoutAlign="start start" [fxHide]="overviewGroups.length === 0 && overviewItems.length === 0" fxFlexFill>
        <app-gantt-chart *ngIf="overviewGroups.length && overviewItems.length"
            #gantt
            [items]="overviewItems"
            [groups]="overviewGroups"
            [viewOptions]="viewOptions"
            [viewType]="viewType"
            [draggable]="false"
            [showTodayLine]="false">
            <ng-template #group let-group="group">
            </ng-template>
            <ng-template #bar let-item="item">
            </ng-template>
        </app-gantt-chart>

        <div fxFlex="3%" fxLayout="column" class="u-mt--44">
            <ng-container *ngIf="individualConsultantActionsAvailable">
                <div *ngFor="let item of overviewGroups" class="workflow-overview--timeline-actions">
                    <button  mat-icon-button appPreventDoubleClick (throttledClick)="$event.stopPropagation();" type="button" [matMenuTriggerFor]="consultantMenu" class="three-dots-actions-btn workflow-overview--three-dots">
                        <mat-icon svgIcon="3-dots"></mat-icon>
                    </button>
                    <mat-menu #consultantMenu>
                        <button
                            class="menu-item menu-item--edit"
                            mat-menu-item
                            appPreventDoubleClick (throttledClick)="changeConsultantData(item.origin)">
                            <mat-icon>create</mat-icon>
                            Change consultant data
                        </button>
                        <button
                            class="menu-item menu-item--edit"
                            mat-menu-item
                            appPreventDoubleClick (throttledClick)="extendConsultant(item.origin)">
                            <mat-icon>add</mat-icon>
                            Extend consultant
                        </button>
                        <!-- FIXME: uncomment when BE will return cons id -->
                        <!-- <button
                            class="menu-item menu-item--cancel"
                            mat-menu-item
                            appPreventDoubleClick (throttledClick)="terminateConsultant(item.origin)">
                            <mat-icon>clear</mat-icon>
                            Terminate consultant
                        </button> -->
                    </mat-menu>
                </div>
            </ng-container>
        </div>
    </div>
    <ng-container *ngIf="workflowHistory.length">
        <mat-divider class="u-w--100 u-mb--30"></mat-divider>
        <h2 class="workflow-overview--history-header u-mb--30">Latest changes</h2>
        <div fxLayout="row" fxLayoutAlign="start start" class="workflow-overview--history">
            <div fxLayout="column" fxLayoutAlign="start start" fxFlex="40%">
                <div fxlayout="row" fxLayoutAlign="start center" class="u-mb--15 u-w--100" *ngFor="let item of workflowHistory" >
                    <span class="workflow-overview--history-grey-text" fxFlex="20%">
                        {{item.occurredAtUtc | momentFormat: 'DD.MM.YYYY HH:mm'}}
                    </span>
                    <img class="workflow-overview--history-img u-mr--16" [src]="employeeProfileUrl(item.initiatedBy?.externalId!)" alt="">
                    <span class="workflow-overview--history-event-name text-truncate-ellipsis"  [matTooltip]="item.eventName!" matTooltipClass="white-tooltip" fxFlex="40%" appShowIfTruncated>
                        {{item.eventName}}
                    </span>
                    <span class="workflow-overview--history-grey-text text-truncate-ellipsis" [matTooltip]="item.initiatedBy?.name!" matTooltipClass="white-tooltip" fxFlex="30%" appShowIfTruncated>
                        {{item.initiatedBy?.name}}
                    </span>
                </div>
            </div>
        </div>
        <div class="pagination-container u-w--100">
            <mat-paginator #historyPaginator [length]="historyTotalCount" [pageSize]="historyDeafultPageSize" [pageIndex]="historyPageNumber-1"
                [pageSizeOptions]="pageSizeOptions" [showFirstLastButtons]="true" (page)="historyPageChanged($event)">
            </mat-paginator>
        </div>
    </ng-container>
</div>
