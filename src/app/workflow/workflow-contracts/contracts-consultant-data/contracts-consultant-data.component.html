<form [formGroup]="contractsConsultantsDataForm" class="u-w--100">
    <ng-container formArrayName="consultants">
        <ng-container
            *ngFor="let consultant of contractsConsultantsDataForm.consultants.controls; trackBy: trackByItem; let consultantIndex = index"
            [formGroupName]="consultantIndex">
            <div class="workflow-form--consultants u-w--100" [id]="'consultantDataAnchor' + consultantIndex">
                <div fxLayout="column" fxLayoutAlign="start start" class="workflow-contracts--process-data u-w--100">
                    <div fxLayout="column" fxLayoutAlign="start start" class="u-w--100">
                        <div fxLayout="row" fxLayoutAlign="start center" class="u-w--100">
                            <h1 class="workflow-section--header-main">Consultant data</h1>
                            <ng-container
                                *ngIf="consultant.value?.consultant?.id || consultant.value?.consultantNameOnly">
                                <ng-container *ngIf="consultant.value?.consultant?.id">
                                    <img class="image-thumbnail-small border-rounded-50 u-ml--16 u-mr--16"
                                        [ngSrc]="consultantPhotoUrl + consultant.value?.consultant?.externalId + '.jpg'" width="35" height="35" src (error)="setDefaultImage($event.target)" />
                                </ng-container>
                                <span class="workflow-form--consultants__name">
                                    {{consultant.value?.consultant?.name}}
                                </span>
                            </ng-container>
                        </div>
                        <div fxLayout="row" fxLayoutAlign="start center" class="u-mt--16 u-mb--16" id="contractConsultantEmployment">
                            <span class="workflow-section--number">1</span>
                            <h2 class="workflow-section--header">Employment type</h2>
                        </div>
                        <div class="workflow-section--content">
                            <div fxLayout="row" fxLayoutAlign="start start" class="u-w--100">
                                <mat-form-field appearance="outline"
                                    class="formFieldNoMarginPadding filter-select form-width-235">
                                    <mat-label>Employment type</mat-label>
                                    <mat-select [disabled]="true" required formControlName="consultantType"
                                        [disableOptionCentering]="true" [compareWith]="compareWithFn">
                                        <ng-container *ngFor="let item of employmentTypes; trackBy: trackById">
                                            <mat-option [value]="item">
                                                {{ item?.name }}
                                            </mat-option>
                                        </ng-container>
                                    </mat-select>
                                    <mat-error>
                                        <app-validator [control]="consultant.get('consultantType')"></app-validator>
                                    </mat-error>
                                </mat-form-field>
                            </div>
                            <div fxLayout="row" fxLayoutAlign="start start" class="u-w--100">
                                <ng-container *ngIf="consultant.value?.consultantType?.id !== 10 && consultant.value?.consultantType?.id !== 11; else nameOnlyConsutlant">
                                    <mat-form-field appearance="outline"
                                        class="formFieldNoMarginPadding client-and-consultant-autocomplete disabled-input autocompleteWithShevron"
                                        [ngClass]="{'isPanelOpen': consultantAutocomplete.isOpen}">
                                        <mat-label>Consultant Name</mat-label>
                                        <input [disabled]="true" type="text" matInput name="consutlantNameAutocomplete"
                                            formControlName="consultant" [matAutocomplete]="consultantAutocomplete"
                                            appPreventDoubleClick (throttledClick)="$event.stopPropagation()"
                                            placeholder="Consultant name">
                                            <span matSuffix class="shevron"></span>
                                        <mat-autocomplete #consultantAutocomplete="matAutocomplete"
                                            [displayWith]="displayNameFn">
                                            <ng-container *ngFor="let item of filteredConsultants; trackBy: trackById">
                                                <mat-option [value]="item" [ngClass]="{ 'no-data': item?.id === undefined }"
                                                    appPreventDoubleClick>
                                                    <div class="multilineDropdown-option--row">
                                                        <ng-container *ngIf="item?.id !== undefined">
                                                            <img class="image-thumbnail-small border-rounded-50 u-mr--10"
                                                                [ngSrc]="consultantPhotoUrl + item?.externalId! + '.jpg'" width="35" height="35" src (error)="setDefaultImage($event.target)" />
                                                        </ng-container>
                                                        <div
                                                            class="multilineDropdown-option--column text-truncate-ellipsis">
                                                            <span class="multilineDropdown-option--column-client-name">{{
                                                                item?.name }}</span>
                                                            <ng-container *ngIf="item?.id !== undefined">
                                                                <span
                                                                    class="multilineDropdown-option--column-client-info text-truncate-ellipsis">
                                                                    {{item?.companyName ? item.companyName + ' | ' : ''}}
                                                                    {{item?.city ? item.city + ' | ' : ''}} #{{item?.id}} /
                                                                    {{item?.legacyId}}
                                                                </span>
                                                            </ng-container>
                                                        </div>
                                                    </div>
                                                </mat-option>
                                            </ng-container>
                                        </mat-autocomplete>
                                        <mat-error>
                                            <app-validator [control]="consultant.get('consultant')"></app-validator>
                                        </mat-error>
                                    </mat-form-field>
                                </ng-container>
                                <ng-template #nameOnlyConsutlant>
                                    <mat-form-field appearance="outline"
                                        class="client-and-consultant-autocomplete formFieldNoMarginPadding filter-select disabled-input">
                                        <mat-label>Consultant Name only</mat-label>
                                        <input [disabled]="true" type="text" matInput formControlName="nameOnly"
                                            placeholder="Consultant name only">
                                        <mat-error>
                                            <app-validator [control]="consultant.get('nameOnly')"></app-validator>
                                        </mat-error>
                                    </mat-form-field>
                                </ng-template>
                            </div>
                            <app-consultant-information [onlyAdditionalInfo]="true"
                                [consultantData]="consultant?.value?.consultant"></app-consultant-information>
                        </div>
                    </div>

                    <!-- Only visible when employment type is selected and it is not 'Fee only' - id: 10 nd not 'Recruitment' - id:11 -->
                    <ng-container *ngIf="consultant.value.consultantType?.id !== 10 && consultant.value.consultantType?.id !== 11">
                        <div fxLayout="column" fxLayoutAlign="start start" class="u-w--100" id="contractConsultantInvoicing">
                            <div fxLayout="row" fxLayoutAlign="start center" class="u-mt--16 u-mb--16">
                                <span class="workflow-section--number">2</span>
                                <h2 class="workflow-section--header">Invoicing</h2>
                            </div>
                            <div class="workflow-section--content">
                                <ng-container *ngIf="contractClientForm.clientTimeReportingCapId?.value?.id === clientTimeReportingCaps.IndividualCap; else noConsultantInvoicing">
                                    <div fxLayout="row" fxLayoutAlign="start center" class="u-w--100">
                                        <mat-form-field appearance="outline"
                                            class="formFieldNoMarginPadding filter-select u-mr--12 form-width-150">
                                            <mat-label>Cap type</mat-label>
                                            <mat-select [disabled]="true" formControlName="consultantCapOnTimeReporting"
                                                [disableOptionCentering]="true" [compareWith]="compareWithFn">
                                                <ng-container
                                                    *ngFor="let item of consultantTimeReportingCapList; trackBy: trackById">
                                                    <mat-option [value]="item">
                                                        {{ item?.name }}
                                                    </mat-option>
                                                </ng-container>
                                            </mat-select>
                                            <mat-error>
                                                <app-validator
                                                    [control]="consultant.get('consultantCapOnTimeReporting')"></app-validator>
                                            </mat-error>
                                        </mat-form-field>
                                        <ng-container *ngIf="consultant?.value?.consultantCapOnTimeReporting?.id !== 4">
                                            <span class="workflow-darkblue--text">
                                                <ng-container
                                                    [ngSwitch]="consultant.value.consultantCapOnTimeReporting?.id">
                                                    <ng-container *ngSwitchCase="1"> <!-- Cap on units -->
                                                        <ng-container
                                                            [ngSwitch]="consultant.value.consultantRateUnitType?.id">
                                                            <ng-container *ngSwitchCase="1"> <!-- Per hour -->
                                                                hours
                                                            </ng-container>
                                                            <ng-container *ngSwitchCase="2"> <!-- Per day -->
                                                                days
                                                            </ng-container>
                                                            <ng-container *ngSwitchCase="4"> <!-- Per month -->
                                                                months
                                                            </ng-container>
                                                        </ng-container>
                                                    </ng-container>
                                                    <ng-container *ngSwitchCase="2"> <!-- Cap on value -->
                                                        {{consultant.value.consultantRateCurrency?.name}}
                                                    </ng-container>
                                                </ng-container>
                                            </span>
                                        </ng-container>
                                    </div>
                                </ng-container>
                                <ng-template #noConsultantInvoicing>
                                    <div fxLayout="row" fxLayoutAlign="space-between center" fxLayoutGap="10px"
                                        class="emptyStateRow">
                                        <span class="light-grey-color text-600">
                                            Required only for Individual Cap on time reporting
                                        </span>
                                    </div>
                                </ng-template>
                            </div>
                        </div>
                        <div fxLayout="column" fxLayoutAlign="start start" class="u-w--100" id="contractConsultantContract">
                            <div fxLayout="row" fxLayoutAlign="start center" class="u-mt--16 u-mb--16">
                                <span class="workflow-section--number">3</span>
                                <h2 class="workflow-section--header">Consultant contract terms</h2>
                            </div>
                            <div class="workflow-section--content">
                                <div fxLayout="row" fxLayoutAlign="start start" class="u-w--100">
                                    <mat-form-field appearance="outline"
                                        class="formFieldNoMarginPadding textarea-input u-mr--12 form-width-564"
                                        [ngClass]="{'disabled-input': readOnlyMode}">
                                        <mat-label>Special Contract Terms</mat-label>
                                        <textarea [disabled]="true" required matInput autocomplete="new-password"
                                            name="specialContractTerms" formControlName="specialContractTerms"
                                            [cdkTextareaAutosize]="true" [cdkAutosizeMinRows]="2">
                                        </textarea>
                                        <mat-error>
                                            <app-validator
                                                [control]="consultant.get('specialContractTerms')"></app-validator>
                                        </mat-error>
                                    </mat-form-field>
                                    <ng-container
                                        *ngIf="!readOnlyMode || consultant.get('noSpecialContractTerms')?.value">
                                        <mat-checkbox [disabled]="readOnlyMode" color="accent"
                                            formControlName="noSpecialContractTerms" name="noSpecialContractTerms"
                                            class="black-checkbox u-mt--10"
                                            (change)="disableOrEnableInput(contractsConsultantsDataForm.consultants.at(consultantIndex).get('noSpecialContractTerms')?.value, contractsConsultantsDataForm.consultants.at(consultantIndex).get('specialContractTerms'))">
                                            None
                                        </mat-checkbox>
                                    </ng-container>
                                </div>
                            </div>
                        </div>
                        <div fxLayout="column" fxLayoutAlign="start start" class="u-w--100" id="contractConsultantPayment">
                            <div fxLayout="row" fxLayoutAlign="start center" class="u-mt--16 u-mb--16">
                                <span class="workflow-section--number">4</span>
                                <h2 class="workflow-section--header">Consultant payment</h2>
                            </div>
                            <div class="workflow-section--content">
                                <div fxLayout="row" fxLayoutAlign="start start" class="u-w--100">
                                    <mat-form-field appearance="outline"
                                        class="form-width-564 formFieldNoMarginPadding textarea-input u-mr--12"
                                        [ngClass]="{'disabled-input': readOnlyMode}">
                                        <mat-label>Special Payment Terms</mat-label>
                                        <textarea [disabled]="readOnlyMode" required matInput
                                            autocomplete="new-password" name="specialPaymentTerms"
                                            formControlName="specialPaymentTerms" [cdkTextareaAutosize]="true"
                                            [cdkAutosizeMinRows]="2">
                                        </textarea>
                                        <mat-error>
                                            <app-validator
                                                [control]="consultant.get('specialPaymentTerms')"></app-validator>
                                        </mat-error>
                                    </mat-form-field>
                                    <ng-container
                                        *ngIf="!readOnlyMode || consultant.get('noSpecialPaymentTerms')?.value">
                                        <mat-checkbox [disabled]="readOnlyMode" color="accent"
                                            formControlName="noSpecialPaymentTerms" name="noSpecialPaymentTerms"
                                            class="black-checkbox u-mt--8"
                                            (change)="disableOrEnableInput(consultant?.value?.noSpecialPaymentTerms, consultant?.get('specialPaymentTerms'))">
                                            None
                                        </mat-checkbox>
                                    </ng-container>
                                </div>
                            </div>
                        </div>
                        <div fxLayout="column" fxLayoutAlign="start start" class="u-w--100" id="contractConsultantFrameAgreement">
                            <div fxLayout="row" fxLayoutAlign="start center" class="u-mt--16 u-mb--16">
                                <span class="workflow-section--number">5</span>
                                <h2 class="workflow-section--header">Frame agreement</h2>
                            </div>
                            <div class="workflow-section--content">
                                <ng-container *ngIf="isContractModuleEnabled; else noFrameAgreementsTemplate">
                                    <div fxLayout="row" fxLayoutAlign="start center" class="u-w--100">
                                        <mat-form-field appearance="outline" class="formFieldNoMarginPadding filter-select form-width-450">
                                            <mat-label>Frame agreement</mat-label>
                                            <mat-select [disabled]="readOnlyMode" formControlName="frameAgreementId"
                                                [disableOptionCentering]="true">
                                                <ng-container *ngFor="let item of frameAgreements[consultantIndex]; trackBy: trackByAgreementId">
                                                    <mat-option [value]="item.agreementId">
                                                        <div class="multilineDropdown-option--row">
                                                            <div class="multilineDropdown-option--column text-truncate-ellipsis">
                                                                <span class="multilineDropdown-option--column-client-name">{{ item.agreementName }}</span>
                                                                <span class="multilineDropdown-option--column-client-info text-truncate-ellipsis">
                                                                    {{item.countryName}}
                                                                    {{item.countryName ? 'â€¢' : '' + item.startDate | momentFormat}}
                                                                    {{item.startDate !== null && item.startDate !== undefined ? '-' : '' + item.endDate | momentFormat}}
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </mat-option>
                                                </ng-container>
                                            </mat-select>
                                            <mat-error>
                                                <app-validator [control]="consultant.get('frameAgreementId')"></app-validator>
                                            </mat-error>
                                        </mat-form-field>
                                    </div>
                                </ng-container>
                                <ng-template #noFrameAgreementsTemplate>
                                    <div fxLayout="row" fxLayoutAlign="space-between center" fxLayoutGap="10px"
                                        class="emptyStateRow">
                                        <span class="light-grey-color text-600">
                                            Coming soon - with the contracts module..
                                        </span>
                                    </div>
                                </ng-template>
                            </div>
                        </div>
                        <div fxLayout="column" fxLayoutAlign="start start" class="u-w--100" id="contractConsultantRatesFees">
                            <div fxLayout="row" fxLayoutAlign="start center" class="u-mt--16 u-mb--16">
                                <span class="workflow-section--number">6</span>
                                <h2 class="workflow-section--header">Consultant rates and fees</h2>
                            </div>
                            <div class="workflow-section--content">
                                <ng-container *ngIf="readOnlyMode; else specialRatesInput">
                                    <div class="inline-edit-form u-w--100">
                                        <ng-container *ngIf="consultant.value.specialRates?.length">
                                            <div fxLayout="row" fxLayoutAlign="space-between start" fxLayoutGap="10px"
                                                class="u-w--100 u-pl--16 u-pr--16 u-pb--10">
                                                <span fxFlex="1 0 20%"
                                                    class="workflow-contracts--list-header text-truncate-ellipsis u-w--100">
                                                    Rate name
                                                </span>
                                                <span fxFlex="20%"
                                                    class="workflow-contracts--list-header text-truncate-ellipsis u-w--100">
                                                    Reporting unit
                                                </span>
                                                <ng-container
                                                    *ngIf="consultant.value?.pdcPaymentEntityId !== contractClientForm.value?.pdcInvoicingEntityId">
                                                    <span fxFlex="25%"
                                                        class="workflow-contracts--list-header text-truncate-ellipsis u-w--100">
                                                        emagine rate
                                                    </span>
                                                </ng-container>
                                                <span fxFlex="25%"
                                                    class="workflow-contracts--list-header text-truncate-ellipsis u-w--100">
                                                    Consultant rate
                                                </span>
                                            </div>
                                        </ng-container>
                                        <ng-container class="u-w--100 u-pl--16 u-pr--16">
                                            <ng-container
                                                *ngFor="let rate of getConsultantSpecialRateControls(consultantIndex); let specialRateIndex = index">
                                                <div fxLayout="row" fxLayoutAlign="space-between center"
                                                    fxLayoutGap="10px"
                                                    class="workflow-contracts--list u-w--100 u-pl--16 u-pr--16">
                                                    <ng-container *ngIf="!rate.value.editable">
                                                        <span fxFlex="1 0 20%"
                                                            class="u-w--100 text-truncate-ellipsis workflow-contracts--list-item"
                                                            [matTooltip]="rate.value.rateName"
                                                            matTooltipClass="white-tooltip" appShowIfTruncated>
                                                            {{rate.value.rateName}}
                                                        </span>
                                                        <span fxFlex="20%"
                                                            class="u-w--100 text-truncate-ellipsis workflow-contracts--list-item"
                                                            [matTooltip]="rate.value.reportingUnit?.name"
                                                            matTooltipClass="white-tooltip" appShowIfTruncated>
                                                            {{rate.value.reportingUnit?.name}}
                                                        </span>
                                                        <ng-container
                                                            *ngIf="consultant.value?.pdcPaymentEntityId !== contractClientForm.value?.pdcInvoicingEntityId">
                                                            <span fxFlex="25%"
                                                                class="u-w--100 text-truncate-ellipsis workflow-contracts--list-item"
                                                                [matTooltip]="rate.value.proDataRateValue !== null && rate.value.proDataRateCurrency?.name ? rate.value.proDataRateValue + ' ' + rate.value.proDataRateCurrency?.name : '-'"
                                                                matTooltipClass="white-tooltip" appShowIfTruncated>
                                                                {{rate.value.proDataRateValue !== null &&
                                                                rate.value.proDataRateCurrency?.name ?
                                                                rate.value.proDataRateValue + ' ' +
                                                                rate.value.proDataRateCurrency?.name : '-'}}
                                                            </span>
                                                        </ng-container>
                                                        <span fxFlex="25%"
                                                            class="u-w--100 text-truncate-ellipsis workflow-contracts--list-item"
                                                            [matTooltip]="rate.value.consultantRateValue !== null && rate.value.consultantRateCurrency?.name ? rate.value.consultantRateValue + ' ' + rate.value.consultantRateCurrency?.name : '-'"
                                                            matTooltipClass="white-tooltip" appShowIfTruncated>
                                                            {{rate.value.consultantRateValue !== null &&
                                                            rate.value.consultantRateCurrency?.name ?
                                                            rate.value.consultantRateValue + ' ' +
                                                            rate.value.consultantRateCurrency?.name : '-'}}
                                                        </span>
                                                    </ng-container>
                                                </div>
                                            </ng-container>
                                            <ng-container
                                                *ngIf="consultant.value.specialRates?.length === 0 && readOnlyMode">
                                                <div fxLayout="row" fxLayoutAlign="space-between center"
                                                    fxLayoutGap="10px"
                                                    class="emptyStateRow u-pl--16 u-pr--16">
                                                    <span class="light-grey-color text-600">
                                                        No special rates
                                                    </span>
                                                </div>
                                            </ng-container>
                                        </ng-container>
                                    </div>
                                </ng-container>
                                <ng-template #specialRatesInput>
                                    <div class="inline-edit-form u-w--100">
                                        <ng-container *ngIf="consultant.value.specialRates?.length">
                                            <div fxLayout="row" fxLayoutAlign="space-between start" fxLayoutGap="10px"
                                                class="u-w--100 u-pl--16 u-pr--16 u-pb--5">
                                                <span fxFlex="1 0 20%"
                                                    class="workflow-contracts--list-header text-truncate-ellipsis u-w--100">
                                                    Rate name
                                                </span>
                                                <span fxFlex="20%"
                                                    class="workflow-contracts--list-header text-truncate-ellipsis u-w--100">
                                                    Reporting unit
                                                </span>
                                                <ng-container
                                                    *ngIf="consultant.value?.pdcPaymentEntityId !== contractClientForm.value?.pdcInvoicingEntityId">
                                                    <span fxFlex="25%"
                                                        class="workflow-contracts--list-header text-truncate-ellipsis u-w--100">
                                                        emagine rate
                                                    </span>
                                                </ng-container>
                                                <span fxFlex="25%"
                                                    class="workflow-contracts--list-header text-truncate-ellipsis u-w--100">
                                                    Consultant rate
                                                </span>
                                                <span fxFlex="10%"
                                                    class="workflow-contracts--list-header text-truncate-ellipsis u-w--100">

                                                </span>
                                            </div>
                                        </ng-container>
                                        <ng-container formArrayName="specialRates" class="u-w--100 u-pl--16 u-pr--16">
                                            <ng-container
                                                *ngFor="let rate of getConsultantSpecialRateControls(consultantIndex); let specialRateIndex = index"
                                                [formGroupName]="specialRateIndex">
                                                <div fxLayout="row" fxLayoutAlign="space-between center"
                                                    fxLayoutGap="10px"
                                                    class="workflow-contracts--list u-w--100 u-pl--16 u-pr--16">
                                                    <span fxFlex="1 0 20%"
                                                        class="u-w--100 text-truncate-ellipsis workflow-contracts--list-item"
                                                        [matTooltip]="rate.value.rateName"
                                                        matTooltipClass="white-tooltip" appShowIfTruncated>
                                                        {{rate.value.rateName}}
                                                    </span>
                                                    <span fxFlex="20%"
                                                        class="u-w--100 text-truncate-ellipsis workflow-contracts--list-item"
                                                        [matTooltip]="rate.value.reportingUnit?.name"
                                                        matTooltipClass="white-tooltip" appShowIfTruncated>
                                                        {{rate.value.reportingUnit?.name}}
                                                    </span>
                                                    <ng-container
                                                        *ngIf="consultant.value?.pdcPaymentEntityId !== contractClientForm.value?.pdcInvoicingEntityId">
                                                        <ng-container
                                                            *ngIf="rate.value.editable; else consutlantProDataRateCurrencyDisplay">
                                                            <div fxFlex="25%" fxLayout="row"
                                                                fxLayoutAlign="start start">
                                                                <mat-form-field appearance="fill"
                                                                    class="u-w--100 formFieldNoMarginPadding filter-select u-mr--10"
                                                                    fxFlex="30%">
                                                                    <input
                                                                        [required]="consultant.value?.pdcPaymentEntityId !== contractClientForm.value?.pdcInvoicingEntityId"
                                                                        matInput type="number" placeholder="Rate"
                                                                        formControlName="proDataRateValue">
                                                                </mat-form-field>
                                                                <mat-form-field appearance="fill"
                                                                    class="u-w--100 formFieldNoMarginPadding filter-select"
                                                                    fxFlex="50%">
                                                                    <mat-select
                                                                        [required]="consultant.value?.pdcPaymentEntityId !== contractClientForm.value?.pdcInvoicingEntityId"
                                                                        formControlName="proDataRateCurrency"
                                                                        placeholder="Currency"
                                                                        [disableOptionCentering]="true"
                                                                        [compareWith]="compareWithFn">
                                                                        <ng-container
                                                                            *ngFor="let item of currencies; trackBy: trackById">
                                                                            <mat-option [value]="item">
                                                                                {{ item?.name }}
                                                                            </mat-option>
                                                                        </ng-container>
                                                                    </mat-select>
                                                                </mat-form-field>
                                                            </div>
                                                        </ng-container>
                                                        <ng-template #consutlantProDataRateCurrencyDisplay>
                                                            <span fxFlex="25%"
                                                                class="u-w--100 text-truncate-ellipsis workflow-contracts--list-item"
                                                                [matTooltip]="rate.value.proDataRateValue !== null && rate.value.proDataRateCurrency?.name ? rate.value.proDataRateValue + ' ' + rate.value.proDataRateCurrency?.name : '-'"
                                                                matTooltipClass="white-tooltip" appShowIfTruncated>
                                                                {{rate.value.proDataRateValue !== null &&
                                                                rate.value.proDataRateCurrency?.name ?
                                                                rate.value.proDataRateValue + ' ' +
                                                                rate.value.proDataRateCurrency?.name : '-'}}
                                                            </span>
                                                        </ng-template>
                                                    </ng-container>

                                                    <ng-container
                                                        *ngIf="rate.value.editable; else consutlantRateCurrencyDisplay">
                                                        <div fxFlex="25%" fxLayout="row" fxLayoutAlign="start start">
                                                            <mat-form-field appearance="fill"
                                                                class="u-w--100 formFieldNoMarginPadding filter-select u-mr--10"
                                                                fxFlex="30%">
                                                                <input required matInput type="number"
                                                                    placeholder="Rate"
                                                                    formControlName="consultantRateValue">
                                                            </mat-form-field>
                                                            <mat-form-field appearance="fill"
                                                                class="u-w--100 formFieldNoMarginPadding filter-select"
                                                                fxFlex="50%">
                                                                <mat-select required
                                                                    formControlName="consultantRateCurrency"
                                                                    placeholder="Currency"
                                                                    [disableOptionCentering]="true"
                                                                    [compareWith]="compareWithFn">
                                                                    <ng-container
                                                                        *ngFor="let item of currencies; trackBy: trackById">
                                                                        <mat-option [value]="item">
                                                                            {{ item?.name }}
                                                                        </mat-option>
                                                                    </ng-container>
                                                                </mat-select>
                                                            </mat-form-field>
                                                        </div>
                                                    </ng-container>

                                                    <ng-template #consutlantRateCurrencyDisplay>
                                                        <span fxFlex="25%"
                                                            class="u-w--100 text-truncate-ellipsis workflow-contracts--list-item"
                                                            [matTooltip]="rate.value.consultantRateValue !== null && rate.value.consultantRateCurrency?.name ? rate.value.consultantRateValue + ' ' + rate.value.consultantRateCurrency?.name : '-'"
                                                            matTooltipClass="white-tooltip" appShowIfTruncated>
                                                            {{rate.value.consultantRateValue !== null &&
                                                            rate.value.consultantRateCurrency?.name ?
                                                            rate.value.consultantRateValue + ' ' +
                                                            rate.value.consultantRateCurrency?.name : '-'}}
                                                        </span>
                                                    </ng-template>
                                                    <ng-container
                                                        *ngIf="rate.value.editable; else consultantRateActions">
                                                        <div fxFlex="10%" class="u-w--100 text-truncate-ellipsis"
                                                            fxLayoutAlign="end center">
                                                            <button mat-icon-button type="button"
                                                                [disabled]="!rate.valid" appPreventDoubleClick
                                                                (throttledClick)="editOrSaveConsultantSpecialRate(rate?.value.editable, consultantIndex, specialRateIndex)"
                                                                class="rates-and-fees--inline-edit-form--btn__save">
                                                                <mat-icon svgIcon="rates-save-icon"></mat-icon>
                                                            </button>
                                                            <button mat-icon-button type="button" appPreventDoubleClick
                                                                (throttledClick)="cancelEditConsultantRate(consultantIndex, specialRateIndex)"
                                                                class="rates-and-fees--inline-edit-form--btn__cancel">
                                                                <mat-icon svgIcon="rates-cancel-icon"></mat-icon>
                                                            </button>
                                                        </div>
                                                    </ng-container>
                                                    <ng-template #consultantRateActions>
                                                        <div fxFlex="10%" fxLayoutAlign="end center"
                                                            class="u-w--100 workflow-contracts--list-item">
                                                            <button mat-icon-button appPreventDoubleClick
                                                                (throttledClick)="$event.stopPropagation();"
                                                                [matMenuTriggerFor]="clientRateMenu"
                                                                class="three-dots-actions-btn">
                                                                <mat-icon svgIcon="3-dots"></mat-icon>
                                                            </button>
                                                            <mat-menu #clientRateMenu>
                                                                <button class="menu-item green-color" mat-menu-item
                                                                    [disabled]="isConsultantRateEditing"
                                                                    appPreventDoubleClick
                                                                    (throttledClick)="editOrSaveConsultantSpecialRate(rate.value.editable, consultantIndex, specialRateIndex)">
                                                                    <mat-icon svgIcon="edit-icon-green"></mat-icon>
                                                                    Edit
                                                                </button>
                                                                <button class="menu-item menu-item--cancel"
                                                                    mat-menu-item appPreventDoubleClick
                                                                    (throttledClick)="removeConsultantDataSpecialRate(consultantIndex, specialRateIndex)">
                                                                    <mat-icon svgIcon="close-icon"></mat-icon>
                                                                    Delete
                                                                </button>
                                                            </mat-menu>
                                                        </div>
                                                    </ng-template>
                                                </div>
                                            </ng-container>
                                        </ng-container>
                                    </div>
                                    <div fxLayout="row" fxLayoutAlign="start start" class="u-mb--10">
                                        <button class="rates-and-fees--btn button-add" mat-flat-button
                                            [matMenuTriggerFor]="consultantSpecialRateMenu"
                                            [disabled]="isConsultantRateEditing"
                                            (menuOpened)="contractsConsultantsDataForm.consultants.at(consultantIndex).get('consultantSpecialRateFilter')!.setValue(''); consultantSpecialRateSelect.open();"
                                            #consultantRateMenuTrigger="matMenuTrigger">
                                            <mat-icon>add</mat-icon>
                                            Add special rate
                                        </button>
                                        <mat-menu #consultantSpecialRateMenu backdropClass="add-rates-button--menu">
                                            <div mat-menu-item appPreventDoubleClick
                                                (throttledClick)="$event.stopPropagation()" class="u-pg--0">
                                                <mat-form-field appearance="fill"
                                                    class="add-rates-button--dropdown filter-select u-w--100">
                                                    <mat-label>Choose special rate</mat-label>
                                                    <mat-select #consultantSpecialRateSelect
                                                        formControlName="consultantSpecialRateFilter"
                                                        [disableOptionCentering]="true">
                                                        <ng-container *ngFor="let item of clientSpecialRateList | excludeIds: consultant.value.specialRates : 'clientSpecialRateId'; trackBy: trackById">
                                                            <mat-option [disabled]="item.id === null" [value]="item.id" appPreventDoubleClick (throttledClick)="item.id !== null ? selectConsultantSpecialRate(consultantIndex, item, consultantRateMenuTrigger) : ''">
                                                                {{ item.internalName }}
                                                            </mat-option>
                                                        </ng-container>
                                                    </mat-select>
                                                </mat-form-field>
                                            </div>
                                        </mat-menu>
                                    </div>
                                </ng-template>

                                <ng-container *ngIf="readOnlyMode; else clientFeesInput">
                                    <div class="inline-edit-form u-w--100">
                                        <ng-container *ngIf="consultant.value.clientFees?.length">
                                            <div fxLayout="row" fxLayoutAlign="space-between start" fxLayoutGap="10px"
                                                class="u-w--100 u-pl--16 u-pr--16 u-pb--5 u-pt--10">
                                                <span fxFlex="1 0 20%"
                                                    class="workflow-contracts--list-header text-truncate-ellipsis u-w--100">
                                                    Fee name
                                                </span>
                                                <span fxFlex="20%"
                                                    class="workflow-contracts--list-header text-truncate-ellipsis u-w--100">
                                                    Frequency
                                                </span>
                                                <ng-container
                                                    *ngIf="consultant.value?.pdcPaymentEntityId !== contractClientForm.value?.pdcInvoicingEntityId">
                                                    <span fxFlex="25%"
                                                        class="workflow-contracts--list-header text-truncate-ellipsis u-w--100">
                                                        emagine fee
                                                    </span>
                                                </ng-container>
                                                <span fxFlex="25%"
                                                    class="workflow-contracts--list-header text-truncate-ellipsis u-w--100">
                                                    Consultant fee
                                                </span>
                                            </div>
                                        </ng-container>
                                        <ng-container class="u-w--100">
                                            <ng-container
                                                *ngFor="let fee of getConsultantClientFeesControls(consultantIndex); let clientFeeIndex = index">
                                                <div fxLayout="row" fxLayoutAlign="space-between center"
                                                    fxLayoutGap="10px"
                                                    class="workflow-contracts--list u-w--100 u-pl--16 u-pr--16">
                                                    <span fxFlex="1 0 20%"
                                                        class="u-w--100 text-truncate-ellipsis workflow-contracts--list-item"
                                                        [matTooltip]="fee.value.feeName ?? '-'"
                                                        matTooltipClass="white-tooltip" appShowIfTruncated>
                                                        {{fee.value.feeName ?? '-'}}
                                                    </span>
                                                    <span fxFlex="20%"
                                                        class="u-w--100 text-truncate-ellipsis workflow-contracts--list-item"
                                                        [matTooltip]="fee.value.feeFrequency?.name ?? '-'"
                                                        matTooltipClass="white-tooltip" appShowIfTruncated>
                                                        {{fee.value.feeFrequency?.name ?? '-'}}
                                                    </span>
                                                    <ng-container
                                                        *ngIf="consultant.value?.pdcPaymentEntityId !== contractClientForm.value?.pdcInvoicingEntityId">
                                                        <span fxFlex="25%"
                                                            class="u-w--100 text-truncate-ellipsis workflow-contracts--list-item"
                                                            [matTooltip]="fee.value.proDataRateValue !== null && fee.value.proDataRateCurrency?.name ? fee.value.proDataRateValue + ' ' + fee.value.proDataRateCurrency?.name : '-'"
                                                            matTooltipClass="white-tooltip" appShowIfTruncated>
                                                            {{fee.value.proDataRateValue !== null &&
                                                            fee.value.proDataRateCurrency?.name ?
                                                            fee.value.proDataRateValue +
                                                            ' ' +
                                                            fee.value.proDataRateCurrency?.name : '-'}}
                                                        </span>
                                                    </ng-container>
                                                    <span fxFlex="25%"
                                                        class="u-w--100 text-truncate-ellipsis workflow-contracts--list-item"
                                                        [matTooltip]="fee.value.consultantRateValue !== null && fee.value.consultantRateCurrency?.name ? fee.value.consultantRateValue + ' ' + fee.value.consultantRateCurrency?.name : '-'"
                                                        matTooltipClass="white-tooltip" appShowIfTruncated>
                                                        {{fee.value.consultantRateValue !== null &&
                                                        fee.value.consultantRateCurrency?.name ?
                                                        fee.value.consultantRateValue + ' ' +
                                                        fee.value.consultantRateCurrency?.name : '-'}}
                                                    </span>
                                                </div>
                                            </ng-container>
                                            <ng-container
                                                *ngIf="consultant.value.clientFees?.length === 0 && readOnlyMode">
                                                <div fxLayout="row" fxLayoutAlign="space-between center"
                                                    fxLayoutGap="10px"
                                                    class="emptyStateRow u-pl--16 u-pr--16 u-mt--15">
                                                    <span class="light-grey-color text-600">
                                                        No special fees
                                                    </span>
                                                </div>
                                            </ng-container>
                                        </ng-container>
                                    </div>
                                </ng-container>
                                <ng-template #clientFeesInput>
                                    <div class="inline-edit-form u-w--100">
                                        <ng-container *ngIf="consultant.value.clientFees?.length">
                                            <div fxLayout="row" fxLayoutAlign="space-between start" fxLayoutGap="10px"
                                                class="u-w--100 u-pl--16 u-pr--16 u-pb--10">
                                                <span fxFlex="1 0 20%"
                                                    class="workflow-contracts--list-header text-truncate-ellipsis u-w--100">
                                                    Fee name
                                                </span>
                                                <span fxFlex="20%"
                                                    class="workflow-contracts--list-header text-truncate-ellipsis u-w--100">
                                                    Frequency
                                                </span>
                                                <ng-container
                                                    *ngIf="consultant.value?.pdcPaymentEntityId !== contractClientForm.value?.pdcInvoicingEntityId">
                                                    <span fxFlex="25%"
                                                        class="workflow-contracts--list-header text-truncate-ellipsis u-w--100">
                                                        emagine fee
                                                    </span>
                                                </ng-container>
                                                <span fxFlex="25%"
                                                    class="workflow-contracts--list-header text-truncate-ellipsis u-w--100">
                                                    Consultant fee
                                                </span>
                                                <span fxFlex="10%"
                                                    class="workflow-contracts--list-header text-truncate-ellipsis u-w--100">
                                                </span>
                                            </div>
                                        </ng-container>
                                        <ng-container formArrayName="clientFees" class="u-w--100">
                                            <ng-container
                                                *ngFor="let fee of getConsultantClientFeesControls(consultantIndex); let clientFeeIndex = index"
                                                [formGroupName]="clientFeeIndex">
                                                <div fxLayout="row" fxLayoutAlign="space-between center"
                                                    fxLayoutGap="10px"
                                                    class="workflow-contracts--list u-w--100 u-pl--16 u-pr--16">
                                                    <span fxFlex="1 0 20%"
                                                        class="u-w--100 text-truncate-ellipsis workflow-contracts--list-item"
                                                        [matTooltip]="fee.value.feeName ?? '-'"
                                                        matTooltipClass="white-tooltip" appShowIfTruncated>
                                                        {{fee.value.feeName ?? '-'}}
                                                    </span>
                                                    <span fxFlex="20%"
                                                        class="u-w--100 text-truncate-ellipsis workflow-contracts--list-item"
                                                        [matTooltip]="fee.value.feeFrequency?.name ?? '-'"
                                                        matTooltipClass="white-tooltip" appShowIfTruncated>
                                                        {{fee.value.feeFrequency?.name ?? '-'}}
                                                    </span>
                                                    <ng-container
                                                        *ngIf="consultant.value?.pdcPaymentEntityId !== contractClientForm.value?.pdcInvoicingEntityId">
                                                        <ng-container
                                                            *ngIf="fee.value.editable; else consultantFeeProDataRateDisplay">
                                                            <div fxFlex="25%" fxLayout="row"
                                                                fxLayoutAlign="start start">
                                                                <mat-form-field appearance="fill"
                                                                    class="u-w--100 formFieldNoMarginPadding filter-select u-mr--10"
                                                                    fxFlex="30%">
                                                                    <input
                                                                        [required]="consultant.value?.pdcPaymentEntityId !== contractClientForm.value?.pdcInvoicingEntityId"
                                                                        matInput type="number" placeholder="Rate"
                                                                        formControlName="proDataRateValue">
                                                                </mat-form-field>
                                                                <mat-form-field appearance="fill"
                                                                    class="u-w--100 formFieldNoMarginPadding filter-select"
                                                                    fxFlex="50%">
                                                                    <mat-select
                                                                        [required]="consultant.value?.pdcPaymentEntityId !== contractClientForm.value?.pdcInvoicingEntityId"
                                                                        formControlName="proDataRateCurrency"
                                                                        placeholder="Currency"
                                                                        [disableOptionCentering]="true"
                                                                        [compareWith]="compareWithFn">
                                                                        <ng-container
                                                                            *ngFor="let item of currencies; trackBy: trackById">
                                                                            <mat-option [value]="item">
                                                                                {{ item?.name }}
                                                                            </mat-option>
                                                                        </ng-container>
                                                                    </mat-select>
                                                                </mat-form-field>
                                                            </div>
                                                        </ng-container>
                                                        <ng-template #consultantFeeProDataRateDisplay>
                                                            <span fxFlex="25%"
                                                                class="u-w--100 text-truncate-ellipsis workflow-contracts--list-item"
                                                                [matTooltip]="fee.value.proDataRateValue !== null && fee.value.proDataRateCurrency?.name ? fee.value.proDataRateValue + ' ' + fee.value.proDataRateCurrency?.name : '-'"
                                                                matTooltipClass="white-tooltip" appShowIfTruncated>
                                                                {{fee.value.proDataRateValue !== null &&
                                                                fee.value.proDataRateCurrency?.name ?
                                                                fee.value.proDataRateValue + ' ' +
                                                                fee.value.proDataRateCurrency?.name : '-'}}
                                                            </span>
                                                        </ng-template>
                                                    </ng-container>
                                                    <ng-container
                                                        *ngIf="fee.value.editable; else consultantFeeRateDisplay">
                                                        <div fxFlex="25%" fxLayout="row" fxLayoutAlign="start start">
                                                            <mat-form-field appearance="fill"
                                                                class="u-w--100 formFieldNoMarginPadding filter-select u-mr--10"
                                                                fxFlex="30%">
                                                                <input required matInput type="number"
                                                                    placeholder="Rate"
                                                                    formControlName="consultantRateValue">
                                                            </mat-form-field>
                                                            <mat-form-field appearance="fill"
                                                                class="u-w--100 formFieldNoMarginPadding filter-select"
                                                                fxFlex="50%">
                                                                <mat-select required
                                                                    formControlName="consultantRateCurrency"
                                                                    placeholder="Currency"
                                                                    [disableOptionCentering]="true"
                                                                    [compareWith]="compareWithFn">
                                                                    <ng-container
                                                                        *ngFor="let item of currencies; trackBy: trackById">
                                                                        <mat-option [value]="item">
                                                                            {{ item?.name }}
                                                                        </mat-option>
                                                                    </ng-container>
                                                                </mat-select>
                                                            </mat-form-field>
                                                        </div>
                                                    </ng-container>
                                                    <ng-template #consultantFeeRateDisplay>
                                                        <span fxFlex="25%"
                                                            class="u-w--100 text-truncate-ellipsis workflow-contracts--list-item"
                                                            [matTooltip]="fee.value.consultantRateValue !== null && fee.value.consultantRateCurrency?.name ? fee.value.consultantRateValue + ' ' + fee.value.consultantRateCurrency?.name : '-'"
                                                            matTooltipClass="white-tooltip" appShowIfTruncated>
                                                            {{fee.value.consultantRateValue !== null &&
                                                            fee.value.consultantRateCurrency?.name ?
                                                            fee.value.consultantRateValue + ' ' +
                                                            fee.value.consultantRateCurrency?.name : '-'}}
                                                        </span>
                                                    </ng-template>

                                                    <ng-container *ngIf="fee.value.editable; else consultantFeeActions">
                                                        <div fxFlex="10%" class="u-w--100 text-truncate-ellipsis"
                                                            fxLayoutAlign="end center">
                                                            <button mat-icon-button type="button"
                                                                [disabled]="!fee.valid" appPreventDoubleClick
                                                                (throttledClick)="editOrSaveConsultantSpecialFee(fee.value.editable, consultantIndex, clientFeeIndex)"
                                                                class="rates-and-fees--inline-edit-form--btn__save">
                                                                <mat-icon svgIcon="rates-save-icon"></mat-icon>
                                                            </button>
                                                            <button mat-icon-button type="button" appPreventDoubleClick
                                                                (throttledClick)="cancelEditConsultantFee(consultantIndex, clientFeeIndex)"
                                                                class="rates-and-fees--inline-edit-form--btn__cancel">
                                                                <mat-icon svgIcon="rates-cancel-icon"></mat-icon>
                                                            </button>
                                                        </div>
                                                    </ng-container>
                                                    <ng-template #consultantFeeActions>
                                                        <div fxFlex="10%" fxLayoutAlign="end center"
                                                            class="u-w--100 workflow-contracts--list-item">
                                                            <button mat-icon-button appPreventDoubleClick
                                                                (throttledClick)="$event.stopPropagation();"
                                                                [matMenuTriggerFor]="clientFeeMenu"
                                                                class="three-dots-actions-btn">
                                                                <mat-icon svgIcon="3-dots"></mat-icon>
                                                            </button>
                                                            <mat-menu #clientFeeMenu>
                                                                <button class="menu-item green-color" mat-menu-item
                                                                    [disabled]="isConsultantFeeEditing"
                                                                    appPreventDoubleClick
                                                                    (throttledClick)="editOrSaveConsultantSpecialFee(fee.value.editable, consultantIndex, clientFeeIndex)">
                                                                    <mat-icon svgIcon="edit-icon-green"></mat-icon>
                                                                    Edit
                                                                </button>
                                                                <button class="menu-item menu-item--cancel"
                                                                    mat-menu-item appPreventDoubleClick
                                                                    (throttledClick)="removeConsultantDataClientFees(consultantIndex, clientFeeIndex)">
                                                                    <mat-icon svgIcon="close-icon"></mat-icon>
                                                                    Delete
                                                                </button>
                                                            </mat-menu>
                                                        </div>
                                                    </ng-template>
                                                </div>
                                            </ng-container>
                                        </ng-container>
                                    </div>
                                    <div fxLayout="row" fxLayoutAlign="start start" class="u-mb--10">
                                        <button class="rates-and-fees--btn button-add" mat-flat-button
                                            [matMenuTriggerFor]="consultantSpecialFeeMenu"
                                            [disabled]="isConsultantFeeEditing"
                                            #consultantFeeMenuTrigger="matMenuTrigger"
                                            (menuOpened)="contractsConsultantsDataForm.consultants.at(consultantIndex).get('consultantSpecialFeeFilter')!.setValue(''); consultantSpecialFeeSelect.open();">
                                            <mat-icon>add</mat-icon>
                                            Add special fees
                                        </button>
                                        <mat-menu #consultantSpecialFeeMenu backdropClass="add-rates-button--menu">
                                            <div mat-menu-item appPreventDoubleClick
                                                (throttledClick)="$event.stopPropagation()" class="u-pg--0">
                                                <mat-form-field appearance="fill"
                                                    class="add-rates-button--dropdown filter-select u-w--100">
                                                    <mat-label>Choose special fee</mat-label>
                                                    <mat-select #consultantSpecialFeeSelect
                                                        formControlName="consultantSpecialFeeFilter"
                                                        [disableOptionCentering]="true">
                                                        <ng-container *ngFor="let item of clientSpecialFeeList | excludeIds: consultant.value.clientFees : 'clientSpecialFeeId'; trackBy: trackById">
                                                            <mat-option [disabled]="item.id === null" [value]="item.id" appPreventDoubleClick (throttledClick)="item.id !== null ? selectConsultantSpecialFee(consultantIndex, item, consultantFeeMenuTrigger) : ''">
                                                                {{ item.internalName }}
                                                            </mat-option>
                                                        </ng-container>
                                                    </mat-select>
                                                </mat-form-field>
                                            </div>
                                        </mat-menu>
                                    </div>
                                </ng-template>
                            </div>
                        </div>
                        <div fxLayout="column" fxLayoutAlign="start start" class="u-w--100" id="contractConsultantProjectLines">
                            <div fxLayout="row" fxLayoutAlign="start center" class="u-mt--16 u-mb--16">
                                <span class="workflow-section--number">7</span>
                                <h2 class="workflow-section--header">Project lines</h2>
                            </div>
                            <div class="workflow-section--content">
                                <div class="inline-edit-form u-w--100" [ngClass]="{'u-mb--10': readOnlyMode}">
                                    <ng-container *ngIf="consultant.value.projectLines?.length">
                                        <div fxLayout="row" fxLayoutAlign="space-between start" fxLayoutGap="10px"
                                            class="u-w--100 u-pl--50 u-pr--16 u-pb--10">
                                            <span fxFlex="5%"
                                                class="workflow-contracts--list-header text-truncate-ellipsis">
                                                Id
                                            </span>
                                            <span fxFlex="25%"
                                                class="workflow-contracts--list-header text-truncate-ellipsis">
                                                Project name
                                            </span>
                                            <span fxFlex="25%"
                                                class="workflow-contracts--list-header text-truncate-ellipsis">
                                                Assignment ID/PO No
                                            </span>
                                            <span fxFlex="10%"
                                                class="workflow-contracts--list-header text-truncate-ellipsis">
                                                Start date
                                            </span>
                                            <span fxFlex="10%"
                                                class="workflow-contracts--list-header text-truncate-ellipsis">
                                                End date
                                            </span>
                                            <span fxFlex="1 0 15%"
                                                class="workflow-contracts--list-header text-truncate-ellipsis">
                                                Optional Invoicing Info
                                            </span>
                                            <span fxFlex="5%"
                                                class="workflow-contracts--list-header text-truncate-ellipsis">
                                                Fees
                                            </span>
                                            <ng-container *ngIf="!readOnlyMode">
                                                <span fxFlex="5%"></span>
                                            </ng-container>
                                        </div>
                                    </ng-container>
                                    <ng-container class="u-w--100" formArrayName="projectLines">
                                        <mat-accordion [multi]="true" class="project-line--expansion mat-elevation-z0"
                                            togglePosition="before">
                                            <ng-container
                                                *ngFor="let projectLine of getConsultantProjectLinesControls(consultantIndex); let projectLinesIndex = index"
                                                [formGroupName]="projectLinesIndex">
                                                <mat-expansion-panel class="mat-elevation-z0">
                                                    <mat-expansion-panel-header>
                                                        <div fxLayout="row" fxLayoutAlign="space-between center"
                                                            fxLayoutGap="10px" class="u-w--100">
                                                            <span fxFlex="5%"
                                                                class="u-w--100 text-truncate-ellipsis workflow-contracts--list-item"
                                                                [matTooltip]="projectLine.value.id ?? '-'"
                                                                matTooltipClass="white-tooltip" appShowIfTruncated>
                                                                {{projectLine.value.id ?? '-'}}
                                                            </span>
                                                            <span fxFlex="25%"
                                                                class="u-w--100 text-truncate-ellipsis workflow-contracts--list-item"
                                                                [matTooltip]="projectLine.value.projectName ?? '-'"
                                                                matTooltipClass="white-tooltip" appShowIfTruncated>
                                                                {{projectLine.value.projectName &&
                                                                projectLine.value.projectName !== '' ?
                                                                projectLine.value.projectName : '-'}}
                                                            </span>
                                                            <span fxFlex="25%"
                                                                class="u-w--100 text-truncate-ellipsis workflow-contracts--list-item"
                                                                [matTooltip]="projectLine.value.invoicingReferenceNumber ?? '-'"
                                                                matTooltipClass="white-tooltip" appShowIfTruncated>
                                                                {{projectLine.value.invoicingReferenceNumber &&
                                                                projectLine.value.invoicingReferenceNumber !== '' ?
                                                                projectLine.value.invoicingReferenceNumber : '-'}}
                                                            </span>
                                                            <span fxFlex="10%"
                                                                class="u-w--100 text-truncate-ellipsis workflow-contracts--list-item"
                                                                [matTooltip]="projectLine.value.startDate ? (projectLine.value.startDate | momentFormat) : '-'"
                                                                matTooltipClass="white-tooltip" appShowIfTruncated>
                                                                {{projectLine.value.startDate ?
                                                                (projectLine.value.startDate | momentFormat) : '-'}}
                                                            </span>
                                                            <span fxFlex="10%"
                                                                class="u-w--100 text-truncate-ellipsis workflow-contracts--list-item"
                                                                [matTooltip]="projectLine.value.endDate ? (projectLine.value.endDate | momentFormat) : '-'"
                                                                matTooltipClass="white-tooltip" appShowIfTruncated>
                                                                {{projectLine.value.endDate ? (projectLine.value.endDate
                                                                | momentFormat) : '-'}}
                                                            </span>
                                                            <span fxFlex="1 0 15%"
                                                                class="u-w--100 text-truncate-ellipsis workflow-contracts--list-item"
                                                                [matTooltip]="projectLine.value.optionalInvoicingInfo ?? '-'"
                                                                matTooltipClass="white-tooltip" appShowIfTruncated>
                                                                {{projectLine.value.optionalInvoicingInfo &&
                                                                projectLine.value.optionalInvoicingInfo !== '' ?
                                                                projectLine.value.optionalInvoicingInfo : '-'}}
                                                            </span>
                                                            <span fxFlex="5%"
                                                                class="u-w--100 text-truncate-ellipsis workflow-contracts--list-item">
                                                                <ng-container
                                                                    *ngIf="projectLine.value.isLineForFees; else noFeesBilledTemplate">
                                                                    <div fxLayout="row" fxLayoutAlign="start center"
                                                                        [matTooltip]="projectLine.value.isLineForFees ? 'Fees billed with this Project line' : '-'"
                                                                        matTooltipClass="white-tooltip">
                                                                        <mat-icon
                                                                            svgIcon="check-circle-fill"></mat-icon>
                                                                    </div>
                                                                </ng-container>
                                                                <ng-template #noFeesBilledTemplate>
                                                                    -
                                                                </ng-template>
                                                            </span>
                                                            <ng-container *ngIf="!readOnlyMode">
                                                                <div fxFlex="5%" fxLayoutAlign="end center"
                                                                    class="u-w--100 workflow-contracts--list-item">
                                                                    <button mat-icon-button appPreventDoubleClick
                                                                        (throttledClick)="$event.stopPropagation();"
                                                                        #projectLinesMenuTrigger="matMenuTrigger"
                                                                        [matMenuTriggerFor]="consultantProjectLineMenu"
                                                                        class="three-dots-actions-btn">
                                                                        <mat-icon svgIcon="3-dots"></mat-icon>
                                                                    </button>
                                                                    <mat-menu #consultantProjectLineMenu>
                                                                        <button class="menu-item green-color"
                                                                            mat-menu-item
                                                                            (click)="duplicateProjectLine(consultantIndex, projectLinesIndex)">
                                                                            <mat-icon
                                                                                svgIcon="duplicate-icon-green"></mat-icon>
                                                                            Duplicate
                                                                        </button>
                                                                        <button class="menu-item green-color"
                                                                            mat-menu-item
                                                                            (click)="createOrEditProjectLine(consultantIndex, projectLinesMenuTrigger, projectLinesIndex)">
                                                                            <mat-icon
                                                                                svgIcon="edit-icon-green"></mat-icon>
                                                                            Edit
                                                                        </button>
                                                                        <ng-container
                                                                            *ngIf="!projectLine.value.wasSynced">
                                                                            <button class="menu-item menu-item--cancel"
                                                                                mat-menu-item
                                                                                (click)="removeConsultantDataProjectLines(consultantIndex, projectLinesIndex)">
                                                                                <mat-icon
                                                                                    svgIcon="close-icon"></mat-icon>
                                                                                Delete
                                                                            </button>
                                                                        </ng-container>
                                                                        <ng-container
                                                                            *ngIf="projectLine.value.wasSynced">
                                                                            <div class="menu-item" mat-menu-item
                                                                                (click)="$event.stopPropagation(); toggleMarkProjectLineForDeletion(projectLine.value.markedForLegacyDeletion, consultantIndex, projectLinesIndex)">
                                                                                <mat-checkbox color="accent"
                                                                                    class="black-checkbox"
                                                                                    id="markedForLegacyDeletion"
                                                                                    name="markedForLegacyDeletion"
                                                                                    formControlName="markedForLegacyDeletion"
                                                                                    (click)="$event.stopPropagation();">
                                                                                    Mark for deletion in legacy
                                                                                </mat-checkbox>
                                                                            </div>
                                                                        </ng-container>
                                                                    </mat-menu>
                                                                </div>
                                                            </ng-container>
                                                        </div>
                                                    </mat-expansion-panel-header>
                                                    <div fxLayout="row" class="project-line--expansion-additional">
                                                        <span fxFlex="15%"
                                                            class="project-line--expansion-additional__header">Project
                                                            name</span>
                                                        <span class="project-line--expansion-additional__content">
                                                            {{projectLine.value.projectName &&
                                                            projectLine.value.projectName !== '' ?
                                                            projectLine.value.projectName : '-'}}
                                                        </span>
                                                    </div>
                                                    <div fxLayout="row" class="project-line--expansion-additional">
                                                        <span fxFlex="15%"
                                                            class="project-line--expansion-additional__header">Invoicing
                                                            ref person</span>
                                                        <span class="project-line--expansion-additional__content">
                                                            <ng-container
                                                                *ngIf="projectLine.value.invoicingReferencePerson?.id && projectLine.value.invoicingReferencePerson !== ''; else invoicingReferencePersonFreeText">
                                                                {{projectLine.value.invoicingReferencePerson?.firstName
                                                                ? (projectLine.value.invoicingReferencePerson?.firstName
                                                                + ' ' +
                                                                projectLine.value.invoicingReferencePerson?.lastName) :
                                                                '-'}}
                                                            </ng-container>
                                                            <ng-template #invoicingReferencePersonFreeText>
                                                                {{projectLine.value.invoicingReferencePerson &&
                                                                projectLine.value.invoicingReferencePerson !== '' ?
                                                                projectLine.value.invoicingReferencePerson : '-'}}
                                                            </ng-template>
                                                        </span>
                                                    </div>
                                                    <div fxLayout="row" class="project-line--expansion-additional">
                                                        <span fxFlex="15%"
                                                            class="project-line--expansion-additional__header">Debitor
                                                            number</span>
                                                        <span class="project-line--expansion-additional__content">
                                                            {{projectLine.value.debtorNumber &&
                                                            projectLine.value.debtorNumber !== '' ?
                                                            projectLine.value.debtorNumber : '-'}}
                                                        </span>
                                                    </div>
                                                    <div fxLayout="row" class="project-line--expansion-additional">
                                                        <span fxFlex="15%"
                                                            class="project-line--expansion-additional__header">Invoice
                                                            recipient</span>
                                                        <div fxLayout="column"
                                                            class="project-line--expansion-additional__content">
                                                            <ng-container
                                                                *ngIf="projectLine.value.invoiceRecipient !== null && projectLine.value.invoiceRecipient !== ''; else noInvoiceRecipientTemplate">
                                                                <span
                                                                    class="text-bold">{{projectLine.value.invoiceRecipient?.clientName}}</span>
                                                                <span>
                                                                    {{projectLine.value.invoiceRecipient?.countryName ?
                                                                    projectLine.value.invoiceRecipient?.countryName + '|' : ''}}
                                                                    {{projectLine.value.invoiceRecipient?.city ?
                                                                    projectLine.value.invoiceRecipient?.city + ' | ' : ''}}
                                                                    {{projectLine.value.invoiceRecipient?.address ?
                                                                    projectLine.value.invoiceRecipient?.address + ' | ' : ''}}
                                                                    {{projectLine.value.invoiceRecipient?.address2 ?
                                                                    projectLine.value.invoiceRecipient?.address2 + ' | ' : ''}}
                                                                    {{projectLine.value.invoiceRecipient?.postCode}}
                                                                </span>
                                                            </ng-container>
                                                        </div>
                                                        <ng-template #noInvoiceRecipientTemplate>
                                                            -
                                                        </ng-template>
                                                    </div>
                                                    <div fxLayout="row" class="project-line--expansion-additional">
                                                        <span fxFlex="15%"
                                                            class="project-line--expansion-additional__header">Insurance</span>
                                                        <span class="project-line--expansion-additional__content">
                                                            {{projectLine.value.consultantInsuranceOptionId ?
                                                            consultantInsuranceOptions[projectLine.value.consultantInsuranceOptionId]
                                                            : '-'}}
                                                        </span>
                                                    </div>
                                                    <div fxLayout="row" class="project-line--expansion-additional">
                                                        <span fxFlex="15%"
                                                            class="project-line--expansion-additional__header">Fees</span>
                                                        <span class="project-line--expansion-additional__content">
                                                            <ng-container
                                                                *ngIf="projectLine.value.isLineForFees; else noFeesBilledTemplate">
                                                                <div fxLayout="row" fxLayoutAlign="start center">
                                                                    <mat-icon svgIcon="check-circle-fill"
                                                                        class="project-line--expansion-additional--fees-icon u-mr--10"></mat-icon>
                                                                    Billed with this Project line
                                                                </div>
                                                            </ng-container>
                                                            <ng-template #noFeesBilledTemplate>
                                                                -
                                                            </ng-template>
                                                        </span>
                                                    </div>
                                                    <div fxLayout="row" class="project-line--expansion-additional">
                                                        <span fxFlex="15%"
                                                            class="project-line--expansion-additional__header">Changed</span>
                                                        <span class="project-line--expansion-additional__content">
                                                            {{projectLine.value.modificationDate ?
                                                            (projectLine.value.modificationDate | momentFormat) : '-'}}
                                                        </span>
                                                    </div>
                                                    <div fxLayout="row" class="project-line--expansion-additional">
                                                        <span fxFlex="15%"
                                                            class="project-line--expansion-additional__header">Status</span>
                                                        <span class="project-line--expansion-additional__content">
                                                            {{projectLine.value.markedForLegacyDeletion ? 'Delete from sync' : projectLine.value.wasSynced ? 'Synced' : 'Not synced'}}
                                                        </span>
                                                    </div>
                                                    <div fxLayout="row" class="project-line--expansion-additional">
                                                        <span fxFlex="15%"
                                                            class="project-line--expansion-additional__header">Optional
                                                            info</span>
                                                        <span class="project-line--expansion-additional__content">
                                                            {{projectLine.value.optionalInvoicingInfo &&
                                                            projectLine.value.optionalInvoicingInfo !== '' ?
                                                            projectLine.value.optionalInvoicingInfo : '-'}}
                                                        </span>
                                                    </div>
                                                </mat-expansion-panel>
                                            </ng-container>
                                        </mat-accordion>
                                    </ng-container>
                                    <ng-container *ngIf="consultant.value.projectLines?.length === 0 && readOnlyMode">
                                        <div fxLayout="row" fxLayoutAlign="space-between center" fxLayoutGap="10px"
                                            class="emptyStateRow u-pl--16 u-pr--16">
                                            <span class="light-grey-color text-600">
                                                No project lines
                                            </span>
                                        </div>
                                    </ng-container>
                                </div>
                                <ng-container *ngIf="!readOnlyMode">
                                    <div fxLayout="row" fxLayoutAlign="start start">
                                        <button class="rates-and-fees--btn button-add" mat-flat-button
                                            appPreventDoubleClick
                                            (throttledClick)="createOrEditProjectLine(consultantIndex)">
                                            <mat-icon>add</mat-icon>
                                            Add project line
                                        </button>
                                    </div>
                                </ng-container>
                            </div>
                        </div>
                    </ng-container>
                </div>
            </div>
        </ng-container>
    </ng-container>
</form>
