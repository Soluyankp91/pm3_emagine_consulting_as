<form [formGroup]="salesMainDataForm" id="mainData" class="workflow-form workflow-form--main u-w--100">
    <ng-container
        *ngIf="(activeSideSection.typeId === workflowSideSections.StartConsultantPeriod || activeSideSection.typeId === workflowSideSections.ChangeConsultantPeriod || activeSideSection.typeId === workflowSideSections.ExtendConsultantPeriod); else startPeriodTemplate">
        <div fxLayout="column" fxLayoutAlign="start start" class="workflow-sales--process-data u-w--100"
            id="salesMainDataAnchor">
            <div fxLayout="row" fxLayoutAlign="space-between center" class="u-w--100">
                <h1 class="workflow-section--header-main">Main data</h1>
                <ng-container *ngIf="readOnlyMode && !isWFDeleted">
                    <toggle-edit-mode [canToggleEditMode]="canToggleEditMode" [canReopen]="permissionsForCurrentUser!['Reopen']" [showReturnToSales]="true" (editModeToggled)="toggleEditMode()" (onReturnToSales)="returnToSales()"></toggle-edit-mode>
                </ng-container>
            </div>
            <div fxLayout="column" fxLayoutAlign="start start" class="u-w--100 u-mb--10  u-mt--10">
                <mat-form-field appearance="outline" class="textarea-input formFieldNoMarginPadding  form-width-564"
                    [ngClass]="{'disabled-input': readOnlyMode}">
                    <mat-label>Remarks</mat-label>
                    <textarea required matInput autocomplete="new-password" name="remarks" formControlName="remarks"
                        [cdkTextareaAutosize]="true" [cdkAutosizeMinRows]="2" [disabled]="readOnlyMode">
                    </textarea>
                    <mat-error>
                        <app-validator [control]="salesMainDataForm.remarks"></app-validator>
                    </mat-error>
                </mat-form-field>
            </div>
            <div fxLayout="row" fxLayoutAlign="start start" class="u-w--100 u-mb--20"
                [fxHide]="readOnlyMode && !salesMainDataForm.noRemarks?.value">
                <mat-checkbox color="accent" [disabled]="readOnlyMode" formControlName="noRemarks" name="noRemarks"
                    class="black-checkbox u-mt--5"
                    (change)="disableOrEnableInput(salesMainDataForm.noRemarks?.value, salesMainDataForm.remarks)">
                    None
                </mat-checkbox>
            </div>
        </div>
    </ng-container>
    <ng-template #startPeriodTemplate>
        <div fxLayout="column" fxLayoutAlign="start start" class="workflow-sales--process-data u-w--100"
            id="salesMainDataAnchor">
            <div fxLayout="column" fxLayoutAlign="start start" class="u-w--100">
                <div fxLayout="row" fxLayoutAlign="space-between center" class="u-w--100">
                    <h1 class="workflow-section--header-main">Main data</h1>
                    <ng-container *ngIf="readOnlyMode && !isWFDeleted">
                        <toggle-edit-mode [canToggleEditMode]="canToggleEditMode" [canReopen]="permissionsForCurrentUser!['Reopen']" [showReturnToSales]="true" (editModeToggled)="toggleEditMode()" (onReturnToSales)="returnToSales()"></toggle-edit-mode>
                    </ng-container>
                </div>
                <div fxLayout="row" fxLayoutAlign="start center" class="u-mt--16 u-mb--16" id="salesMainProject">
                    <span class="workflow-section--number">1</span>
                    <h2 class="workflow-section--header">Project</h2>
                </div>
                <div class="workflow-section--content">
                    <ng-container *ngIf="activeSideSection.typeId === workflowSideSections.StartClientPeriod || activeSideSection.typeId === workflowSideSections.ExtendClientPeriod || activeSideSection.typeId === workflowSideSections.ChangeClientPeriod">
                        <div fxLayout="row" fxLayoutAlign="start start" class="u-w--100">
                            <mat-form-field appearance="outline" class="formFieldNoMarginPadding filter-select form-width-372">
                                <mat-label>Project Type (Legacy)</mat-label>
                                <mat-select required [disabled]="readOnlyMode" formControlName="projectTypeId" [disableOptionCentering]="true" (selectionChange)="getDataBasedOnProjectType($event)">
                                    <ng-container *ngFor="let item of projectTypes; trackBy: trackById">
                                        <mat-option [value]="item.id">
                                            {{ item.name }}
                                        </mat-option>
                                    </ng-container>
                                </mat-select>
                                <mat-error>
                                    <app-validator [control]="salesMainDataForm.projectTypeId"></app-validator>
                                </mat-error>
                            </mat-form-field>
                        </div>
                        <div fxLayout="column" fxLayoutAlign="start start">
                            <h3 class="workflow-gray--header u-mt--15 u-mb--10">Sales type</h3>
                            <mat-button-toggle-group [disabled]="readOnlyMode"
                                [ngClass]="{'mat-form-field-invalid': !salesMainDataForm.salesTypeId?.valid}" class="workflow-toggle-buttons"
                                formControlName="salesTypeId" required (change)="salesTypeChange($event.value)">
                                <ng-container *ngFor="let item of saleTypes; trackBy: trackById">
                                    <ng-container *ngIf="(readOnlyMode && item.id === salesMainDataForm.salesTypeId?.value) || !readOnlyMode">
                                        <mat-button-toggle [value]="item.id">{{item.name}}</mat-button-toggle>
                                    </ng-container>
                                </ng-container>
                            </mat-button-toggle-group>
                            <mat-error>
                                <app-validator [withoutFormField]="true" *ngIf="salesMainDataForm.salesTypeId?.touched"
                                    [control]="salesMainDataForm.salesTypeId"></app-validator>
                            </mat-error>
                        </div>
                        <div fxLayout="column" fxLayoutAlign="start start">
                            <h3 class="workflow-gray--header u-mt--20 u-mb--10">Delivery type</h3>
                            <mat-button-toggle-group [disabled]="readOnlyMode"
                                [ngClass]="{'mat-form-field-invalid': !salesMainDataForm.deliveryTypeId?.valid}" class="workflow-toggle-buttons"
                                formControlName="deliveryTypeId" required>
                                <ng-container *ngFor="let item of deliveryTypes; trackBy: trackById">
                                    <ng-container *ngIf="(item?.id === deliveryTypesEnum.ManagedService && salesMainDataForm.salesTypeId?.value === salesTypesEnum.ManagedService) || (item?.id !== deliveryTypesEnum.ManagedService && salesMainDataForm.salesTypeId?.value !== salesTypesEnum.ManagedService)">
                                        <ng-container *ngIf="(readOnlyMode && item.id === salesMainDataForm.deliveryTypeId?.value) || !readOnlyMode">
                                            <mat-button-toggle [value]="item.id">
                                                {{ item.name }}
                                            </mat-button-toggle>
                                        </ng-container>
                                    </ng-container>
                                </ng-container>
                            </mat-button-toggle-group>
                            <mat-error>
                                <ng-container *ngIf="salesMainDataForm.deliveryTypeId?.touched">
                                    <app-validator [withoutFormField]="true" [control]="salesMainDataForm.deliveryTypeId"></app-validator>
                                </ng-container>
                            </mat-error>
                        </div>
                        <div fxLayout="row" fxLayoutAlign="start start" class="u-w--100">
                            <mat-form-field appearance="outline" class="formFieldNoMarginPadding filter-select form-width-180 u-mt--15">
                                <mat-label>Margin</mat-label>
                                <mat-select [disabled]="readOnlyMode" formControlName="marginId" [disableOptionCentering]="true" required>
                                    <mat-option class="mat-select-clear-option">
                                        Clear
                                    </mat-option>
                                    <ng-container *ngFor="let item of margins; trackBy: trackById">
                                        <mat-option [value]="item.id">
                                            {{ item.name }}
                                        </mat-option>
                                    </ng-container>
                                </mat-select>
                                <mat-error>
                                    <app-validator [control]="salesMainDataForm.marginId"></app-validator>
                                </mat-error>
                            </mat-form-field>
                        </div>
                        <div fxLayout="column" fxLayoutAlign="start start" class="u-w--100 u-mt--15">
                            <h3 class="workflow-gray--header u-mb--5">Project category</h3>
                            <div fxLayout="row" fxLayoutAlign="start start" class="u-w--100">
                                <mat-form-field appearance="outline" class="formFieldNoMarginPadding filter-select u-mr--12 form-width-274">
                                    <mat-label>Area</mat-label>
                                    <mat-select [disabled]="readOnlyMode" formControlName="primaryCategoryArea" [disableOptionCentering]="true" [compareWith]="compareWithFn">
                                        <ng-container *ngFor="let item of primaryCategoryAreas; trackBy: trackById">
                                            <mat-option [value]="item">
                                                {{ item.name }}
                                            </mat-option>
                                        </ng-container>
                                    </mat-select>
                                    <mat-error>
                                        <app-validator [control]="salesMainDataForm.primaryCategoryArea"></app-validator>
                                    </mat-error>
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="formFieldNoMarginPadding filter-select u-mr--12 form-width-274">
                                    <mat-label>Type</mat-label>
                                    <mat-select [disabled]="readOnlyMode" formControlName="primaryCategoryType" [disableOptionCentering]="true" [compareWith]="compareWithFn">
                                        <ng-container *ngFor="let item of primaryCategoryTypes; trackBy: trackById">
                                            <mat-option [value]="item">
                                                {{ item.name }}
                                            </mat-option>
                                        </ng-container>
                                    </mat-select>
                                    <mat-error>
                                        <app-validator [control]="salesMainDataForm.primaryCategoryType"></app-validator>
                                    </mat-error>
                                </mat-form-field>
                            </div>
                            <div fxLayout="row" fxLayoutAlign="start start" class="u-w--100">
                                <mat-form-field appearance="outline" class="formFieldNoMarginPadding filter-select form-width-560">
                                    <mat-label>Role</mat-label>
                                    <mat-select [disabled]="readOnlyMode" formControlName="primaryCategoryRole" [disableOptionCentering]="true"
                                        [compareWith]="compareWithFn">
                                        <ng-container *ngFor="let item of primaryCategoryRoles; trackBy: trackById">
                                            <mat-option [value]="item">
                                                {{ item.name }}
                                            </mat-option>
                                        </ng-container>
                                    </mat-select>
                                    <mat-error>
                                        <app-validator [control]="salesMainDataForm.primaryCategoryRole"></app-validator>
                                    </mat-error>
                                </mat-form-field>
                            </div>
                            <div fxLayout="row" fxLayoutAlign="end center" class="form-width-560 u-mb--5">
                                <button mat-flat-button class="category-cheatsheet--btn" appPreventDoubleClick (throttledClick)="openCategoryCheatSheet()">
                                    <mat-icon svgIcon="info-icon-purple"></mat-icon>
                                    Category cheatsheet
                                </button>
                            </div>
                        </div>
                    </ng-container>

                    <div fxLayout="row" fxLayoutAlign="start start" class="u-w--100">
                        <mat-form-field appearance="outline"
                            class="formFieldNoMarginPadding textarea-input form-width-564"
                            [ngClass]="{'disabled-input': readOnlyMode}">
                            <mat-label>Project Name</mat-label>
                            <textarea matInput [disabled]="readOnlyMode" autocomplete="new-password" name="projectName"
                                required formControlName="projectName" [cdkTextareaAutosize]="true"
                                [cdkAutosizeMinRows]="1">
                            </textarea>
                            <mat-error>
                                <app-validator [control]="salesMainDataForm.projectName"></app-validator>
                            </mat-error>
                        </mat-form-field>
                    </div>

                    <div fxLayout="row" fxLayoutAlign="start start" class="u-w--100">
                        <mat-form-field appearance="outline"
                            class="formFieldNoMarginPadding textarea-input form-width-564"
                            [ngClass]="{'disabled-input': readOnlyMode}">
                            <mat-label>Project Description</mat-label>
                            <textarea matInput [disabled]="readOnlyMode" autocomplete="new-password"
                                name="projectDescription" required formControlName="projectDescription"
                                [cdkTextareaAutosize]="true" [cdkAutosizeMinRows]="2" [cdkAutosizeMaxRows]="15">
                            </textarea>
                            <mat-error>
                                <app-validator [control]="salesMainDataForm.projectDescription"></app-validator>
                            </mat-error>
                        </mat-form-field>
                    </div>
                </div>
            </div>
            <div fxLayout="column" fxLayoutAlign="start start" class="u-w--100" id="salesMainInvoicing">
                <div fxLayout="row" fxLayoutAlign="start start" class="u-mt--16 u-mb--16">
                    <span class="workflow-section--number">2</span>
                    <h2 class="workflow-section--header">Invoicing</h2>
                </div>
                <div class="workflow-section--content">
                    <div fxLayout="column" fxLayoutAlign="start start">
                        <h3 class="workflow-gray--header u-mb--10">Discounts</h3>
                        <mat-button-toggle-group [disabled]="readOnlyMode"
                            [ngClass]="{'mat-form-field-invalid': !salesMainDataForm.discountId?.valid}" class="workflow-toggle-buttons"
                            formControlName="discountId" required>
                            <ng-container *ngFor="let item of discounts; trackBy: trackById">
                                <ng-container *ngIf="(readOnlyMode && item.id === salesMainDataForm.discountId?.value) || !readOnlyMode">
                                    <mat-button-toggle [value]="item.id">
                                        {{ item.name }}
                                    </mat-button-toggle>
                                </ng-container>
                            </ng-container>
                        </mat-button-toggle-group>
                        <mat-error>
                            <ng-container *ngIf="salesMainDataForm.discountId?.touched">
                                <app-validator [withoutFormField]="true" [control]="salesMainDataForm.discountId"></app-validator>
                            </ng-container>
                        </mat-error>
                    </div>
                    <div class="inline-edit-form u-w--100 u-mt--15">
                        <ng-container *ngIf="salesMainDataForm.commissions?.controls?.length">
                            <div fxLayout="row" fxLayoutAlign="space-between start" fxLayoutGap="10px"
                                class="workflow-sales-inline--form__header-container u-w--100">
                                <span fxFlex="10%" class="workflow-sales-inline--form__header u-w--100">
                                    Type
                                </span>
                                <span fxFlex="10%" class="workflow-sales-inline--form__header u-w--100">
                                    Value
                                </span>
                                <span fxFlex="10%" class="workflow-sales-inline--form__header u-w--100">
                                    Currency
                                </span>
                                <span fxFlex="10%" class="workflow-sales-inline--form__header u-w--100">
                                    Recipient type
                                </span>
                                <span fxFlex="1 0 30%" class="workflow-sales-inline--form__header u-w--100">
                                    Recipient
                                </span>
                                <span fxFlex="20%" class="workflow-sales-inline--form__header u-w--100">
                                    Frequency
                                </span>
                                <span fxFlex="10%" class="workflow-sales-inline--form__header u-w--100"
                                    [fxHide]="readOnlyMode">

                                </span>
                            </div>
                        </ng-container>
                        <ng-container formArrayName="commissions" class="u-w--100">
                            <ng-container *ngFor="let commission of salesMainDataForm.commissions.controls; trackBy: trackByItem; index as i; first as first"
                                [formArrayName]="i">
                                <div fxLayout="row" fxLayoutAlign="space-between center" fxLayoutGap="10px"
                                    class="workflow-sales-inline--form__row u-w--100" [ngClass]="{'u-bt--0': !first}">
                                    <ng-container *ngIf="salesMainDataForm.commissions.at(i).get('editable')?.value">
                                        <mat-form-field appearance="fill"
                                            class="u-w--100 formFieldNoMarginPadding filter-select" fxFlex="10%">
                                            <mat-select required formControlName="type" placeholder="Type"
                                                [disableOptionCentering]="true" [compareWith]="compareWithFn">
                                                <ng-container *ngFor="let item of commissionTypes; trackBy: trackById">
                                                    <mat-option [value]="item">
                                                        {{ item.name }}
                                                    </mat-option>
                                                </ng-container>
                                            </mat-select>
                                        </mat-form-field>
                                        <mat-form-field appearance="fill"
                                            class="u-w--100 formFieldNoMarginPadding filter-select" fxFlex="10%">
                                            <input required matInput type="number" formControlName="amount"
                                                placeholder="Value" />
                                        </mat-form-field>
                                        <mat-form-field appearance="fill"
                                            class="u-w--100 formFieldNoMarginPadding filter-select" fxFlex="10%">
                                            <mat-select required formControlName="currency" placeholder="Currency"
                                                [disableOptionCentering]="true" [compareWith]="compareWithFn">
                                                <ng-container *ngFor="let item of currencies; trackBy: trackById">
                                                    <mat-option [value]="item">
                                                        {{ item.name }}
                                                    </mat-option>
                                                </ng-container>
                                            </mat-select>
                                        </mat-form-field>
                                        <mat-form-field appearance="fill"
                                            class="u-w--100 formFieldNoMarginPadding filter-select" fxFlex="10%">
                                            <mat-select formControlName="recipientType" placeholder="Recipient type"
                                                [disableOptionCentering]="true"
                                                (selectionChange)="commissionRecipientTypeChanged(i)"
                                                [compareWith]="compareWithFn">
                                                <ng-container
                                                    *ngFor="let item of commissionRecipientTypes; trackBy: trackById">
                                                    <mat-option [value]="item">
                                                        {{ item.name }}
                                                    </mat-option>
                                                </ng-container>
                                            </mat-select>
                                        </mat-form-field>
                                        <!-- recipientType?.id === 4 - PDC entity -->
                                        <ng-container *ngIf="commission.value.recipientType?.id === 4; else commissionRecipientAutocomplete">
                                            <mat-form-field appearance="fill"
                                                class="u-w--100 formFieldNoMarginPadding filter-select" fxFlex="30%"
                                                [ngClass]="{'disabled-autocomplete': commission.value.recipientType === null || commission.value.recipientType === ''}">
                                                    <mat-select formControlName="recipient" placeholder="Recipient"
                                                        [disableOptionCentering]="true" [compareWith]="compareWithFn">
                                                        <ng-container
                                                            *ngFor="let item of legalEntities; trackBy: trackById">
                                                            <mat-option [value]="item">
                                                                <b>{{ item.tenantName + ' ' + '(' + item.name + ')' }}</b>
                                                            </mat-option>
                                                        </ng-container>
                                                    </mat-select>
                                            </mat-form-field>
                                        </ng-container>
                                        <ng-template #commissionRecipientAutocomplete>
                                            <mat-form-field appearance="fill"
                                                class="u-w--100 formFieldNoMarginPadding autocompleteWithShevron inline-autocomplete filter-select" fxFlex="30%"
                                                [ngClass]="{'disabled-autocomplete': commission.value.recipientType === null || commission.value.recipientType === ''}">
                                                <input #recipientFilterInput type="text" matInput
                                                    [matAutocomplete]="recipientAutocomplete"
                                                    formControlName="recipient" appPreventDoubleClick
                                                    (throttledClick)="$event.stopPropagation()" placeholder="Recipient">
                                                    <span [ngClass]="{'isPanelOpen': recipientAutocomplete.isOpen}" matSuffix class="shevron"></span>
                                                <mat-autocomplete #recipientAutocomplete="matAutocomplete"
                                                    [displayWith]="displayRecipientFn"
                                                    [panelWidth]="400"
                                                    (optionSelected)="focusToggleMethod('auto')" (opened)="focusToggleMethod('hidden')"
                                                    (closed)="focusToggleMethod('auto')">
                                                    <ng-container>
                                                        <ng-container
                                                            *ngFor="let recipient of filteredRecipients; trackBy: trackById">
                                                            <mat-option [value]="recipient"
                                                                [ngClass]="{ 'no-data': recipient.id === 'no-data' }">
                                                                <ng-container
                                                                    [ngSwitch]="commission.value.recipientType?.id">
                                                                    <!-- 'Client' -->
                                                                    <span *ngSwitchCase="3">
                                                                        <div class="multilineDropdown-option--column">
                                                                            <span
                                                                                class="multilineDropdown-option--column-client-name">{{
                                                                                recipient.clientName }}</span>
                                                                            <ng-container
                                                                                *ngIf="recipient.id !== 'no-data'">
                                                                                <span
                                                                                    class="multilineDropdown-option--column-client-info">
                                                                                    #{{recipient.clientId}} |
                                                                                    {{recipient.city ?? ''}}
                                                                                    {{recipient.countryName ? ', ' +
                                                                                    recipient.countryName : ''}}
                                                                                </span>
                                                                            </ng-container>
                                                                        </div>
                                                                    </span>
                                                                    <!-- 'Supplier' -->
                                                                    <span *ngSwitchCase="1">
                                                                        <span class="autocopmlete-option-name">{{
                                                                            recipient.supplierName }}</span>
                                                                    </span>
                                                                    <!-- 'Consultant' -->
                                                                    <span *ngSwitchCase="2">
                                                                        <div class="multilineDropdown-option--row">
                                                                            <ng-container
                                                                                *ngIf="recipient.id !== 'no-data'">
                                                                                <img class="image-settings u-mr--16"
                                                                                    [ngSrc]="consultantPhotoUrl + recipient.externalId! + '.jpg'" width="32" height="32" src (error)="setDefaultImage($event.target)" />
                                                                            </ng-container>
                                                                            <div
                                                                                class="multilineDropdown-option--column">
                                                                                <span
                                                                                    class="multilineDropdown-option--column-client-name">{{
                                                                                    recipient.name }}</span>
                                                                                <ng-container
                                                                                    *ngIf="recipient.id !== 'no-data'">
                                                                                    <span
                                                                                        class="multilineDropdown-option--column-client-info">
                                                                                        {{recipient.companyName}} |
                                                                                        {{recipient.city}} |
                                                                                        #{{recipient.id}} /
                                                                                        {{recipient.legacyId}}
                                                                                    </span>
                                                                                </ng-container>
                                                                            </div>
                                                                        </div>
                                                                    </span>
                                                                </ng-container>
                                                            </mat-option>
                                                        </ng-container>
                                                    </ng-container>
                                                </mat-autocomplete>
                                            </mat-form-field>
                                        </ng-template>
                                        <div fxFlex="20%">
                                            <mat-form-field appearance="fill"
                                                class="u-w--100 formFieldNoMarginPadding filter-select"
                                                fxFlex="1 0 40%">
                                                <mat-select formControlName="frequency" placeholder="Frequency"
                                                    [disableOptionCentering]="true" [compareWith]="compareWithFn">
                                                    <ng-container
                                                        *ngFor="let item of commissionFrequencies; trackBy: trackById">
                                                        <mat-option [value]="item">
                                                            {{ item.name }}
                                                        </mat-option>
                                                    </ng-container>
                                                </mat-select>
                                            </mat-form-field>
                                            <!--id = 2 == 'One time' -->
                                            <mat-form-field appearance="fill"
                                                class="u-w--100 formFieldNoMarginPadding filter-select formFieldDatePicker"
                                                fxFlex="0 0 60%" [fxHide]="commission.value.frequency?.id !== 2">
                                                <input autocomplete="off" matInput
                                                    [required]="commission.value.frequency?.id === 2"
                                                    [matDatepicker]="oneTimeDatePicker" placeholder="Date"
                                                    name="oneTimeDate" formControlName="oneTimeDate"
                                                    (focus)="oneTimeDatePicker.open()" appPreventDoubleClick
                                                    (throttledClick)="oneTimeDatePicker.open()" readonly>
                                                <mat-icon class="calendar-icon" matSuffix svgIcon="calendar"></mat-icon>
                                                <mat-datepicker #oneTimeDatePicker></mat-datepicker>
                                            </mat-form-field>
                                        </div>
                                        <div fxFlex="10%" class="u-w--100 text-truncate-ellipsis"
                                            fxLayoutAlign="end center">
                                            <button [disabled]="!salesMainDataForm.commissions.at(i).valid"
                                                mat-icon-button type="button" appPreventDoubleClick
                                                (throttledClick)="editOrSaveCommissionRow(i)"
                                                class="rates-and-fees--inline-edit-form--btn__save">
                                                <mat-icon svgIcon="rates-save-icon"></mat-icon>
                                            </button>
                                            <button mat-icon-button type="button" appPreventDoubleClick
                                                (throttledClick)="isCommissionInitialAdd ? removeCommission(i) : cancelEditCommissionRow(i)"
                                                class="rates-and-fees--inline-edit-form--btn__cancel">
                                                <mat-icon svgIcon="rates-cancel-icon"></mat-icon>
                                            </button>
                                        </div>
                                    </ng-container>
                                    <ng-container *ngIf="!commission.value.editable">
                                        <span fxFlex="10%" class="u-w--100 text-truncate-ellipsis"
                                            [matTooltip]="salesMainDataForm.commissions.at(i).get('type')?.value?.name"
                                            matTooltipClass="white-tooltip" appShowIfTruncated>
                                            {{commission.value.type?.name}}
                                        </span>
                                        <span fxFlex="10%" class="u-w--100 text-truncate-ellipsis"
                                            [matTooltip]="salesMainDataForm.commissions.at(i).get('amount')?.value"
                                            matTooltipClass="white-tooltip" appShowIfTruncated>
                                            {{commission.value.amount}}
                                        </span>
                                        <span fxFlex="10%" class="u-w--100 text-truncate-ellipsis"
                                            [matTooltip]="salesMainDataForm.commissions.at(i).get('currency')?.value?.name"
                                            matTooltipClass="white-tooltip" appShowIfTruncated>
                                            {{commission.value.currency?.name}}
                                        </span>
                                        <span fxFlex="10%" class="u-w--100 text-truncate-ellipsis"
                                            [matTooltip]="salesMainDataForm.commissions.at(i).get('recipientType')?.value?.name"
                                            matTooltipClass="white-tooltip" appShowIfTruncated>
                                            {{commission.value.recipientType?.name}}
                                        </span>
                                        <span fxFlex="1 0 30%" class="u-w--100 text-truncate-ellipsis"
                                            [matTooltip]="salesMainDataForm.commissions.at(i).get('recipient')?.value?.name"
                                            matTooltipClass="white-tooltip" appShowIfTruncated>
                                            <ng-container [ngSwitch]="commission.value.recipientType?.name">
                                                <ng-container *ngSwitchCase="'Client'">
                                                    <div fxLayout="row" fxLayoutAlign="start center">
                                                        <div fxLayout="column" fxLayoutAlign="start start">
                                                            <span>
                                                                {{commission.value.recipient?.clientName}}
                                                            </span>
                                                            <span>
                                                                {{commission.value.recipient?.clientId ? '#' +
                                                                commission.value.recipient?.clientId + ' | ' : ''}}
                                                                {{commission.value.recipient?.city ?
                                                                commission.value.recipient?.city + ' | ' : ''}}
                                                                {{commission.value.recipient?.address ?
                                                                commission.value.recipient?.address + ' | ' : ''}}
                                                                {{commission.value.recipient?.address2 ?
                                                                commission.value.recipient?.address2 + ' | ' : ''}}
                                                                {{commission.value.recipient?.postCode}}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </ng-container>
                                                <ng-container *ngSwitchCase="'Consultant'">
                                                    <div fxLayout="row" fxLayoutAlign="start center">
                                                        <!-- FIXME: use consultant info component -->
                                                        <div fxLayout="column" fxLayoutAlign="start start">
                                                            <span>
                                                                {{commission.value.recipient?.name}}
                                                            </span>
                                                            <span>
                                                                {{commission.value.recipient?.companyName ?
                                                                commission.value.recipient?.companyName + ' | ' : ''}}
                                                                {{commission.value.recipient?.city ?
                                                                commission.value.recipient?.city + ' | ' : ''}}
                                                                #{{commission.value.recipient?.id}} /
                                                                {{getTenantCodeFromId(commission.value.recipient?.tenantId)
                                                                + '-' +commission.value.recipient?.legacyId}}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </ng-container>
                                                <ng-container *ngSwitchCase="'Supplier'">
                                                    {{commission.value.recipient?.supplierName}}
                                                </ng-container>
                                                <ng-container *ngSwitchCase="'PDC entity'">
                                                    {{commission.value.recipient?.tenantName + ' ' + '(' +
                                                    commission.value.recipient?.name + ')'}}
                                                </ng-container>
                                            </ng-container>
                                        </span>
                                        <span fxFlex="20%" class="u-w--100 text-truncate-ellipsis"
                                            [matTooltip]="salesMainDataForm.commissions.at(i).get('frequency')?.value?.name"
                                            matTooltipClass="white-tooltip" appShowIfTruncated>
                                            <!-- frequency id === 2 -- 'One time' -->
                                            <ng-container
                                                *ngIf="salesMainDataForm.commissions.at(i).get('frequency')?.value?.id === 2; else commissionFrequency">
                                                {{salesMainDataForm.commissions.at(i).get('frequency')?.value?.name}}
                                                {{salesMainDataForm.commissions.at(i).get('oneTimeDate')?.value |
                                                momentFormat}}
                                            </ng-container>
                                            <ng-template #commissionFrequency>
                                                {{salesMainDataForm.commissions.at(i).get('frequency')?.value?.name}}
                                            </ng-template>
                                        </span>
                                        <div fxFlex="10%" fxLayoutAlign="end center" class="u-w--100"
                                            [fxHide]="readOnlyMode">
                                            <button mat-icon-button type="button" appPreventDoubleClick
                                                (throttledClick)="$event.stopPropagation();"
                                                [matMenuTriggerFor]="commissionMenu" class="three-dots-actions-btn">
                                                <mat-icon svgIcon="3-dots"></mat-icon>
                                            </button>
                                            <mat-menu #commissionMenu>
                                                <button class="menu-item green-color" mat-menu-item
                                                    [disabled]="isCommissionEditing" appPreventDoubleClick
                                                    (throttledClick)="editOrSaveCommissionRow(i)">
                                                    <mat-icon svgIcon="edit-icon-green"></mat-icon>
                                                    Edit
                                                </button>
                                                <button class="menu-item menu-item--cancel" mat-menu-item
                                                    appPreventDoubleClick (throttledClick)="removeCommission(i)">
                                                    <mat-icon svgIcon="close-icon"></mat-icon>
                                                    Remove
                                                </button>
                                            </mat-menu>
                                        </div>
                                    </ng-container>
                                </div>
                            </ng-container>
                        </ng-container>
                        <ng-container *ngIf="!readOnlyMode">
                            <div fxLayout="row" fxLayoutAlign="start start" class="u-w--100">
                                <button class="button-add" mat-flat-button type="button"
                                    [disabled]="isCommissionEditing" appPreventDoubleClick
                                    (throttledClick)="addCommission(true)">
                                    <mat-icon>add</mat-icon>
                                    Add commission
                                </button>
                            </div>
                        </ng-container>
                    </div>
                </div>
            </div>

            <div fxLayout="column" fxLayoutAlign="start start" class="u-w--100 u-mb--20" id="salesEmagineResponsible">
                <div fxLayout="row" fxLayoutAlign="start start" class="u-mt--16 u-mb--16">
                    <span class="workflow-section--number">3</span>
                    <h2 class="workflow-section--header">Emagine responsible</h2>
                </div>
                <div class="workflow-section--content">
                    <div fxLayout="row" fxLayoutAlign="start start" class="u-w--100">
                        <div fxLayout="column" fxLayoutAlign="start start">
                            <mat-form-field appearance="outline"
                                class="formFieldNoMarginPadding filter-select autocompleteWithShevron u-mr--12 form-width-276"
                                [ngClass]="{'disabled-input': readOnlyMode, 'isPanelOpen': salesManagerAutocomplete.isOpen}">
                                <mat-label>Sales Account Manager</mat-label>
                                <input required [disabled]="readOnlyMode" #salesAccountManagerFilterInput type="text"
                                    matInput [matAutocomplete]="salesManagerAutocomplete"
                                    formControlName="salesAccountManagerIdValue" appPreventDoubleClick
                                    (throttledClick)="$event.stopPropagation()" placeholder="Select account manager(s)">
                                    <span matSuffix class="shevron"></span>
                                <mat-autocomplete #salesManagerAutocomplete="matAutocomplete" [displayWith]="displayNameFn"
                                    (optionSelected)="focusToggleMethod('auto')" (opened)="focusToggleMethod('hidden')"
                                    (closed)="onAutocompleteClosed(salesMainDataForm.salesAccountManagerIdValue, 'id')">
                                    <ng-container *ngFor="let manager of filteredSalesAccountManagers; trackBy: trackById">
                                        <mat-option [value]="manager" [ngClass]="{ 'no-data': manager?.id === undefined }">
                                            <span class="autocopmlete-option-name">{{ manager.name }}</span>
                                        </mat-option>
                                    </ng-container>
                                </mat-autocomplete>
                                <mat-error>
                                    <app-validator [control]="salesMainDataForm.salesAccountManagerIdValue"></app-validator>
                                </mat-error>
                            </mat-form-field>
                            <manager-team class="u-mb--8"
                                [managerTeamId]="salesMainDataForm.salesAccountManagerIdValue.value?.teamsAndDivisionsNodeId"
                                [tenantId]="salesMainDataForm.salesAccountManagerIdValue.value?.tenantId"></manager-team>
                        </div>
                    </div>
                    <div fxLayout="row" fxLayoutAlign="start start" class="u-w--100">
                        <mat-form-field appearance="outline"
                            class="formFieldNoMarginPadding filter-select u-mr--12 form-width-276">
                            <mat-label>Expiration notification</mat-label>
                            <mat-select [disabled]="readOnlyMode" formControlName="contractExpirationNotification"
                                [disableOptionCentering]="true" [multiple]="true">
                                <mat-option [value]="999">
                                    Manual date
                                </mat-option>
                                <ng-container *ngFor="let item of contractExpirationNotificationInterval | keyvalue">
                                    <mat-option [value]="+item.key">
                                        {{ item.value }}
                                    </mat-option>
                                </ng-container>
                            </mat-select>
                        </mat-form-field>
                        <ng-container *ngIf="salesMainDataForm.contractExpirationNotification?.value?.includes(999)">
                            <mat-form-field appearance="outline" class="formFieldNoMarginPadding form-width-180"
                                [ngClass]="{'disabled-input': readOnlyMode}">
                                <mat-label>Expiration notification date</mat-label>
                                <input [disabled]="readOnlyMode" autocomplete="off" matInput
                                    [matDatepicker]="customContractExpirationNotificationDatePicker"
                                    name="customContractExpirationNotificationDate"
                                    formControlName="customContractExpirationNotificationDate"
                                    (focus)="customContractExpirationNotificationDatePicker.open()"
                                    appPreventDoubleClick
                                    (throttledClick)="customContractExpirationNotificationDatePicker.open()" readonly>
                                <mat-icon class="calendar-icon" matSuffix svgIcon="calendar"></mat-icon>
                                <mat-datepicker #customContractExpirationNotificationDatePicker></mat-datepicker>
                            </mat-form-field>
                        </ng-container>
                    </div>
                    <div fxLayout="row" fxLayoutAlign="start start" class="u-w--100">
                        <mat-form-field appearance="outline"
                            class="formFieldNoMarginPadding filter-select autocompleteWithShevron form-width-276 u-mr--12"
                            [ngClass]="{'disabled-input': readOnlyMode, 'isPanelOpen': commissionManagerAutocomplete.isOpen}">
                            <mat-label>Commission Account Manager</mat-label>
                            <input #commissionManagerFilterInput type="text" [disabled]="readOnlyMode" matInput
                                [matAutocomplete]="commissionManagerAutocomplete"
                                formControlName="commissionAccountManagerIdValue" appPreventDoubleClick
                                (throttledClick)="$event.stopPropagation()" placeholder="Select account manager(s)">
                                <span matSuffix class="shevron"></span>
                            <mat-autocomplete #commissionManagerAutocomplete="matAutocomplete"
                                [displayWith]="displayNameFn" (optionSelected)="focusToggleMethod('auto')"
                                (opened)="focusToggleMethod('hidden')" (closed)="onAutocompleteClosed(salesMainDataForm.commissionAccountManagerIdValue, 'id')">
                                <ng-container
                                    *ngFor="let manager of filteredCommisionAccountManagers; trackBy: trackById">
                                    <mat-option [value]="manager" [ngClass]="{ 'no-data': manager?.id === undefined }">
                                        <span class="autocopmlete-option-name">{{ manager.name }}</span>
                                    </mat-option>
                                </ng-container>
                            </mat-autocomplete>
                        </mat-form-field>
                        <mat-form-field appearance="outline"
                            class="formFieldNoMarginPadding filter-select autocompleteWithShevron form-width-276"
                            [ngClass]="{'disabled-input': readOnlyMode, 'isPanelOpen': primarySourcerAutocomplete.isOpen}">
                            <mat-label>Primary Sourcer</mat-label>
                            <input [disabled]="readOnlyMode" #salesAccountManagerFilterInput type="text"
                                matInput [matAutocomplete]="primarySourcerAutocomplete"
                                formControlName="primarySourcer" appPreventDoubleClick
                                (throttledClick)="$event.stopPropagation()" placeholder="Select primary sourcer">
                                <span matSuffix class="shevron"></span>
                            <mat-autocomplete #primarySourcerAutocomplete="matAutocomplete" [displayWith]="displayNameFn"
                                (optionSelected)="focusToggleMethod('auto')" (opened)="focusToggleMethod('hidden')"
                                (closed)="onAutocompleteClosed(salesMainDataForm.primarySourcer, 'id')">
                                <ng-container *ngFor="let manager of filteredPrimarySourcers; trackBy: trackById">
                                    <mat-option [value]="manager" [ngClass]="{ 'no-data': manager?.id === undefined }">
                                        <span class="autocopmlete-option-name">{{ manager.name }}</span>
                                    </mat-option>
                                </ng-container>
                            </mat-autocomplete>
                            <mat-error>
                                <app-validator [control]="salesMainDataForm.primarySourcer"></app-validator>
                            </mat-error>
                        </mat-form-field>
                    </div>
                    <div fxLayout="column" fxLayoutAlign="start start" class="u-w--100">
                        <ng-container formArrayName="commissionedUsers" class="u-w--100">
                            <ng-container *ngFor="let user of salesMainDataForm.commissionedUsers.controls; trackBy: trackByItem; index as i"
                                [formArrayName]="i">
                                <div fxLayout="row" fxLayoutAlign="start start" class="u-w--100">
                                    <mat-form-field appearance="outline"
                                        class="formFieldNoMarginPadding filter-select autocompleteWithShevron form-width-276"
                                        [ngClass]="{'disabled-input': readOnlyMode, 'isPanelOpen': commissionedUserAutocomplete.isOpen}">
                                        <mat-label>Commissioned employee</mat-label>
                                        <input required [disabled]="readOnlyMode" #commissionedUserInput type="text"
                                            matInput [matAutocomplete]="commissionedUserAutocomplete"
                                            formControlName="commissionedUser" appPreventDoubleClick
                                            (throttledClick)="$event.stopPropagation()" placeholder="Type something">
                                            <span matSuffix class="shevron"></span>
                                        <mat-autocomplete #commissionedUserAutocomplete="matAutocomplete"
                                            [displayWith]="displayNameFn" (optionSelected)="focusToggleMethod('auto')"
                                            (opened)="focusToggleMethod('hidden')" (closed)="onAutocompleteClosed(user.get('commissionedUser'), 'id')">
                                            <ng-container
                                                *ngFor="let employee of filteredEmployees; trackBy: trackById">
                                                <mat-option [value]="employee"
                                                    [ngClass]="{ 'no-data': employee.id === undefined }">
                                                    <div fxLayout="row" fxLayoutAlign="start center" class="u-w--100">
                                                        <ng-container *ngIf="employee.id !== undefined">
                                                            <img class="border-rounded-50 image-settings--dropdown u-mr--5"
                                                                [ngSrc]="employeePhotoUrl + employee?.externalId + '.jpg'" width="24" height="24" src (error)="setDefaultImage($event.target)" />
                                                        </ng-container>
                                                        <span class="autocopmlete-option-name">{{ employee.name
                                                            }}</span>
                                                    </div>
                                                </mat-option>
                                            </ng-container>
                                        </mat-autocomplete>
                                        <mat-error>
                                            <app-validator [control]="user.get('commissionedUser')"></app-validator>
                                        </mat-error>
                                    </mat-form-field>
                                    <ng-container *ngIf="!readOnlyMode">
                                        <button mat-icon-button type="button" appPreventDoubleClick
                                            (throttledClick)="removeCommissionedUser(i)"
                                            class="small-icon-button u-mt--5">
                                            <mat-icon svgIcon="dialog-close-icon"></mat-icon>
                                        </button>
                                    </ng-container>
                                </div>
                            </ng-container>
                        </ng-container>
                        <ng-container *ngIf="!readOnlyMode">
                            <button class="button-add u-mb--10" mat-flat-button type="button" appPreventDoubleClick
                                (throttledClick)="addCommissionedUser()">
                                <mat-icon>add</mat-icon>
                                Add commissioned employee
                            </button>
                        </ng-container>
                    </div>
                    <div fxLayout="row" fxLayoutAlign="start start" class="u-w--100">
                        <mat-form-field appearance="outline"
                            class="formFieldNoMarginPadding textarea-input u-mr--12 form-width-564"
                            [ngClass]="{'disabled-input': readOnlyMode}">
                            <mat-label>Remarks</mat-label>
                            <textarea [disabled]="readOnlyMode" required matInput autocomplete="new-password"
                                name="remarks" formControlName="remarks" [cdkTextareaAutosize]="true"
                                [cdkAutosizeMinRows]="2">
                            </textarea>
                            <mat-error>
                                <app-validator [control]="salesMainDataForm.remarks"></app-validator>
                            </mat-error>
                        </mat-form-field>
                        <ng-container *ngIf="!readOnlyMode || salesMainDataForm.noRemarks?.value">
                            <mat-checkbox [disabled]="readOnlyMode" color="accent" formControlName="noRemarks"
                                name="noRemarks" class="black-checkbox u-mt--5"
                                (change)="disableOrEnableInput(salesMainDataForm.noRemarks?.value, salesMainDataForm.remarks)">
                                None
                            </mat-checkbox>
                        </ng-container>
                    </div>
                </div>
            </div>

            <div fxLayout="column" fxLayoutAlign="start start" class="u-w--100 u-mb--20" id="salesMainDocuments">
                <div fxLayout="row" fxLayoutAlign="start start" class="u-mt--16 u-mb--16">
                    <span class="workflow-section--number">4</span>
                    <h2 class="workflow-section--header">Documents</h2>
                </div>
                <div class="workflow-section--content">
                    <app-documents #mainDocuments [readOnlyMode]="readOnlyMode"></app-documents>
                </div>
            </div>
        </div>
    </ng-template>
    <button #submitFormBtn class="display-none" type="submit">Hidden button to set form submitted</button>
</form>
