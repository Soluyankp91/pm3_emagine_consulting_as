<form [formGroup]="consultantsForm" id="consultantData" class="workflow-form--consultants u-w--100">
    <ng-container formArrayName="consultants" class="u-mb--20">
        <div fxLayout="column" fxLayoutAlign="start start" class="u-w--100">
            <ng-container *ngFor="let consultant of consultantsForm.consultants?.controls; trackBy: trackByItem; let consultantIndex = index" [formGroupName]="consultantIndex">
                <div class="workflow-sales--process-data u-w--100">
                    <div fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="30px" class="u-w--100" [id]="'salesConsultantDataAnchor' + consultantIndex">
                        <h1 class="workflow-section--header-main text-nowrap">Consultant data</h1>
                        <ng-container *ngIf="activeSideSection.typeId === workflowSideSections.StartClientPeriod || activeSideSection.typeId === workflowSideSections.ChangeClientPeriod || activeSideSection.typeId === workflowSideSections.ExtendClientPeriod || activeSideSection.typeId === workflowSideSections.ChangeConsultantPeriod || activeSideSection.typeId === workflowSideSections.ExtendConsultantPeriod">
                            <span fxFlex="auto" fxLayout="row" fxLayoutAlign="start center" class="u-w--100">
                                <ng-container  *ngIf="consultant.value?.consultantName?.consultant?.id || consultant.value?.consultantNameOnly">
                                    <ng-container *ngIf="consultant.value?.consultantName?.consultant?.id">
                                        <img class="image-thumbnail-small border-rounded-50 u-ml--16 u-mr--16"
                                            [ngSrc]="consultantPhotoUrl + consultant.value?.consultantName?.consultant?.externalId + '.jpg'" width="35" height="35" src (error)="setDefaultImage($event.target)" />
                                    </ng-container>
                                    <span class="workflow-form--consultants__name">
                                        {{consultant.value?.consultantName?.consultant?.name}}
                                    </span>
                                </ng-container>
                                <ng-container *ngIf="consultantsForm.consultants?.controls?.length && (activeSideSection.typeId === workflowSideSections.StartClientPeriod && (isCompleted === editEnabledForcefuly))">
                                    <button class="form-icon--delete-row u-ml--5" type="button"
                                        mat-icon-button appPreventDoubleClick (throttledClick)="$event.stopPropagation();confirmRemoveConsultant(consultantIndex)">
                                        <mat-icon svgIcon="remove-icon"></mat-icon>
                                    </button>
                                </ng-container>
                            </span>

                            <div fxFlex="25%" fxLayoutAlign="end center">
                                <ng-container *ngIf="consultant.value?.consultantProjectStartDate">
                                    <span class="workflow-form--consultants__period u-mr--8">
                                        {{consultant.value?.consultantProjectStartDate | momentFormat}} - {{consultant.value?.consultantProjectEndDate | momentFormat}}
                                    </span>
                                </ng-container>
                            </div>
                        </ng-container>
                    </div>

                    <div fxLayout="column" fxLayoutAlign="start start" class="u-w--100" [id]="'salesConsultantEmployment' + consultantIndex">
                        <div fxLayout="row" fxLayoutAlign="start center" class="u-mb--16 u-mt--16">
                            <span class="workflow-section--number">1</span>
                            <h2 class="workflow-section--header">Employment type</h2>
                        </div>
                        <div class="workflow-section--content">
                            <div fxLayout="row" fxLayoutAlign="start start" class="u-w--100">
                                <mat-form-field appearance="outline" class="formFieldNoMarginPadding filter-select form-width-235">
                                    <mat-label>Employment type</mat-label>
                                    <mat-select [disabled]="(activeSideSection.typeId !== workflowSideSections.StartClientPeriod && activeSideSection.typeId !== workflowSideSections.StartConsultantPeriod) || readOnlyMode" required formControlName="employmentTypeId" [disableOptionCentering]="true">
                                        <ng-container *ngFor="let item of employmentTypes; trackBy: trackById">
                                            <mat-option [value]="item.id" [ngClass]="{'hidden-option': item.id === employmentTypesEnum.EConsultant || item.id === employmentTypesEnum.VMSOrReferred}">
                                                {{ item.name }}
                                            </mat-option>
                                        </ng-container>
                                    </mat-select>
                                    <mat-error>
                                        <app-validator [control]="consultant.get('employmentTypeId')"></app-validator>
                                    </mat-error>
                                </mat-form-field>
                            </div>
                            <ng-container *ngIf="consultant.value?.employmentTypeId">
                                <div fxLayout="row" fxLayoutAlign="start start" class="u-w--100">
                                    <mat-form-field appearance="outline" class="formFieldNoMarginPadding form-width-450 autocompleteWithShevron" [fxHide]="consultant.value?.employmentTypeId === 10 || consultant.value?.employmentTypeId === 11" [ngClass]="{'disabled-input': (activeSideSection.typeId !== workflowSideSections.StartClientPeriod && activeSideSection.typeId !== workflowSideSections.StartConsultantPeriod) || readOnlyMode, 'isPanelOpen': consultantAutocomplete.isOpen}">
                                        <mat-label>Consultant Name</mat-label>
                                        <input [disabled]="(activeSideSection.typeId !== workflowSideSections.StartClientPeriod && activeSideSection.typeId !== workflowSideSections.StartConsultantPeriod) || readOnlyMode" [required]="consultant.value?.employmentTypeId !== 10 && consultant.value?.employmentTypeId !== 11" type="text" matInput [matAutocomplete]="consultantAutocomplete" name="consutlantNameAutocomplete" formControlName="consultantName" appPreventDoubleClick (throttledClick)="$event.stopPropagation()" placeholder="Consultant name">
                                        <span matSuffix class="shevron"></span>
                                        <mat-autocomplete #consultantAutocomplete="matAutocomplete" [displayWith]="displayConsultantNameFn"
                                            (optionSelected)="consultantSelected($event, consultantIndex)" (opened)="focusToggleMethod('hidden')" (closed)="focusToggleMethod('auto')">
                                            <ng-container *ngFor="let item of filteredConsultants; trackBy: trackById">
                                                <mat-option [value]="item" [ngClass]="{ 'no-data': item?.consultant?.id === undefined }" appPreventDoubleClick (throttledClick)="updateConsultantStepAnchors()">
                                                    <div class="multilineDropdown-option--row">
                                                        <ng-container *ngIf="item?.consultant?.id !== undefined">
                                                            <img class="image-thumbnail-small border-rounded-50 u-mr--10"
                                                                [ngSrc]="consultantPhotoUrl + item?.consultant?.externalId! + '.jpg'" width="35" height="35" src (error)="setDefaultImage($event.target)" />
                                                        </ng-container>
                                                        <div class="multilineDropdown-option--column text-truncate-ellipsis">
                                                            <span class="multilineDropdown-option--column-client-name">{{ item?.consultant?.name }}</span>
                                                            <ng-container *ngIf="item?.consultant?.id !== undefined">
                                                                <span class="multilineDropdown-option--column-client-info text-truncate-ellipsis">
                                                                    {{item?.consultant?.companyName ? item?.consultant?.companyName + ' | ' : ''}} {{item?.consultant?.city ? item?.consultant?.city + ' | ' : ''}} #{{item?.consultant?.id}} / {{item?.consultant?.legacyId}}
                                                                </span>
                                                            </ng-container>
                                                        </div>
                                                    </div>
                                                </mat-option>
                                            </ng-container>
                                        </mat-autocomplete>
                                        <mat-error>
                                            <app-validator [control]="consultant.get('consultantName')"></app-validator>
                                        </mat-error>
                                    </mat-form-field>
                                    <mat-form-field appearance="outline" class="u-w--100 formFieldNoMarginPadding filter-select form-width-450" [fxHide]="consultant.value?.employmentTypeId !== 10 && consultant.value?.employmentTypeId !== 11" [ngClass]="{'disabled-input': (activeSideSection.typeId !== workflowSideSections.StartClientPeriod && activeSideSection.typeId !== workflowSideSections.StartConsultantPeriod) || readOnlyMode}">
                                        <mat-label>Consultant Name only</mat-label>
                                        <input [disabled]="(activeSideSection.typeId !== workflowSideSections.StartClientPeriod && activeSideSection.typeId !== workflowSideSections.StartConsultantPeriod) || readOnlyMode" [required]="consultant.value?.employmentTypeId === 10 || consultant.value?.employmentTypeId === 11" type="text" matInput formControlName="consultantNameOnly" placeholder="Consultant name only">
                                        <mat-error>
                                            <app-validator [control]="consultant.get('consultantNameOnly')"></app-validator>
                                        </mat-error>
                                    </mat-form-field>
                                </div>
                            </ng-container>
                            <app-consultant-information [onlyAdditionalInfo]="true" [consultantData]="consultant?.value?.consultantName?.consultant"></app-consultant-information>
                        </div>
                    </div>
                    <ng-container *ngIf="consultant.value?.employmentTypeId  && (consultant.value?.employmentTypeId !== employmentTypesEnum.FeeOnly && consultant.value?.employmentTypeId !== employmentTypesEnum.Recruitment)">

                        <div fxLayout="column" fxLayoutAlign="start start" class="u-w--100" [id]="'salesConsultantContractDuration' + consultantIndex">
                            <div fxLayout="row" fxLayoutAlign="start center" class="u-mt--16 u-mb--16">
                                <span class="workflow-section--number">2</span>
                                <h2 class="workflow-section--header">Consultant contract duration</h2>
                            </div>
                            <div class="workflow-section--content">
                                <div fxLayout="column" fxLayoutAlign="start start" class="u-w--100">
                                    <mat-button-toggle-group [disabled]="readOnlyMode"
                                        [ngClass]="{'mat-form-field-invalid': !consultant.get('consultantProjectDurationSameAsClient')?.valid}"
                                        class="workflow-toggle-buttons u-mb--10" formControlName="consultantProjectDurationSameAsClient" required>
                                        <ng-container *ngIf="(readOnlyMode && !consultant.get('consultantProjectDurationSameAsClient')?.value) || !readOnlyMode">
                                            <mat-button-toggle [value]="false">
                                                Different from client
                                            </mat-button-toggle>
                                        </ng-container>
                                        <ng-container *ngIf="(readOnlyMode && consultant.get('consultantProjectDurationSameAsClient')?.value) || !readOnlyMode">
                                            <mat-button-toggle [value]="true">
                                                Same as client
                                            </mat-button-toggle>
                                        </ng-container>
                                    </mat-button-toggle-group>
                                    <mat-error>
                                        <ng-container *ngIf="consultant.get('consultantProjectDurationSameAsClient')?.touched">
                                            <app-validator [withoutFormField]="true" [control]="consultant.get('consultantProjectDurationSameAsClient')"></app-validator>
                                        </ng-container>
                                    </mat-error>
                                </div>
                                <ng-container *ngIf="!consultant.value?.consultantProjectDurationSameAsClient">
                                    <div fxLayout="row" fxLayoutAlign="start center" class="u-w--100">
                                        <mat-form-field appearance="outline" class="formFieldNoMarginPadding u-mr--12 form-width-150" [ngClass]="{'disabled-input': readOnlyMode}">
                                            <mat-label>Start date</mat-label>
                                            <input [disabled]="readOnlyMode" required autocomplete="off" matInput
                                                    [matDatepicker]="consultantProjectStartDatePicker"
                                                    name="consultantProjectStartDate" formControlName="consultantProjectStartDate"
                                                    (focus)="consultantProjectStartDatePicker.open()"
                                                    appPreventDoubleClick (throttledClick)="consultantProjectStartDatePicker.open()" readonly>
                                            <mat-icon class="calendar-icon" matSuffix svgIcon="calendar"></mat-icon>
                                            <mat-datepicker #consultantProjectStartDatePicker></mat-datepicker>
                                            <mat-error>
                                                <app-validator [control]="consultant.get('consultantProjectStartDate')"></app-validator>
                                            </mat-error>
                                        </mat-form-field>

                                        <mat-form-field appearance="outline" class="formFieldNoMarginPadding u-mr--12 form-width-150" [ngClass]="{'disabled-input': readOnlyMode}">
                                            <mat-label>End date</mat-label>
                                            <input [disabled]="readOnlyMode" required autocomplete="off" matInput
                                                    [matDatepicker]="consultantProjectEndDatePicker"
                                                    name="consultantProjectEndDate" formControlName="consultantProjectEndDate"
                                                    (focus)="consultantProjectEndDatePicker.open()"
                                                    appPreventDoubleClick (throttledClick)="consultantProjectEndDatePicker.open()" readonly>
                                            <mat-icon class="calendar-icon" matSuffix svgIcon="calendar"></mat-icon>
                                            <mat-datepicker #consultantProjectEndDatePicker></mat-datepicker>
                                            <mat-error>
                                                <app-validator [control]="consultant.get('consultantProjectEndDate')"></app-validator>
                                            </mat-error>
                                        </mat-form-field>
                                        <ng-container *ngIf="!readOnlyMode || consultant.get('consultantProjectNoEndDate')?.value">
                                            <mat-checkbox [disabled]="readOnlyMode" color="accent" formControlName="consultantProjectNoEndDate" name="consultantProjectNoEndDate" class="black-checkbox"
                                                        (change)="disableOrEnableInput(consultantsForm.consultants.at(consultantIndex).get('consultantProjectNoEndDate')?.value, consultantsForm.consultants.at(consultantIndex).get('consultantProjectEndDate'))">
                                                No end date
                                            </mat-checkbox>
                                        </ng-container>
                                    </div>
                                </ng-container>
                            </div>
                        </div>
                        <div fxLayout="column" fxLayoutAlign="start start" class="u-w--100" [id]="'salesConsultantProject' + consultantIndex">
                            <div fxLayout="row" fxLayoutAlign="start center" class="u-mt--16 u-mb--16">
                                <span class="workflow-section--number">3</span>
                                <h2 class="workflow-section--header">Consultant project</h2>
                            </div>
                            <div class="workflow-section--content">
                                <div fxLayout="column" fxLayoutAlign="start start" class="u-w--100">
                                    <h3 class="workflow-gray--header u-mb--10">Workplace</h3>
                                    <div fxLayout="row" fxLayoutAlign="start center" class="u-w--100 u-mb--10" [fxHide]="readOnlyMode && !consultantsForm.consultants.at(consultantIndex).get('consultantIsOnsiteWorkplace')?.value">
                                        <mat-checkbox [disabled]="readOnlyMode" color="accent" [required]="!consultant.value.consultantIsEmagineOfficeWorkplace && !consultant.value.consultantIsRemoteWorkplace" formControlName="consultantIsOnsiteWorkplace" name="consultantIsOnsiteWorkplace" class="black-checkbox u-mr--12" fxFlex="20%">
                                            Onsite
                                        </mat-checkbox>
                                        <ng-container *ngIf="consultantsForm.consultants.at(consultantIndex).get('consultantIsOnsiteWorkplace')?.value">
                                            <div fxLayout="column" fxLayoutAlign="start start" class="u-w--100">
                                                <div fxLayout="row" fxLayoutAlign="start center" class="u-w--100">
                                                    <mat-form-field appearance="outline" class="formFieldNoMarginPadding autocompleteWithShevron client-address-autocomplete u-mr--12 form-width-330" [ngClass]="{'disabled-input': readOnlyMode || consultant.value?.onsiteClientSameAsDirectClient, 'isPanelOpen': consultantClientAddressAuto.isOpen, 'is-empty': !consultant.get('consultantWorkplaceClientAddress')?.value}">
                                                        <mat-label>Client</mat-label>
                                                        <input [disabled]="readOnlyMode || consultant.value?.onsiteClientSameAsDirectClient" required type="text" matInput [matAutocomplete]="consultantClientAddressAuto" formControlName="consultantWorkplaceClientAddress" appPreventDoubleClick (throttledClick)="$event.stopPropagation()" placeholder="Search client">
                                                        <ng-container *ngIf="consultant.get('consultantWorkplaceClientAddress')?.value?.clientId" matPrefix>
                                                            <ng-container [ngTemplateOutlet]="clientPrefix"
                                                                [ngTemplateOutletContext]="{client: consultant.get('consultantWorkplaceClientAddress')?.value}">
                                                            </ng-container>
                                                        </ng-container>
                                                        <span matSuffix class="shevron"></span>
                                                        <mat-autocomplete #consultantClientAddressAuto="matAutocomplete" [displayWith]="displayClientNameFn"
                                                            (optionSelected)="clientOfficeSelected($event, consultantIndex)" (opened)="focusToggleMethod('hidden')" (closed)="onAutocompleteClosed(consultant.get('consultantWorkplaceClientAddress'), 'clientId')">
                                                            <ng-container *ngFor="let client of filteredConsultantClientAddresses; trackBy: trackById">
                                                                <mat-option [value]="client" [ngClass]="{ 'no-data': client?.clientId === undefined }">
                                                                    <div class="multilineDropdown-option--column text-truncate-ellipsis">
                                                                        <span class="multilineDropdown-option--column-client-name">{{ client.clientName }}</span>
                                                                        <ng-container *ngIf="client?.clientId !== undefined && client?.clientAddresses?.length">
                                                                            <span class="multilineDropdown-option--column-client-info text-truncate-ellipsis">
                                                                                #{{client.clientId}} | {{client.clientAddresses[0]?.city ?? ''}} {{client.clientAddresses[0]?.countryName ? ', ' + client.clientAddresses[0].countryName : ''}}
                                                                            </span>
                                                                        </ng-container>
                                                                    </div>
                                                                </mat-option>
                                                            </ng-container>
                                                        </mat-autocomplete>
                                                        <mat-error>
                                                            <app-validator [control]="consultant.get('consultantWorkplaceClientAddress')"></app-validator>
                                                        </mat-error>
                                                    </mat-form-field>
                                                    <ng-container [ngTemplateOutlet]="clientAdditionalInfo" [ngTemplateOutletContext]="{client: consultant.value.consultantWorkplaceClientAddress}">
                                                    </ng-container>
                                                </div>
                                                <mat-form-field appearance="outline" [ngClass]="{'is-empty': !consultant.get('onsiteClientAddress')?.value}"
                                                    class="formFieldNoMarginPadding filter-select form-width-330 client-address-autocomplete">
                                                    <mat-label>Client address</mat-label>
                                                    <mat-select [disabled]="readOnlyMode || consultant.value?.onsiteClientSameAsDirectClient" formControlName="onsiteClientAddress"
                                                        [disableOptionCentering]="true" [compareWith]="compareWithFn" required>
                                                        <mat-select-trigger>
                                                            <div class="multilineDropdown-option--column text-truncate-ellipsis">
                                                                <span class="multilineDropdown-option--column-client-name">
                                                                    {{consultant.value.onsiteClientAddress?.displayValue }}</span>
                                                                <span class="multilineDropdown-option--column-client-info text-truncate-ellipsis">
                                                                    {{consultant.value.onsiteClientAddress?.addressType}}
                                                                </span>
                                                            </div>
                                                        </mat-select-trigger>
                                                        <ng-container *ngFor="let item of onsiteClientAddresses[consultantIndex]; trackBy: trackById">
                                                            <mat-option [value]="item" [fxHide]="item.isHidden">
                                                                <div class="multilineDropdown-option--column text-truncate-ellipsis">
                                                                    <span class="multilineDropdown-option--column-client-name">
                                                                        {{item.displayValue }}</span>
                                                                    <span class="multilineDropdown-option--column-client-info text-truncate-ellipsis">
                                                                        {{item.addressType}}
                                                                    </span>
                                                                </div>
                                                            </mat-option>
                                                        </ng-container>
                                                    </mat-select>
                                                    <mat-error>
                                                        <app-validator [control]="consultant.get('onsiteClientAddress')"></app-validator>
                                                    </mat-error>
                                                </mat-form-field>
                                                <mat-checkbox [disabled]="readOnlyMode" color="accent" (change)="changeConsultantWorkplace($event, consultantIndex)" name="onsiteClientSameAsDirectClient" class="black-checkbox u-mt--5" formControlName="onsiteClientSameAsDirectClient">
                                                    Same as direct client
                                                </mat-checkbox>
                                                <mat-form-field appearance="outline" class="formFieldNoMarginPadding form-width-150" [ngClass]="{'disabled-input': readOnlyMode}" [fxHide]="!consultant.value?.consultantIsEmagineOfficeWorkplace && !consultant.value?.consultantIsRemoteWorkplace">
                                                    <mat-label>Percentage onsite</mat-label>
                                                    <input [disabled]="readOnlyMode" [required]="consultant.value?.consultantIsEmagineOfficeWorkplace || consultant.value?.consultantIsRemoteWorkplace" autocomplete="off" matInput formControlName="consultantWorkplacePercentageOnSite" type="number" [min]="1" [max]="100">
                                                    <mat-icon matSuffix svgIcon="percentage-icon"></mat-icon>
                                                    <mat-error>
                                                        <app-validator [control]="consultant.get('consultantWorkplacePercentageOnSite')"></app-validator>
                                                    </mat-error>
                                                </mat-form-field>
                                            </div>
                                        </ng-container>
                                    </div>
                                    <div fxLayout="row" fxLayoutAlign="start center" class="u-w--100 u-mb--10" [fxHide]="readOnlyMode && !consultantsForm.consultants.at(consultantIndex).get('consultantIsEmagineOfficeWorkplace')?.value">
                                        <mat-checkbox [disabled]="readOnlyMode" color="accent" [required]="!consultant.value.consultantIsOnsiteWorkplace && !consultant.value.consultantIsRemoteWorkplace" formControlName="consultantIsEmagineOfficeWorkplace" name="consultantIsEmagineOfficeWorkplace" class="black-checkbox u-mr--12" fxFlex="20%">
                                            emagine Office
                                        </mat-checkbox>
                                        <mat-form-field appearance="outline" class="formFieldNoMarginPadding filter-select form-width-312" [fxHide]="!consultantsForm.consultants.at(consultantIndex).get('consultantIsEmagineOfficeWorkplace')?.value">
                                            <mat-label>emagine Office address</mat-label>
                                            <mat-select [disabled]="readOnlyMode" [required]="consultantsForm.consultants.at(consultantIndex).get('consultantIsEmagineOfficeWorkplace')?.value" formControlName="emagineOfficeId" [disableOptionCentering]="true">
                                                <ng-container *ngFor="let item of emagineOffices; trackBy: trackById">
                                                    <mat-option [value]="item.id">
                                                        {{ item.name }}
                                                    </mat-option>
                                                </ng-container>
                                            </mat-select>
                                            <mat-error>
                                                <app-validator [control]="consultant.get('emagineOfficeId')"></app-validator>
                                            </mat-error>
                                        </mat-form-field>
                                    </div>
                                    <div fxLayout="row" fxLayoutAlign="start center" class="u-w--100" [fxHide]="readOnlyMode && !consultantsForm.consultants.at(consultantIndex).get('consultantIsRemoteWorkplace')?.value">
                                        <mat-checkbox [disabled]="readOnlyMode" color="accent" [required]="!consultant.value.consultantIsOnsiteWorkplace && !consultant.value.consultantIsEmagineOfficeWorkplace" formControlName="consultantIsRemoteWorkplace" name="consultantIsRemoteWorkplace" class="black-checkbox u-mr--12" fxFlex="20%">
                                            Remote
                                        </mat-checkbox>
                                        <mat-form-field appearance="outline" class="formFieldNoMarginPadding autocompleteWithShevron form-width-312" [fxHide]="!consultantsForm.consultants.at(consultantIndex).get('consultantIsRemoteWorkplace')?.value" [ngClass]="{'disabled-input': readOnlyMode, 'isPanelOpen': consultantCountryAuto.isOpen}">
                                            <mat-label>Remote country</mat-label>
                                            <input [disabled]="readOnlyMode" [required]="consultantsForm.consultants.at(consultantIndex).get('consultantIsRemoteWorkplace')?.value" type="text" matInput [matAutocomplete]="consultantCountryAuto" formControlName="consultantWorkplaceRemote" appPreventDoubleClick (throttledClick)="$event.stopPropagation()" placeholder="Search country">
                                            <span matSuffix class="shevron"></span>
                                            <mat-autocomplete #consultantCountryAuto="matAutocomplete" [displayWith]="displayNameFn"
                                                (optionSelected)="focusToggleMethod('auto')" (opened)="focusToggleMethod('hidden')" (closed)="focusToggleMethod('auto')">
                                                <ng-container *ngFor="let option of filteredConsultantCountries; trackBy: trackById">
                                                    <mat-option [value]="option">
                                                        <span class="autocopmlete-option-name">
                                                            {{option.name}}
                                                        </span>
                                                    </mat-option>
                                                </ng-container>
                                            </mat-autocomplete>
                                            <mat-error>
                                                <app-validator [control]="consultant.get('consultantWorkplaceRemote')"></app-validator>
                                            </mat-error>
                                        </mat-form-field>
                                    </div>
                                    <ng-container *ngIf="consultant.get('consultantIsOnsiteWorkplace')?.touched || consultant.get('consultantIsRemoteWorkplace')?.touched || consultant.get('consultantIsEmagineOfficeWorkplace')?.touched">
                                        <ng-container  *ngIf="!consultant.value.consultantIsOnsiteWorkplace && !consultant.value.consultantIsEmagineOfficeWorkplace && !consultant.value.consultantIsRemoteWorkplace">
                                            <mat-error class="custom-error--message">
                                                At least one Workplace is required
                                            </mat-error>
                                        </ng-container>
                                    </ng-container>
                                </div>
                                <h3 class="workflow-gray--header u-mb--10 u-mt--20">Expected Workload</h3>
                                <div fxLayout="row" fxLayoutAlign="start center" class="u-w--100">
                                    <mat-form-field appearance="outline" class="formFieldNoMarginPadding u-mr--12 form-width-150" [ngClass]="{'disabled-input': readOnlyMode}">
                                        <mat-label>Hours</mat-label>
                                        <input [disabled]="readOnlyMode" required autocomplete="off" matInput formControlName="expectedWorkloadHours" type="number">
                                        <mat-error>
                                            <app-validator [control]="consultant.get('expectedWorkloadHours')"></app-validator>
                                        </mat-error>
                                    </mat-form-field>
                                    <mat-form-field appearance="outline" class="formFieldNoMarginPadding filter-select form-width-150">
                                        <mat-label>Period</mat-label>
                                        <mat-select [disabled]="readOnlyMode" required formControlName="expectedWorkloadUnitId" [disableOptionCentering]="true">
                                            <ng-container *ngFor="let item of expectedWorkloadUnits; trackBy: trackById">
                                                <mat-option [value]="item.id">
                                                    {{ item.name }}
                                                </mat-option>
                                            </ng-container>
                                        </mat-select>
                                        <mat-error>
                                            <app-validator [control]="consultant.get('expectedWorkloadUnitId')"></app-validator>
                                        </mat-error>
                                    </mat-form-field>
                                </div>

                                <ng-container *ngIf="clientDataForm.clientTimeReportingCapId?.value === eTimeReportingCaps.IndividualCap">
                                    <h3 class="workflow-gray--header u-mb--10 u-mt--20">Cap on Time Reporting</h3>
                                    <div fxLayout="row" fxLayoutAlign="start start" class="u-w--100">
                                        <mat-form-field appearance="outline" class="formFieldNoMarginPadding filter-select u-mr--12 form-width-150">
                                            <mat-label>Cap type</mat-label>
                                            <mat-select [disabled]="readOnlyMode" required formControlName="consultantTimeReportingCapId"
                                                (selectionChange)="capSelectionChange($event, consultantIndex)"
                                                [disableOptionCentering]="true">
                                                <ng-container *ngFor="let item of consultantTimeReportingCap; trackBy: trackById">
                                                    <mat-option [value]="item.id">
                                                        {{ item.name }}
                                                    </mat-option>
                                                </ng-container>
                                            </mat-select>
                                            <mat-error>
                                                <app-validator [control]="consultant.get('consultantTimeReportingCapId')"></app-validator>
                                            </mat-error>
                                        </mat-form-field>
                                        <div fxLayout="column" fxLayoutAlign="start start" class="u-w--100">
                                            <ng-container *ngIf="consultant.get('consultantTimeReportingCapId').value === eTimeReportingCaps.CapOnUnits">
                                                <ng-container formArrayName="timeReportingCaps" class="u-w--100">
                                                    <ng-container
                                                        *ngFor="let cap of getConsultantCapControls(consultantIndex); trackBy: trackByItem; index as i"
                                                        [formArrayName]="i">
                                                        <div fxLayout="row" fxLayoutAlign="start start" class="u-w--100">
                                                            <mat-form-field appearance="outline" class="formFieldNoMarginPadding u-mr--12 form-width-110"
                                                                [ngClass]="{'disabled-input': readOnlyMode}">
                                                                <mat-label>Max value</mat-label>
                                                                <input [disabled]="readOnlyMode" required autocomplete="off" matInput formControlName="timeReportingCapMaxValue"
                                                                    type="number">
                                                                <mat-error>
                                                                    <app-validator [control]="cap.get('timeReportingCapMaxValue')"></app-validator>
                                                                </mat-error>
                                                            </mat-form-field>
                                                            <mat-form-field appearance="outline" class="formFieldNoMarginPadding filter-select u-mr--12 form-width-100">
                                                                <mat-label>Unit</mat-label>
                                                                <mat-select [disabled]="readOnlyMode" required formControlName="valueUnitId"
                                                                    [disableOptionCentering]="true">
                                                                    <ng-container *ngFor="let item of valueUnitTypes; trackBy: trackById">
                                                                        <mat-option [value]="item.id">
                                                                            {{ item.name }}
                                                                        </mat-option>
                                                                    </ng-container>
                                                                </mat-select>
                                                                <mat-error>
                                                                    <app-validator [control]="cap.get('valueUnitId')"></app-validator>
                                                                </mat-error>
                                                            </mat-form-field>
                                                            <mat-form-field appearance="outline" class="formFieldNoMarginPadding filter-select form-width-150">
                                                                <mat-label>Period</mat-label>
                                                                <mat-select [disabled]="readOnlyMode" required formControlName="periodUnitId"
                                                                    [disableOptionCentering]="true">
                                                                    <ng-container *ngFor="let item of periodUnitTypes; trackBy: trackById">
                                                                        <mat-option [value]="item.id">
                                                                            {{ item.name }}
                                                                        </mat-option>
                                                                    </ng-container>
                                                                </mat-select>
                                                                <mat-error>
                                                                    <app-validator [control]="cap.get('periodUnitId')"></app-validator>
                                                                </mat-error>
                                                            </mat-form-field>
                                                            <ng-container *ngIf="!readOnlyMode">
                                                                <button mat-icon-button type="button" appPreventDoubleClick
                                                                    (throttledClick)="removeTimeReportingCap(consultantIndex, i)" class="small-icon-button u-mt--5">
                                                                    <mat-icon svgIcon="dialog-close-icon"></mat-icon>
                                                                </button>
                                                            </ng-container>
                                                        </div>
                                                    </ng-container>
                                                </ng-container>
                                                <ng-container *ngIf="!readOnlyMode">
                                                    <button class="button-add u-mt--8 u-mb--10" mat-flat-button type="button" appPreventDoubleClick
                                                        (throttledClick)="addConsultantCap(consultantIndex)">
                                                        <mat-icon>add</mat-icon>
                                                        Add Cap value
                                                    </button>
                                                </ng-container>
                                            </ng-container>
                                        </div>
                                    </div>
                                </ng-container>
                            </div>
                        </div>

                        <div fxLayout="column" fxLayoutAlign="start start" class="u-w--100" [id]="'salesConsultantRatesFees' + consultantIndex">
                            <div fxLayout="row" fxLayoutAlign="start center" class="u-mt--16 u-mb--16">
                                <span class="workflow-section--number">4</span>
                                <h2 class="workflow-section--header">Rates and fees</h2>
                            </div>
                            <div class="workflow-section--content">
                                <div class="inline-edit-form u-w--100">
                                    <ng-container *ngIf="consultant.value.specialRates?.length">
                                        <div fxLayout="row" fxLayoutAlign="space-between start" fxLayoutGap="10px" class="workflow-sales-inline--form__header-container u-w--100">
                                            <span fxFlex="1 0 20%" class="workflow-sales-inline--form__header u-w--100">
                                                Rate name
                                            </span>
                                            <span fxFlex="20%" class="workflow-sales-inline--form__header u-w--100">
                                                Reporting unit
                                            </span>
                                            <ng-container *ngIf="consultant.value?.pdcPaymentEntityId !== clientDataForm.value?.pdcInvoicingEntityId">
                                                <span fxFlex="25%" class="workflow-sales-inline--form__header u-w--100">
                                                    emagine rate
                                                </span>
                                            </ng-container>
                                            <span fxFlex="25%" class="workflow-sales-inline--form__header u-w--100">
                                                Consultant rate
                                            </span>
                                            <span fxFlex="10%" class="workflow-sales-inline--form__header u-w--100" [fxHide]="readOnlyMode">
                                            </span>
                                        </div>
                                    </ng-container>
                                    <ng-container formArrayName="specialRates" class="u-w--100">
                                        <ng-container *ngFor="let rate of getConsultantRateControls(consultantIndex); let specialRateIndex = index; first as first" [formArrayName]="specialRateIndex">
                                            <div fxLayout="row" fxLayoutAlign="space-between center" fxLayoutGap="10px" class="workflow-sales-inline--form__row u-w--100" [ngClass]="{'u-bt--0': !first}">
                                                <ng-container>
                                                    <span fxFlex="1 0 20%" class="u-w--100 text-truncate-ellipsis" [matTooltip]="rate.value.rateName" matTooltipClass="white-tooltip" appShowIfTruncated>
                                                        {{rate.value.rateName ?? '-'}}
                                                    </span>
                                                    <span fxFlex="20%" class="u-w--100 text-truncate-ellipsis" [matTooltip]="rate.value.reportingUnit?.name" matTooltipClass="white-tooltip" appShowIfTruncated>
                                                        {{rate.value.reportingUnit?.name ?? '-'}}
                                                    </span>
                                                    <ng-container *ngIf="consultant.value?.pdcPaymentEntityId !== clientDataForm.value?.pdcInvoicingEntityId">
                                                        <ng-container *ngIf="rate.value.editable; else consutlantProDataRateCurrencyDisplay">
                                                            <div fxFlex="25%" fxLayout="row" fxLayoutAlign="start start">
                                                                <mat-form-field appearance="fill" class="u-w--100 formFieldNoMarginPadding filter-select u-mr--10" fxFlex="30%">
                                                                    <input [required]="consultant.value?.pdcPaymentEntityId !== clientDataForm.value?.pdcInvoicingEntityId" matInput type="number" placeholder="Rate" formControlName="prodataToProdataRate">
                                                                </mat-form-field>
                                                                <mat-form-field appearance="fill" class="u-w--100 formFieldNoMarginPadding filter-select" fxFlex="50%">
                                                                    <mat-select [required]="consultant.value?.pdcPaymentEntityId !== clientDataForm.value?.pdcInvoicingEntityId" formControlName="prodataToProdataRateCurrencyId" placeholder="Currency" [disableOptionCentering]="true">
                                                                        <ng-container *ngFor="let item of currencies; trackBy: trackById">
                                                                            <mat-option [value]="item.id">
                                                                                {{ item.name }}
                                                                            </mat-option>
                                                                        </ng-container>
                                                                    </mat-select>
                                                                </mat-form-field>
                                                            </div>
                                                        </ng-container>
                                                        <ng-template #consutlantProDataRateCurrencyDisplay>
                                                            <span fxFlex="25%" class="u-w--100 text-truncate-ellipsis" [matTooltip]="rate.value.prodataToProdataRate !== null && eCurrencies[rate.value.prodataToProdataRateCurrencyId]?.length ? rate.value.prodataToProdataRate + ' ' + eCurrencies[rate.value.prodataToProdataRateCurrencyId] : '-'" matTooltipClass="white-tooltip" appShowIfTruncated>
                                                                {{rate.value.prodataToProdataRate !== null && eCurrencies[rate.value.prodataToProdataRateCurrencyId]?.length ? rate.value.prodataToProdataRate + ' ' + eCurrencies[rate.value.prodataToProdataRateCurrencyId] : '-'}}
                                                            </span>
                                                        </ng-template>
                                                    </ng-container>

                                                    <ng-container *ngIf="rate.value.editable; else consutlantRateCurrencyDisplay">
                                                        <div fxFlex="25%" fxLayout="row" fxLayoutAlign="start start">
                                                            <mat-form-field appearance="fill" class="u-w--100 formFieldNoMarginPadding filter-select u-mr--10" fxFlex="30%">
                                                                <input required matInput type="number" placeholder="Rate" formControlName="consultantRate">
                                                            </mat-form-field>
                                                            <mat-form-field appearance="fill" class="u-w--100 formFieldNoMarginPadding filter-select" fxFlex="50%">
                                                                <mat-select required formControlName="consultantRateCurrencyId" placeholder="Currency" [disableOptionCentering]="true">
                                                                    <ng-container *ngFor="let item of currencies; trackBy: trackById">
                                                                        <mat-option [value]="item.id">
                                                                            {{ item.name }}
                                                                        </mat-option>
                                                                    </ng-container>
                                                                </mat-select>
                                                            </mat-form-field>
                                                        </div>
                                                    </ng-container>
                                                    <ng-template #consutlantRateCurrencyDisplay>
                                                        <span fxFlex="25%" class="u-w--100 text-truncate-ellipsis" [matTooltip]="rate.value.consultantRate !== null && eCurrencies[rate.value.consultantRateCurrencyId]?.length ? rate.value.consultantRate + ' ' + eCurrencies[rate.value.consultantRateCurrencyId] : '-'" matTooltipClass="white-tooltip" appShowIfTruncated>
                                                            {{rate.value.consultantRate !== null && eCurrencies[rate.value.consultantRateCurrencyId]?.length ? rate.value.consultantRate + ' ' + eCurrencies[rate.value.consultantRateCurrencyId] : '-'}}
                                                        </span>
                                                    </ng-template>
                                                    <ng-container *ngIf="rate.value.editable; else consultantRateActionDisplay">
                                                        <div fxFlex="10%" class="u-w--100 text-truncate-ellipsis" fxLayoutAlign="end center" [fxHide]="readOnlyMode">
                                                            <button mat-icon-button type="button" [disabled]="!rate.valid" appPreventDoubleClick (throttledClick)="editOrSaveConsultantRate(consultantIndex, specialRateIndex, rate.value.editable)" class="rates-and-fees--inline-edit-form--btn__save">
                                                                <mat-icon svgIcon="rates-save-icon"></mat-icon>
                                                            </button>
                                                            <button mat-icon-button type="button" appPreventDoubleClick (throttledClick)="cancelEditConsultantRate(consultantIndex, specialRateIndex)" class="rates-and-fees--inline-edit-form--btn__cancel">
                                                                <mat-icon svgIcon="rates-cancel-icon"></mat-icon>
                                                            </button>
                                                        </div>
                                                    </ng-container>
                                                    <ng-template #consultantRateActionDisplay>
                                                        <div fxFlex="10%" fxLayoutAlign="end center" class="u-w--100" [fxHide]="readOnlyMode">
                                                            <button mat-icon-button type="button" appPreventDoubleClick (throttledClick)="$event.stopPropagation();" [matMenuTriggerFor]="consutlantRateMenu" class="three-dots-actions-btn">
                                                                <mat-icon svgIcon="3-dots"></mat-icon>
                                                            </button>
                                                            <mat-menu #consutlantRateMenu>
                                                                <button
                                                                    class="menu-item green-color"
                                                                    mat-menu-item
                                                                    [disabled]="isConsultantRateEditing"
                                                                    appPreventDoubleClick (throttledClick)="editOrSaveConsultantRate(consultantIndex, specialRateIndex, rate.value.editable)">
                                                                    <mat-icon svgIcon="edit-icon-green"></mat-icon>
                                                                    Edit
                                                                </button>
                                                                <button
                                                                    class="menu-item menu-item--cancel"
                                                                    mat-menu-item
                                                                    appPreventDoubleClick (throttledClick)="removeConsutlantRate(consultantIndex, specialRateIndex)">
                                                                    <mat-icon svgIcon="close-icon"></mat-icon>
                                                                    Delete
                                                                </button>
                                                            </mat-menu>
                                                        </div>
                                                    </ng-template>
                                                </ng-container>
                                            </div>
                                        </ng-container>
                                        <ng-container *ngIf="consultant.value.specialRates?.length === 0 && readOnlyMode">
                                            <div fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="10px" class="emptyStateRow">
                                                <span class="light-grey-color text-600">
                                                    No consultant rates
                                                </span>
                                            </div>
                                        </ng-container>
                                    </ng-container>
                                </div>

                                <div fxLayout="row" fxLayoutAlign="start start" class="u-mb--10" [fxHide]="readOnlyMode">
                                    <button class="rates-and-fees--btn button-add" mat-flat-button
                                        [ngClass]="{'u-mt--16': consultant.value.specialRates?.length}"
                                        [matMenuTriggerFor]="consultantSpecialRateMenu"
                                        [disabled]="isConsultantRateEditing"
                                        type="button"
                                        (menuOpened)="consultantsForm.consultants.at(consultantIndex).get('consultantSpecialRateFilter')!.setValue(''); consultantSpecialRateSelect.open();"
                                        #consultantRateMenuTrigger="matMenuTrigger">
                                        <mat-icon>add</mat-icon>
                                        Add special rate
                                    </button>
                                    <mat-menu #consultantSpecialRateMenu backdropClass="add-rates-button--menu">
                                        <div mat-menu-item appPreventDoubleClick (throttledClick)="$event.stopPropagation()" class="u-pg--0">
                                            <mat-form-field appearance="fill" class="add-rates-button--dropdown formFieldNoMarginPadding filter-select u-w--100">
                                                <mat-label>Choose special rate</mat-label>
                                                <mat-select #consultantSpecialRateSelect formControlName="consultantSpecialRateFilter" [disableOptionCentering]="true">
                                                    <ng-container *ngFor="let item of clientSpecialRateList | excludeIds: consultant.value.specialRates : 'clientSpecialRateId'; trackBy: trackById">
                                                        <mat-option [disabled]="item.id === null" [value]="item.id" appPreventDoubleClick (throttledClick)="item.id !== null ? selectConsultantSpecialRate($event, consultantIndex, item, consultantRateMenuTrigger) : ''">
                                                            {{ item.internalName }}
                                                        </mat-option>
                                                    </ng-container>
                                                </mat-select>
                                            </mat-form-field>
                                        </div>
                                    </mat-menu>
                                </div>

                                <div class="inline-edit-form u-w--100">
                                    <ng-container *ngIf="consultant.value.specialFees?.length">
                                        <div fxLayout="row" fxLayoutAlign="space-between start" fxLayoutGap="10px" class="workflow-sales-inline--form__header-container u-pt--10 u-w--100">
                                            <span fxFlex="1 0 20%" class="workflow-sales-inline--form__header u-w--100">
                                                Fee name
                                            </span>
                                            <span fxFlex="20%" class="workflow-sales-inline--form__header u-w--100">
                                                Frequency
                                            </span>
                                            <ng-container *ngIf="consultant.value?.pdcPaymentEntityId !== clientDataForm.value?.pdcInvoicingEntityId">
                                                <span fxFlex="25%" class="workflow-sales-inline--form__header u-w--100">
                                                    emagine fee
                                                </span>
                                            </ng-container>
                                            <span fxFlex="25%" class="workflow-sales-inline--form__header u-w--100">
                                                Consultant fee
                                            </span>
                                            <span fxFlex="10%" class="workflow-sales-inline--form__header u-w--100" [fxHide]="readOnlyMode">
                                            </span>
                                        </div>
                                    </ng-container>
                                    <ng-container formArrayName="specialFees" class="u-w--100">
                                        <ng-container *ngFor="let fee of getConsultantFeeControls(consultantIndex); let specialFeeIndex = index; first as first" [formArrayName]="specialFeeIndex">
                                            <div fxLayout="row" fxLayoutAlign="space-between center" fxLayoutGap="10px" class="workflow-sales-inline--form__row u-w--100" [ngClass]="{'u-bt--0': !first}">
                                                <ng-container>
                                                    <span fxFlex="1 0 20%" class="u-w--100 text-truncate-ellipsis" [matTooltip]="fee.value.feeName ?? '-'" matTooltipClass="white-tooltip" appShowIfTruncated>
                                                        {{fee.value.feeName ?? '-'}}
                                                    </span>
                                                    <span fxFlex="20%" class="u-w--100 text-truncate-ellipsis" [matTooltip]="fee.value.frequency?.name ?? '-'" matTooltipClass="white-tooltip" appShowIfTruncated>
                                                        {{fee.value.frequency?.name ?? '-'}}
                                                    </span>
                                                    <ng-container *ngIf="consultant.value?.pdcPaymentEntityId !== clientDataForm.value?.pdcInvoicingEntityId">
                                                        <ng-container *ngIf="fee.value.editable; else proDataFeeCurrencyDisplay">
                                                            <div fxFlex="25%" fxLayout="row" fxLayoutAlign="start start">
                                                                <mat-form-field appearance="fill" class="u-w--100 formFieldNoMarginPadding filter-select u-mr--10" fxFlex="30%">
                                                                    <input [required]="consultant.value?.pdcPaymentEntityId !== clientDataForm.value?.pdcInvoicingEntityId" matInput type="number" placeholder="Rate" formControlName="prodataToProdataRate">
                                                                </mat-form-field>
                                                                <mat-form-field appearance="fill" class="u-w--100 formFieldNoMarginPadding filter-select" fxFlex="50%">
                                                                    <mat-select [required]="consultant.value?.pdcPaymentEntityId !== clientDataForm.value?.pdcInvoicingEntityId" formControlName="prodataToProdataRateCurrencyId" placeholder="Currency" [disableOptionCentering]="true">
                                                                        <ng-container *ngFor="let item of currencies; trackBy: trackById">
                                                                            <mat-option [value]="item.id">
                                                                                {{ item.name }}
                                                                            </mat-option>
                                                                        </ng-container>
                                                                    </mat-select>
                                                                </mat-form-field>
                                                            </div>
                                                        </ng-container>
                                                        <ng-template #proDataFeeCurrencyDisplay>
                                                            <span fxFlex="25%" class="u-w--100 text-truncate-ellipsis" [matTooltip]="fee.value.prodataToProdataRate !== null && eCurrencies[fee.value.prodataToProdataRateCurrencyId]?.length ? fee.value.prodataToProdataRate + ' ' + eCurrencies[fee.value.prodataToProdataRateCurrencyId] : '-'" matTooltipClass="white-tooltip" appShowIfTruncated>
                                                                {{fee.value.prodataToProdataRate !== null && eCurrencies[fee.value.prodataToProdataRateCurrencyId]?.length ? fee.value.prodataToProdataRate + ' ' + eCurrencies[fee.value.prodataToProdataRateCurrencyId] : '-'}}
                                                            </span>
                                                        </ng-template>
                                                    </ng-container>

                                                    <ng-container *ngIf="fee.value.editable; else consultantFeeCurrencyDisplay">
                                                        <div fxFlex="25%" fxLayout="row" fxLayoutAlign="start start">
                                                            <mat-form-field appearance="fill" class="u-w--100 formFieldNoMarginPadding filter-select u-mr--10" fxFlex="30%">
                                                                <input required matInput type="number" placeholder="Rate" formControlName="consultantRate">
                                                            </mat-form-field>
                                                            <mat-form-field appearance="fill" class="u-w--100 formFieldNoMarginPadding filter-select" fxFlex="50%">
                                                                <mat-select required formControlName="consultantRateCurrencyId" placeholder="Currency" [disableOptionCentering]="true">
                                                                    <ng-container *ngFor="let item of currencies; trackBy: trackById">
                                                                        <mat-option [value]="item.id">
                                                                            {{ item.name }}
                                                                        </mat-option>
                                                                    </ng-container>
                                                                </mat-select>
                                                            </mat-form-field>
                                                        </div>
                                                    </ng-container>
                                                    <ng-template #consultantFeeCurrencyDisplay>
                                                        <span fxFlex="25%" class="u-w--100 text-truncate-ellipsis" [matTooltip]="fee.value.consultantRate !== null && eCurrencies[fee.value.consultantRateCurrencyId]?.length ? fee.value.consultantRate + ' ' + eCurrencies[fee.value.consultantRateCurrencyId] : '-'" matTooltipClass="white-tooltip" appShowIfTruncated>
                                                            {{fee.value.consultantRate !== null && eCurrencies[fee.value.consultantRateCurrencyId]?.length ? fee.value.consultantRate + ' ' + eCurrencies[fee.value.consultantRateCurrencyId] : '-'}}
                                                        </span>
                                                    </ng-template>

                                                    <ng-container *ngIf="fee.value.editable; else clientFeeActionDisplay">
                                                        <div fxFlex="10%" class="u-w--100 text-truncate-ellipsis" fxLayoutAlign="end center" [fxHide]="readOnlyMode">
                                                            <button mat-icon-button type="button" [disabled]="!fee.valid" appPreventDoubleClick (throttledClick)="editOrSaveConsultantFee(consultantIndex, specialFeeIndex, fee.value.editable)" class="rates-and-fees--inline-edit-form--btn__save">
                                                                <mat-icon svgIcon="rates-save-icon"></mat-icon>
                                                            </button>
                                                            <button mat-icon-button type="button" appPreventDoubleClick (throttledClick)="cancelEditConsultantFee(consultantIndex, specialFeeIndex)" class="rates-and-fees--inline-edit-form--btn__cancel">
                                                                <mat-icon svgIcon="rates-cancel-icon"></mat-icon>
                                                            </button>
                                                        </div>
                                                    </ng-container>
                                                    <ng-template #clientFeeActionDisplay>
                                                        <div fxFlex="10%" fxLayoutAlign="end center" class="u-w--100" [fxHide]="readOnlyMode">
                                                            <button mat-icon-button type="button" appPreventDoubleClick (throttledClick)="$event.stopPropagation();" [matMenuTriggerFor]="consultantFeeMenu" class="three-dots-actions-btn">
                                                                <mat-icon svgIcon="3-dots"></mat-icon>
                                                            </button>
                                                            <mat-menu #consultantFeeMenu>
                                                                <button
                                                                    class="menu-item green-color"
                                                                    mat-menu-item
                                                                    appPreventDoubleClick (throttledClick)="editOrSaveConsultantFee(consultantIndex, specialFeeIndex, fee.value.editable)">
                                                                    <mat-icon svgIcon="edit-icon-green"></mat-icon>
                                                                    Edit
                                                                </button>
                                                                <button
                                                                    class="menu-item menu-item--cancel"
                                                                    mat-menu-item
                                                                    appPreventDoubleClick (throttledClick)="removeConsutlantFee(consultantIndex, specialFeeIndex)">
                                                                    <mat-icon svgIcon="close-icon"></mat-icon>
                                                                    Delete
                                                                </button>
                                                            </mat-menu>
                                                        </div>
                                                    </ng-template>
                                                </ng-container>
                                            </div>
                                        </ng-container>
                                        <ng-container *ngIf="consultant.value.specialFees?.length === 0 && readOnlyMode">
                                            <div fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="10px" class="emptyStateRow u-mt--15">
                                                <span class="light-grey-color text-600">
                                                    No consultant fees
                                                </span>
                                            </div>
                                        </ng-container>
                                    </ng-container>
                                </div>

                                <div fxLayout="row" fxLayoutAlign="start start"
                                [fxHide]="readOnlyMode">
                                    <button class="rates-and-fees--btn button-add" mat-flat-button
                                        [ngClass]="{'u-mt--16': consultant.value.specialFees?.length}"
                                        [matMenuTriggerFor]="consultantSpecialFeeMenu"
                                        [disabled]="isConsultantFeeEditing"
                                        type="button"
                                        #consultantFeeMenuTrigger="matMenuTrigger"
                                        (menuOpened)="consultantSpecialFeeSelect.open();">
                                        <mat-icon>add</mat-icon>
                                        Add special fees
                                    </button>
                                    <mat-menu #consultantSpecialFeeMenu backdropClass="add-rates-button--menu">
                                        <div mat-menu-item appPreventDoubleClick (throttledClick)="$event.stopPropagation()" class="u-pg--0">
                                            <mat-form-field appearance="fill" class="add-rates-button--dropdown filter-select u-w--100">
                                                <mat-label>Choose special fee</mat-label>
                                                <mat-select #consultantSpecialFeeSelect formControlName="consultantSpecialFeeFilter" [disableOptionCentering]="true">
                                                    <ng-container *ngFor="let item of clientSpecialFeeList | excludeIds: consultant.value.specialFees : 'clientSpecialFeeId'; trackBy: trackById">
                                                        <mat-option [disabled]="item.id === null" [value]="item.id" appPreventDoubleClick (throttledClick)="item.id !== null ? selectConsultantSpecialFee($event, consultantIndex, item, consultantFeeMenuTrigger) : ''">
                                                            {{ item.internalName }}
                                                        </mat-option>
                                                    </ng-container>
                                                </mat-select>
                                            </mat-form-field>
                                        </div>
                                    </mat-menu>
                                </div>
                            </div>
                        </div>

                        <div fxLayout="column" fxLayoutAlign="start start" class="u-w--100" [id]="'salesConsultantPayment' + consultantIndex">
                            <div fxLayout="row" fxLayoutAlign="start center" class="u-mt--16 u-mb--16">
                                <span class="workflow-section--number">5</span>
                                <h2 class="workflow-section--header">Consultant payment</h2>
                            </div>
                            <div class="workflow-section--content">
                                <div fxLayout="row" fxLayoutAlign="start start" class="u-w--100">
                                    <mat-form-field appearance="outline" class="formFieldNoMarginPadding filter-select form-width-312">
                                        <mat-label>emagine payment entity (consultant)</mat-label>
                                        <mat-select [disabled]="readOnlyMode" required formControlName="pdcPaymentEntityId" [disableOptionCentering]="true" (selectionChange)="pdcEntityChanged(consultantIndex)">
                                            <ng-container *ngFor="let item of legalEntities; trackBy: trackById">
                                                <mat-option [value]="item.id">
                                                    {{ item.tenantName + ' ' + '(' + item.name + ')' }}
                                                </mat-option>
                                            </ng-container>
                                        </mat-select>
                                        <mat-error>
                                            <app-validator [control]="consultant.get('pdcPaymentEntityId')"></app-validator>
                                        </mat-error>
                                    </mat-form-field>
                                </div>

                                <ng-container *ngIf="consultant.value.pdcPaymentEntityId">
                                    <div fxLayout="row" fxLayoutAlign="start start" class="u-w--100">
                                        <mat-form-field appearance="outline" class="formFieldNoMarginPadding filter-select form-width-150">
                                            <mat-label>Price</mat-label>
                                            <mat-select [disabled]="readOnlyMode" required formControlName="consultantRateTypeId" [disableOptionCentering]="true">
                                                <ng-container *ngFor="let item of clientRateTypes; trackBy: trackById">
                                                    <mat-option [value]="item.id">
                                                        {{ item.name }}
                                                    </mat-option>
                                                </ng-container>
                                            </mat-select>
                                            <mat-error>
                                                <app-validator [control]="consultant.get('consultantRateTypeId')"></app-validator>
                                            </mat-error>
                                        </mat-form-field>
                                    </div>

                                    <ng-container class="u-w--100" [ngSwitch]="consultant.value.consultantRateTypeId">
                                        <ng-container *ngSwitchCase="eRateType.TimeBased">
                                            <div fxLayout="row" fxLayoutAlign="start center" class="u-w--100">
                                                <mat-form-field appearance="outline" class="formFieldNoMarginPadding u-mr--12 form-width-150" [ngClass]="{'disabled-input': readOnlyMode}">
                                                    <mat-label>Rate</mat-label>
                                                    <input [disabled]="readOnlyMode" required autocomplete="off" matInput formControlName="consultantRate" type="number">
                                                    <mat-error>
                                                        <app-validator [control]="consultant.get('consultantRate')"></app-validator>
                                                    </mat-error>
                                                </mat-form-field>
                                                <mat-form-field appearance="outline" class="formFieldNoMarginPadding filter-select u-mr--12 form-width-150">
                                                    <mat-label>Unit type</mat-label>
                                                    <mat-select [disabled]="readOnlyMode" required formControlName="rateUnitTypeId" [disableOptionCentering]="true" (selectionChange)="updateProdataUnitType($event, consultantIndex)">
                                                        <ng-container *ngFor="let item of rateUnitTypes; trackBy: trackById">
                                                            <mat-option [value]="item.id">
                                                                {{ item.name }}
                                                            </mat-option>
                                                        </ng-container>
                                                    </mat-select>
                                                    <mat-error>
                                                        <app-validator [control]="consultant.get('rateUnitTypeId')"></app-validator>
                                                    </mat-error>
                                                </mat-form-field>
                                                <mat-form-field appearance="outline" class="formFieldNoMarginPadding filter-select u-mr--12 form-width-150">
                                                    <mat-label>Currency</mat-label>
                                                    <mat-select [disabled]="readOnlyMode" required formControlName="consultantRateCurrencyId" [disableOptionCentering]="true">
                                                        <ng-container *ngFor="let item of currencies; trackBy: trackById">
                                                            <mat-option [value]="item.id">
                                                                {{ item.name }}
                                                            </mat-option>
                                                        </ng-container>
                                                    </mat-select>
                                                    <mat-error>
                                                        <app-validator [control]="consultant.get('consultantRateCurrencyId')"></app-validator>
                                                    </mat-error>
                                                </mat-form-field>
                                                <div fxLayoutAlign="start center" class="workflow-form--consultants__payment-price-text">
                                                    <ng-container [ngTemplateOutlet]="marginComponent"
                                                        [ngTemplateOutletContext]="{consultant: consultant, type: eMarginType.PlainTimeBased}">
                                                    </ng-container>
                                                </div>
                                            </div>
                                            <ng-container *ngIf="consultant.value?.pdcPaymentEntityId !== clientDataForm.value?.pdcInvoicingEntityId">
                                                <div fxLayout="row" fxLayoutAlign="start center" class="u-w--100">
                                                    <mat-form-field appearance="outline" class="formFieldNoMarginPadding u-mr--12 form-width-150" [ngClass]="{'disabled-input': readOnlyMode}">
                                                        <mat-label>e-to-e rate</mat-label>
                                                        <input [disabled]="readOnlyMode" required autocomplete="off" matInput formControlName="consultantPDCRate" type="number">
                                                        <mat-error>
                                                            <app-validator [control]="consultant.get('consultantPDCRate')"></app-validator>
                                                        </mat-error>
                                                    </mat-form-field>
                                                    <mat-form-field appearance="outline" class="formFieldNoMarginPadding filter-select u-mr--12 form-width-150">
                                                        <mat-label>Unit type</mat-label>
                                                        <mat-select [disabled]="readOnlyMode" required formControlName="consultantPDCRateUnitTypeId" [disableOptionCentering]="true" [disabled]="true">
                                                            <ng-container *ngFor="let item of rateUnitTypes; trackBy: trackById">
                                                                <mat-option [value]="item.id">
                                                                    {{ item.name }}
                                                                </mat-option>
                                                            </ng-container>
                                                        </mat-select>
                                                        <mat-error>
                                                            <app-validator [control]="consultant.get('consultantPDCRateUnitTypeId')"></app-validator>
                                                        </mat-error>
                                                    </mat-form-field>
                                                    <mat-form-field appearance="outline" class="formFieldNoMarginPadding filter-select u-mr--12 form-width-150">
                                                        <mat-label>Currency</mat-label>
                                                        <mat-select [disabled]="readOnlyMode" required formControlName="consultantPDCRateCurrencyId" [disableOptionCentering]="true">
                                                            <ng-container *ngFor="let item of currencies; trackBy: trackById">
                                                                <mat-option [value]="item.id">
                                                                    {{ item.name }}
                                                                </mat-option>
                                                            </ng-container>
                                                        </mat-select>
                                                        <mat-error>
                                                            <app-validator [control]="consultant.get('consultantPDCRateCurrencyId')"></app-validator>
                                                        </mat-error>
                                                    </mat-form-field>
                                                    <div fxLayoutAlign="start center" class="workflow-form--consultants__payment-price-text">
                                                        <ng-container [ngTemplateOutlet]="marginComponent"
                                                            [ngTemplateOutletContext]="{consultant: consultant, type: eMarginType.PDCTimeBased}">
                                                        </ng-container>
                                                    </div>
                                                </div>
                                                <div fxLayout="row" fxLayoutAlign="start center" class="u-w--100 u-mb--10">
                                                    <ng-container [ngTemplateOutlet]="marginComponent"
                                                        [ngTemplateOutletContext]="{consultant: consultant, type: eMarginType.TotalTimeBasedMargin}">
                                                    </ng-container>
                                                </div>
                                            </ng-container>
                                        </ng-container>
                                        <ng-container *ngSwitchCase="eRateType.Fixed">
                                            <div fxLayout="row" fxLayoutAlign="start center" class="u-w--100">
                                                <mat-form-field appearance="outline" class="formFieldNoMarginPadding u-mr--12 form-width-150" [ngClass]="{'disabled-input': readOnlyMode}">
                                                    <mat-label>Rate</mat-label>
                                                    <input [disabled]="readOnlyMode" required autocomplete="off" matInput formControlName="consultantRate" type="number">
                                                    <mat-error>
                                                        <app-validator [control]="consultant.get('consultantRate')"></app-validator>
                                                    </mat-error>
                                                </mat-form-field>
                                                <mat-form-field appearance="outline" class="formFieldNoMarginPadding filter-select u-mr--12 form-width-150">
                                                    <mat-label>Currency</mat-label>
                                                    <mat-select [disabled]="readOnlyMode" required formControlName="consultantRateCurrencyId" [disableOptionCentering]="true">
                                                        <ng-container *ngFor="let item of currencies; trackBy: trackById">
                                                            <mat-option [value]="item.id">
                                                                {{ item.name }}
                                                            </mat-option>
                                                        </ng-container>
                                                    </mat-select>
                                                    <mat-error>
                                                        <app-validator [control]="consultant.get('consultantRateCurrencyId')"></app-validator>
                                                    </mat-error>
                                                </mat-form-field>
                                                <div fxLayoutAlign="start center" class="workflow-form--consultants__payment-price-text">
                                                    <ng-container [ngTemplateOutlet]="marginComponent"
                                                        [ngTemplateOutletContext]="{consultant: consultant, type: eMarginType.PlainFixed}">
                                                    </ng-container>
                                                </div>
                                            </div>
                                            <ng-container *ngIf="consultant.value?.pdcPaymentEntityId && (consultant.value?.pdcPaymentEntityId !== clientDataForm.value?.pdcInvoicingEntityId)">
                                                <div fxLayout="row" fxLayoutAlign="start center" class="u-w--100">
                                                    <mat-form-field appearance="outline" class="formFieldNoMarginPadding u-mr--12 form-width-150" [ngClass]="{'disabled-input': readOnlyMode}">
                                                        <mat-label>e-to-e rate</mat-label>
                                                        <input [disabled]="readOnlyMode" required autocomplete="off" matInput formControlName="consultantPDCRate" type="number">
                                                        <mat-error>
                                                            <app-validator [control]="consultant.get('consultantPDCRate')"></app-validator>
                                                        </mat-error>
                                                    </mat-form-field>
                                                    <mat-form-field appearance="outline" class="formFieldNoMarginPadding filter-select u-mr--12 form-width-150">
                                                        <mat-label>Currency</mat-label>
                                                        <mat-select [disabled]="readOnlyMode" required formControlName="consultantPDCRateCurrencyId" [disableOptionCentering]="true">
                                                            <ng-container *ngFor="let item of currencies; trackBy: trackById">
                                                                <mat-option [value]="item.id">
                                                                    {{ item.name }}
                                                                </mat-option>
                                                            </ng-container>
                                                        </mat-select>
                                                        <mat-error>
                                                            <app-validator [control]="consultant.get('consultantPDCRateCurrencyId')"></app-validator>
                                                        </mat-error>
                                                    </mat-form-field>
                                                    <div fxLayoutAlign="start center" class="workflow-form--consultants__payment-price-text">
                                                        <ng-container [ngTemplateOutlet]="marginComponent"
                                                            [ngTemplateOutletContext]="{consultant: consultant, type: eMarginType.PDCFixed}">
                                                        </ng-container>
                                                    </div>
                                                </div>
                                                <div fxLayout="row" fxLayoutAlign="start center" class="u-w--100">
                                                    <ng-container [ngTemplateOutlet]="marginComponent"
                                                        [ngTemplateOutletContext]="{consultant: consultant, type: eMarginType.TotalFixedMargin}">
                                                    </ng-container>
                                                </div>
                                            </ng-container>
                                        </ng-container>
                                        <ng-container *ngSwitchDefault>
                                        </ng-container>
                                    </ng-container>
                                    <div fxLayout="row" fxLayoutAlign="start center" class="u-w--100" [fxHide]="consultant.value.consultantRateTypeId !== eRateType.TimeBased">
                                        <mat-form-field appearance="outline" class="formFieldNoMarginPadding filter-select form-width-312" [ngClass]="{'u-mr--12': consultant.value.consultantInvoicingFrequency?.name === 'Manual date'}" [fxHide]="clientDataForm.clientRateTypeId?.value !== eRateType.Fixed">
                                            <mat-label>Invoicing frequency</mat-label>
                                            <mat-select [disabled]="readOnlyMode" [required]="consultant.value.consultantRateTypeId === eRateType.TimeBased && clientDataForm.clientRateTypeId?.value?.id === eRateType.Fixed" formControlName="consultantInvoicingFrequency" [disableOptionCentering]="true" [compareWith]="compareWithFn">
                                                <ng-container *ngFor="let item of invoiceFrequencies; trackBy: trackById">
                                                    <mat-option [value]="item">
                                                        {{ item.name }}
                                                    </mat-option>
                                                </ng-container>
                                            </mat-select>
                                            <mat-error>
                                                <app-validator [control]="consultant.get('consultantInvoicingFrequency')"></app-validator>
                                            </mat-error>
                                        </mat-form-field>
                                        <mat-form-field class="formFieldNoMarginPadding form-width-150" [fxHide]="consultant.value.consultantInvoicingFrequency?.name !== 'Manual date'" appearance="outline" [ngClass]="{'disabled-input': readOnlyMode}">
                                            <mat-label>Date</mat-label>
                                            <input [disabled]="readOnlyMode" [required]="consultant.value.consultantInvoicingFrequency?.name === 'Manual date'" autocomplete="off" matInput
                                                    [matDatepicker]="consultantInvoicingDatePicker"
                                                    name="consultantInvoicingManualDateFrequency" formControlName="consultantInvoicingManualDate"
                                                    (focus)="consultantInvoicingDatePicker.open()"
                                                    appPreventDoubleClick (throttledClick)="consultantInvoicingDatePicker.open()" readonly>
                                            <mat-icon class="calendar-icon" matSuffix svgIcon="calendar"></mat-icon>
                                            <mat-datepicker #consultantInvoicingDatePicker></mat-datepicker>
                                            <mat-error>
                                                <app-validator [control]="consultant.get('consultantInvoicingManualDate')"></app-validator>
                                            </mat-error>
                                        </mat-form-field>
                                    </div>
                                    <div fxLayout="row" fxLayoutAlign="start center" class="u-w--100" [fxHide]="consultant.value.consultantRateTypeId !== eRateType.Fixed">
                                        <mat-form-field appearance="outline" class="formFieldNoMarginPadding filter-select form-width-312" [ngClass]="{'u-mr--12': consultant.value.consultantInvoicingTime?.name === 'Manual date'}">
                                            <mat-label>Invoicing time</mat-label>
                                            <mat-select [disabled]="readOnlyMode" [required]="consultant.value.consultantRateTypeId === eRateType.Fixed" formControlName="consultantInvoicingTime" [disableOptionCentering]="true" [compareWith]="compareWithFn">
                                                <ng-container *ngFor="let item of invoicingTimes; trackBy: trackById">
                                                    <mat-option [value]="item">
                                                        {{ item.name }}
                                                    </mat-option>
                                                </ng-container>
                                            </mat-select>
                                            <mat-error>
                                                <app-validator [control]="consultant.get('consultantInvoicingTime')"></app-validator>
                                            </mat-error>
                                        </mat-form-field>
                                        <!-- id: 2 - Manual date -->
                                        <mat-form-field class="formFieldNoMarginPadding form-width-150" appearance="outline" [fxHide]="consultant.value?.consultantInvoicingTime?.name !== 'Manual date'" [ngClass]="{'disabled-input': readOnlyMode}">
                                            <mat-label>Date</mat-label>
                                            <input [disabled]="readOnlyMode" [required]="consultant.value?.consultantInvoicingTime?.name === 'Manual date'" autocomplete="off" matInput
                                                    [matDatepicker]="consultantInvoiceDatePicker"
                                                    name="consultantInvoicingManualDate" formControlName="consultantInvoicingManualDate"
                                                    (focus)="consultantInvoiceDatePicker.open()"
                                                    appPreventDoubleClick (throttledClick)="consultantInvoiceDatePicker.open()" readonly>
                                            <mat-icon class="calendar-icon" matSuffix svgIcon="calendar"></mat-icon>
                                            <mat-datepicker #consultantInvoiceDatePicker></mat-datepicker>
                                            <mat-error>
                                                <app-validator [control]="consultant.get('consultantInvoicingManualDate')"></app-validator>
                                            </mat-error>
                                        </mat-form-field>
                                    </div>
                                    <div fxLayout="row" fxLayoutAlign="start center" class="u-w--100" [fxHide]="(!clientDataForm.value?.pdcInvoicingEntityId || !consultant.value?.pdcPaymentEntityId) || (consultant.value?.pdcPaymentEntityId === clientDataForm.value?.pdcInvoicingEntityId)">
                                        <mat-form-field appearance="outline" class="formFieldNoMarginPadding filter-select form-width-150">
                                            <mat-label>emagine invoicing currency</mat-label>
                                            <mat-select [disabled]="readOnlyMode" [required]="(clientDataForm.value?.pdcInvoicingEntityId && consultant.value?.pdcPaymentEntityId) && (consultant.value?.pdcPaymentEntityId !== clientDataForm.value?.pdcInvoicingEntityId)" formControlName="prodataToProdataInvoiceCurrencyId" [disableOptionCentering]="true">
                                                <ng-container *ngFor="let item of currencies; trackBy: trackById">
                                                    <mat-option [value]="item.id">
                                                        {{ item.name }}
                                                    </mat-option>
                                                </ng-container>
                                            </mat-select>
                                            <mat-error>
                                                <app-validator [control]="consultant.get('prodataToProdataInvoiceCurrencyId')"></app-validator>
                                            </mat-error>
                                        </mat-form-field>
                                    </div>
                                </ng-container>
                                <div fxLayout="row" fxLayoutAlign="start start" class="u-w--100">
                                    <mat-form-field appearance="outline" class="form-width-564 formFieldNoMarginPadding textarea-input u-mr--12" [ngClass]="{'disabled-input': readOnlyMode}">
                                        <mat-label>Special Payment Terms</mat-label>
                                        <textarea [disabled]="readOnlyMode" [required]="consultant.value?.employmentTypeId !== employmentTypesEnum.FeeOnly && consultant.value?.employmentTypeId !== employmentTypesEnum.Recruitment" matInput autocomplete="new-password" name="specialPaymentTerms" formControlName="specialPaymentTerms" [cdkTextareaAutosize]="true" [cdkAutosizeMinRows]="2">
                                        </textarea>
                                        <mat-error>
                                            <app-validator [control]="consultant.get('specialPaymentTerms')"></app-validator>
                                        </mat-error>
                                    </mat-form-field>
                                    <ng-container *ngIf="!readOnlyMode || consultant.get('noSpecialPaymentTerms')?.value">
                                        <mat-checkbox [disabled]="readOnlyMode" color="accent" formControlName="noSpecialPaymentTerms" name="noSpecialPaymentTerms" class="black-checkbox u-mt--5" (change)="disableOrEnableInput(consultant?.value?.noSpecialPaymentTerms, consultant?.get('specialPaymentTerms'))">
                                            None
                                        </mat-checkbox>
                                    </ng-container>
                                </div>
                            </div>
                        </div>
                        <div fxLayout="column" fxLayoutAlign="start start" class="u-w--100" [id]="'salesConsultantFrameAgreement' + consultantIndex">
                            <div fxLayout="row" fxLayoutAlign="start center" class="u-mt--16 u-mb--16">
                                <span class="workflow-section--number">6</span>
                                <h2 class="workflow-section--header">Frame agreement</h2>
                            </div>
                            <div class="workflow-section--content">
                                <div fxLayout="row" fxLayoutAlign="start center" class="u-w--100">
                                    <mat-form-field appearance="outline"
                                        class="formFieldNoMarginPadding filter-select autocompleteWithShevron u-mr--12 form-width-450"
                                        [ngClass]="{'disabled-input': readOnlyMode, 'isPanelOpen': frameAgreementAutocomplete.isOpen}">
                                        <mat-label>Frame agreement</mat-label>
                                        <input [disabled]="readOnlyMode" #frameAgreementInput type="text"
                                            matInput [matAutocomplete]="frameAgreementAutocomplete"
                                            formControlName="frameAgreementId" appPreventDoubleClick
                                            (throttledClick)="$event.stopPropagation()" placeholder="Frame agreement">
                                            <span matSuffix class="shevron"></span>
                                        <mat-autocomplete #frameAgreementAutocomplete="matAutocomplete"
                                            [displayWith]="displayAgreementNameFn" (optionSelected)="focusToggleMethod('auto')"
                                            (opened)="focusToggleMethod('hidden')" (closed)="onAutocompleteClosed(consultant.get('frameAgreementId'), 'agreementId')">
                                            <ng-container *ngFor="let item of filteredFrameAgreements[consultantIndex]; trackBy: trackById">
                                                <mat-option [value]="item" [ngClass]="{ 'no-data': item?.agreementId === undefined }">
                                                    <div class="multilineDropdown-option--row">
                                                        <div class="multilineDropdown-option--column text-truncate-ellipsis">
                                                            <span class="multilineDropdown-option--column-client-name">{{ item.agreementName }}</span>
                                                            <ng-container *ngIf="item?.agreementId !== undefined">
                                                                <span class="multilineDropdown-option--column-client-info text-truncate-ellipsis light-grey-color">
                                                                    #{{item?.agreementId}} 
                                                                    {{item.countryName}}
                                                                    {{item.countryName ? '' : ''}}
                                                                    {{item.startDate | momentFormat}}
                                                                    {{item.startDate !== null && item.startDate !== undefined ? '-' : ''}}
                                                                    {{item.endDate | momentFormat}}
                                                                </span>
                                                            </ng-container>
                                                        </div>
                                                    </div>
                                                </mat-option>
                                            </ng-container>
                                        </mat-autocomplete>
                                        <mat-error>
                                            <app-validator [control]="consultant.get('frameAgreementId')"></app-validator>
                                        </mat-error>
                                    </mat-form-field>
                                </div>
                            </div>
                        </div>
                        <div fxLayout="column" fxLayoutAlign="start start" class="u-w--100" [id]="'salesConsultantContract' + consultantIndex">
                            <div fxLayout="row" fxLayoutAlign="start center" class="u-mt--16 u-mb--16">
                                <span class="workflow-section--number">7</span>
                                <h2 class="workflow-section--header">Consultant contract</h2>
                            </div>
                            <div class="workflow-section--content">
                                <div fxLayout="row" fxLayoutAlign="start start" class="u-w--100 u-mb--20">
                                    <mat-form-field appearance="outline" class="formFieldNoMarginPadding textarea-input u-mr--12 form-width-564" [ngClass]="{'disabled-input': readOnlyMode}">
                                        <mat-label>Special Contract Terms</mat-label>
                                        <textarea [disabled]="readOnlyMode" [required]="consultant.value?.employmentTypeId !== employmentTypesEnum.FeeOnly && consultant.value?.employmentTypeId !== employmentTypesEnum.Recruitment" matInput autocomplete="new-password" name="consultantSpecialContractTerms" formControlName="consultantSpecialContractTerms" [cdkTextareaAutosize]="true" [cdkAutosizeMinRows]="2">
                                        </textarea>
                                        <mat-error>
                                            <app-validator [control]="consultant.get('consultantSpecialContractTerms')"></app-validator>
                                        </mat-error>
                                    </mat-form-field>
                                    <ng-container *ngIf="!readOnlyMode || consultant.get('consultantSpecialContractTermsNone')?.value">
                                        <mat-checkbox [disabled]="readOnlyMode" color="accent" formControlName="consultantSpecialContractTermsNone" name="consultantSpecialContractTermsNone" class="black-checkbox u-mt--5" (change)="disableOrEnableInput(consultant?.value?.consultantSpecialContractTermsNone, consultant?.get('consultantSpecialContractTerms'))">
                                            None
                                        </mat-checkbox>
                                    </ng-container>
                                </div>
                                <ng-container *ngIf="consultant.value?.consultantName?.consultant?.supplierId !== null && consultant.value?.consultantName?.consultant?.supplierId !== undefined">
                                    <h3 class="workflow-gray--header u-mb--10">Supplier Contract Signers</h3>
                                    <div formArrayName="contractSigners" class="u-w--100">
                                        <ng-container *ngFor="let signer of getConsultantSignersControls(consultantIndex); trackBy: trackByItem; let signerIndex = index" [formGroupName]="signerIndex">
                                            <div fxLayout="row" fxLayoutAlign="start center" class="u-w--100">
                                                <mat-form-field appearance="outline"
                                                    class="u-w--100 formFieldNoMarginPadding filter-select autocompleteWithShevron u-mr--16" fxFlex="33%"
                                                    [ngClass]="{'disabled-input': readOnlyMode, 'isPanelOpen': contactSignerAutocomplete.isOpen}">
                                                    <mat-label>Name</mat-label>
                                                    <input [disabled]="readOnlyMode" required type="text" matInput
                                                        [matAutocomplete]="contactSignerAutocomplete" formControlName="supplierMember"
                                                        appPreventDoubleClick (throttledClick)="$event.stopPropagation()"
                                                        placeholder="Name">
                                                        <span matSuffix class="shevron"></span>
                                                    <mat-autocomplete #contactSignerAutocomplete="matAutocomplete"
                                                        [displayWith]="displayNameFn" (optionSelected)="focusToggleMethod('auto')"
                                                        (opened)="focusToggleMethod('hidden')" (closed)="onAutocompleteClosed(signer.get('supplierMember'), 'id')">
                                                        <ng-container *ngFor="let contact of filteredSupplierMembers[consultantIndex][signerIndex]; trackBy: trackById">
                                                            <mat-option [value]="contact"
                                                                [ngClass]="{ 'no-data': contact?.id === undefined }">
                                                                <span class="autocopmlete-option-name">{{ contact.name}}</span>
                                                            </mat-option>
                                                        </ng-container>
                                                    </mat-autocomplete>
                                                    <mat-error>
                                                        <app-validator
                                                            [control]="signer.get('supplierMember')"></app-validator>
                                                    </mat-error>
                                                </mat-form-field>

                                                <mat-form-field appearance="outline"
                                                    class="u-w--100 formFieldNoMarginPadding filter-select u-mr--16" fxFlex="33%">
                                                    <mat-label>Supplier Role</mat-label>
                                                    <mat-select [disabled]="readOnlyMode" required formControlName="signerRoleId"
                                                        [disableOptionCentering]="true">
                                                        <ng-container *ngFor="let item of signerRoles; trackBy: trackById">
                                                            <mat-option [value]="item.id">
                                                                {{ item.name }}
                                                            </mat-option>
                                                        </ng-container>
                                                    </mat-select>
                                                    <mat-error>
                                                        <app-validator [control]="signer.get('signerRoleId')"></app-validator>
                                                    </mat-error>
                                                </mat-form-field>

                                                <mat-form-field appearance="outline"
                                                    class="u-w--100 formFieldNoMarginPadding filter-select u-mr--16" fxFlex="20%">
                                                    <mat-label>Sequence</mat-label>
                                                    <mat-select [disabled]="readOnlyMode" required formControlName="signOrder"
                                                        [disableOptionCentering]="true">
                                                        <ng-container *ngFor="let item of [1,2,3,4,5,6,7]">
                                                            <mat-option [value]="item">
                                                                {{ item }}
                                                            </mat-option>
                                                        </ng-container>
                                                    </mat-select>
                                                    <mat-error>
                                                        <app-validator
                                                            [control]="signer.get('signOrder')"></app-validator>
                                                    </mat-error>
                                                </mat-form-field>
                                                <ng-container *ngIf="!readOnlyMode">
                                                    <button class="form-icon--delete-row" type="button" mat-icon-button
                                                        appPreventDoubleClick (throttledClick)="removeConsutlantSigner(consultantIndex, signerIndex)"><mat-icon
                                                            svgIcon="remove-icon"></mat-icon></button>
                                                </ng-container>
                                            </div>
                                        </ng-container>
                                        <ng-container *ngIf="consultant.value.contractSigners?.length === 0 && readOnlyMode">
                                            <div fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="10px" class="emptyStateRow u-mt--15">
                                                <span class="light-grey-color text-600">
                                                    No contract signers
                                                </span>
                                            </div>
                                        </ng-container>
                                        <ng-container *ngIf="!readOnlyMode">
                                            <button class="button-add" mat-flat-button type="button" appPreventDoubleClick
                                                (throttledClick)="addSignerToForm(consultantIndex)">
                                                <mat-icon>add</mat-icon>
                                                Add Signer
                                            </button>
                                        </ng-container>
                                    </div>
                                </ng-container>
                            </div>
                        </div>
                        <div fxLayout="column" fxLayoutAlign="start start" class="u-w--100" [id]="'salesConsultantEmagineToEmagine' + consultantIndex">
                            <div fxLayout="row" fxLayoutAlign="start center" class="u-mt--16 u-mb--16">
                                <span class="workflow-section--number">8</span>
                                <h2 class="workflow-section--header">Emagine to emagine</h2>
                            </div>
                            <div class="workflow-section--content">
                                <ng-container *ngIf="(consultant.value?.pdcPaymentEntityId && clientDataForm.value?.pdcInvoicingEntityId) && (consultant.value?.pdcPaymentEntityId !== clientDataForm.value?.pdcInvoicingEntityId); else noDeliveryAccountManager">
                                    <div fxLayout="row" fxLayoutAlign="start center" class="u-w--100">
                                        <mat-form-field appearance="outline"
                                            class="formFieldNoMarginPadding filter-select autocompleteWithShevron u-mr--12 form-width-450"
                                            [ngClass]="{'disabled-input': readOnlyMode, 'isPanelOpen': frameAgreementAutocomplete.isOpen}">
                                            <mat-label>Frame agreement</mat-label>
                                            <input [disabled]="readOnlyMode" #frameAgreementInput type="text"
                                                matInput [matAutocomplete]="frameAgreementAutocomplete"
                                                formControlName="emagineFrameAgreementId" appPreventDoubleClick
                                                (throttledClick)="$event.stopPropagation()" placeholder="Frame agreement">
                                                <span matSuffix class="shevron"></span>
                                            <mat-autocomplete #frameAgreementAutocomplete="matAutocomplete"
                                                [displayWith]="displayAgreementNameFn" (optionSelected)="focusToggleMethod('auto')"
                                                (opened)="focusToggleMethod('hidden')" (closed)="onAutocompleteClosed(consultant.get('emagineFrameAgreementId'), 'agreementId')">
                                                <ng-container *ngFor="let item of filteredEmagineFrameAgreements[consultantIndex]; trackBy: trackById">
                                                    <mat-option [value]="item" [ngClass]="{ 'no-data': item?.agreementId === undefined }">
                                                        <div class="multilineDropdown-option--row">
                                                            <div class="multilineDropdown-option--column text-truncate-ellipsis">
                                                                <span class="multilineDropdown-option--column-client-name">{{ item.agreementName }}</span>
                                                                <ng-container *ngIf="item?.agreementId !== undefined">
                                                                    <span class="multilineDropdown-option--column-client-info text-truncate-ellipsis light-grey-color">
                                                                        #{{item?.agreementId}} 
                                                                        {{item.countryName}}
                                                                        {{item.countryName ? '' : ''}}
                                                                        {{item.startDate | momentFormat}}
                                                                        {{item.startDate !== null && item.startDate !== undefined ? '-' : ''}}
                                                                        {{item.endDate | momentFormat}}
                                                                    </span>
                                                                </ng-container>
                                                            </div>
                                                        </div>
                                                    </mat-option>
                                                </ng-container>
                                            </mat-autocomplete>
                                            <mat-error>
                                                <app-validator [control]="consultant.get('emagineFrameAgreementId')"></app-validator>
                                            </mat-error>
                                        </mat-form-field>
                                    </div>
                                    <div fxLayout="row" fxLayoutAlign="start center" class="u-w--100">
                                        <mat-form-field appearance="outline" class="formFieldNoMarginPadding filter-select autocompleteWithShevron u-mr--12 form-width-235" [ngClass]="{'disabled-input': readOnlyMode, 'isPanelOpen': deliveryManagerAutocomplete.isOpen}">
                                            <mat-label>Delivery Account manager</mat-label>
                                            <input [disabled]="readOnlyMode" required #deliveryManagerFilterInput type="text" matInput [matAutocomplete]="deliveryManagerAutocomplete" formControlName="deliveryAccountManager" appPreventDoubleClick (throttledClick)="$event.stopPropagation()" placeholder="Select account manager(s)">
                                            <span matSuffix class="shevron"></span>
                                            <mat-autocomplete #deliveryManagerAutocomplete="matAutocomplete" [displayWith]="displayNameFn"
                                                (optionSelected)="focusToggleMethod('auto')" (opened)="focusToggleMethod('hidden')" (closed)="onAutocompleteClosed(consultant.get('deliveryAccountManager'), 'id')">
                                                <ng-container *ngFor="let manager of filteredAccountManagers; trackBy: trackById">
                                                    <mat-option [value]="manager" [ngClass]="{ 'no-data': manager?.id === undefined }">
                                                        <span class="autocopmlete-option-name">{{ manager.name }}</span>
                                                    </mat-option>
                                                </ng-container>
                                            </mat-autocomplete>
                                            <mat-error>
                                                <app-validator [control]="consultant.get('deliveryAccountManager')"></app-validator>
                                            </mat-error>
                                        </mat-form-field>
                                        <ng-container *ngIf="!readOnlyMode || consultant.get('deliveryManagerSameAsAccountManager')?.value">
                                            <mat-checkbox color="accent" formControlName="deliveryManagerSameAsAccountManager" name="deliveryManagerSameAsAccountManager" class="black-checkbox"
                                                [disabled]="readOnlyMode"
                                                (change)="setValueAndToggleDisalbeState(consultant?.value?.deliveryManagerSameAsAccountManager, consultant?.get('deliveryAccountManager'), mainDataForm.salesAccountManagerIdValue?.value)">
                                                Same as account manager
                                            </mat-checkbox>
                                        </ng-container>
                                    </div>
                                </ng-container>
                                <ng-template #noDeliveryAccountManager>
                                    <div fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="10px" class="emptyStateRow">
                                        <span class="light-grey-color text-600">
                                            Required only for Nearshore projects
                                        </span>
                                    </div>
                                </ng-template>
                            </div>
                        </div>
                    </ng-container>
                </div>
            </ng-container>
            <ng-container *ngIf="!readOnlyMode">
                <ng-container *ngIf="((appEnv.production || appEnv.qa) && consultantsForm.consultants.controls.length === 0) || appEnv.dev">
                    <div fxLayout="row" fxLayoutAlign="start start" class="u-w--100" [fxHide]="activeSideSection.typeId !== workflowSideSections.StartClientPeriod || (isCompleted !== editEnabledForcefuly)">
                        <button class="button-add mat-elevation-z0 u-mt--10 u-mb--10"  type="button" mat-flat-button appPreventDoubleClick (throttledClick)="addConsultantForm()">
                            <mat-icon>add</mat-icon>
                            Add consultant
                        </button>
                    </div>
                </ng-container>
            </ng-container>
        </div>
    </ng-container>
    <button #submitFormBtn class="display-none" type="submit">Hidden button to set form submitted</button>
</form>

<ng-template #clientAdditionalInfo let-client="client">
    <div fxLayout="column" fxLayoutAlign="start start">
        <ng-container *ngIf="client?.clientId">
            <button class="link-to-client-icon green-color u-mr--8" mat-flat-button type="button"
                (click)="openClientInNewTab(client?.clientId)"
                [matTooltip]="'Link to Client profile'" matTooltipClass="white-tooltip">
                <mat-icon svgIcon="link-to-client-icon"></mat-icon>
                Client profile
            </button>
        </ng-container>

        <ng-container *ngIf="client?.clientId">
            <button class="link-to-client-icon orange-color" mat-flat-button type="button"
                (click)="openInHubspot(client)"
                [disabled]="client.crmClientId === null || client.crmClientId === undefined"
                [matTooltip]="'Link to Hubspot'" matTooltipClass="white-tooltip">
                <mat-icon svgIcon="link-to-client-hubspot-icon"></mat-icon>
                Hubspot
            </button>
        </ng-container>
    </div>
</ng-template>

<ng-template #clientPrefix let-client="client">
    <ng-container *ngIf="client?.clientId !== undefined && client?.clientAddresses?.length">
        <span
            class="multilineDropdown-option--column-client-info text-truncate-ellipsis">
            #{{client?.clientId}} | {{client?.clientAddresses[0]?.city ?? ''}} {{client?.clientAddresses[0]?.countryName ?
            ', ' + client?.clientAddresses[0]?.countryName : ''}}
        </span>
    </ng-container>
</ng-template>

<ng-template #marginComponent let-consultant="consultant" let-type="type">
    <calculated-margin [marginType]="type"
        [data]="{clientRate: clientDataForm.normalRate?.value,clientCurrencyId: clientDataForm.clientCurrencyId?.value,
            clientUnitTypeId: clientDataForm.rateUnitTypeId?.value,
            clientPaymentType: clientDataForm.value?.clientRateTypeId,
            clientPdcEntity: clientDataForm.value?.pdcInvoicingEntityId,
            consultantRate: consultant.value?.consultantRate,
            consultantCurrencyId: consultant.value?.consultantRateCurrencyId,
            consultantUnitTypeId: consultant.value?.rateUnitTypeId,
            consultantPDCRate: consultant?.value?.consultantPDCRate,
            consultantPDCCurrencyId: consultant.value?.consultantPDCRateCurrencyId,
            consultantPDCUnitTypeId: consultant.value?.consultantPDCRateUnitTypeId,
            consultantPaymentType: consultant.value?.consultantRateTypeId,
            consultantPdcEntity: consultant.value?.pdcPaymentEntityId}">
    </calculated-margin>
</ng-template>

