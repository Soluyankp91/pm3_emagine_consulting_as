<div class="workflow" fxLayout="column" fxLayoutAlign="start start" #scroller>

    <div fxLayout="row" fxLayoutAlign="start start" class="workflow-header u-w--100">
        <div fxFlex="1 0 40%" fxLayout="column">
            <h2 class="workflow-header--title">
                <span *ngIf="workflowConsultants.length && workflowConsultants.length === 1">
                    {{workflowConsultants[0].consultantName}}
                </span>
                <span *ngIf="workflowConsultants.length && workflowConsultants.length > 1" [matTooltip]="mapListByProperty(workflowConsultants, 'consultantName')" matTooltipClass="white-tooltip">
                    {{workflowConsultants.length + ' Consultants'}}
                </span>
                <span *ngIf="workflowConsultants.length === 0">
                    No consultants
                </span>
                <span [matTooltip]="workflowId" matTooltipClass="white-tooltip">
                    / Workflow ID: {{workflowId | slice: 0:4}}...
                </span>
                <span *ngIf="workflowConsultants.length && workflowConsultants[0].requestId" class="workflow-header--request" matTooltip="Open request on Sourcing" matTooltipClass="white-tooltip" appPreventDoubleClick (throttledClick)="navigateToRequest(workflowConsultants![0].requestUrl!)">
                    / Request ID: {{workflowConsultants[0].requestId}}
                </span>
            </h2>
            <p class="page-main-header u-mb--20">{{workflowClient?.length ? workflowClient : 'New workflow'}}</p>
        </div>

        <div fxFlex="50%" fxLayout="row" *ngIf="isProgressTrackVisible">
            <div fxFlex="50%" fxLayout="column wrap" style="font-size: 12px;">
                <span>
                    Started: {{_workflowDataService.getWorkflowProgress.started}}
                </span>
                <span>
                    currentlyActiveSection: {{mapSectionName(_workflowDataService.getWorkflowProgress.currentlyActiveSection)}}
                </span>
                <span>
                    currentlyActiveStep: {{mapStepName(_workflowDataService.getWorkflowProgress.currentlyActiveStep)}}
                </span>
                <span>
                    currentlyActiveSideSection: {{mapSideSectionName(_workflowDataService.getWorkflowProgress.currentlyActiveSideSection)}}
                </span>
                <span>
                    periodId: {{_workflowDataService.getWorkflowProgress.currentlyActivePeriodId}}
                </span>
            </div>
        </div>
        <div fxFlex="10%" fxLayoutAlign="end center">
            <button *ngIf="selectedTabName === 'Overview'" mat-icon-button class="workflow-icon--notes u-mr--16" appPreventDoubleClick (throttledClick)="showOrHideNotes()"><mat-icon svgIcon="notes-icon"></mat-icon></button>
            <button mat-icon-button [matMenuTriggerFor]="workflowMenu" class="workflow-icon--actions"><mat-icon>more_horiz</mat-icon></button>
            <mat-menu #workflowMenu>
                <button
                    *ngIf="individualConsultantActionsAvailable"
                    class="menu-item menu-item--edit"
                    mat-menu-item
                    [disabled]="false"
                    appPreventDoubleClick (throttledClick)="addConsultant()">
                    <mat-icon>add</mat-icon>
                    Add consultant
                </button>
                <button
                    class="menu-item menu-item--edit"
                    mat-menu-item
                    [disabled]="false"
                    appPreventDoubleClick (throttledClick)="getAvailableConsultantForChangeOrExtend(workflowDiallogActions.Change)">
                    <mat-icon>create</mat-icon>
                    Change Workflow Data
                </button>
                <button
                    class="menu-item menu-item--add"
                    mat-menu-item
                    appPreventDoubleClick (throttledClick)="getAvailableConsultantForChangeOrExtend(workflowDiallogActions.Extend)">
                    <mat-icon>add</mat-icon>
                    Extend Workflow
                </button>
                <button
                    class="menu-item menu-item--cancel"
                    mat-menu-item
                    appPreventDoubleClick (throttledClick)="addTermination()">
                    <mat-icon>clear</mat-icon>
                    Terminate Workflow
                </button>
            </mat-menu>
        </div>
    </div>



    <div *ngIf="topToolbarVisible" fxLayout="row" fxLayoutAlign="start center" class="workflow-toolbar u-w--100">
        <p class="workflow-toolbar--client u-mr--20">{{workflowClient?.length ? workflowClient : 'New workflow'}}</p>
    </div>

    <div class="workflow-content u-w--100" id="workflowDetails">
        <mat-tab-group #topMenuTabs class="workflow-content--tabs u-w--100" (selectedTabChange)="tabChanged($event)" [(selectedIndex)]="selectedIndex">
            <mat-tab label="Overview">
                <ng-template mat-tab-label>
                    <div fxLayout="row" fxLayoutAlign="center center">
                        <mat-icon class="u-mr--10" svgIcon="overview-icon"></mat-icon>
                        <div fxLayout="column" fxLayoutAlign="center start">
                            <span class="tab-header">Overview</span>
                        </div>
                    </div>
                </ng-template>
                <div class="workflow-form--panel pos-relative u-w--100">
                    <app-workflow-overview></app-workflow-overview>
                    <div *ngIf="isNoteVisible" class="workflow-notes-wrapper">
                        <app-workflow-notes (noteHidden)="isNoteVisible = !isNoteVisible" [topToolbarVisible]="topToolbarVisible" [workflowId]="workflowId" [alwaysVisible]="false"></app-workflow-notes>
                    </div>
                </div>
            </mat-tab>
            <mat-tab *ngFor="let tab of clientPeriods; let i = index;" [label]="tab.name!">
                <ng-template mat-tab-label>
                    <div fxLayout="row" fxLayoutAlign="center center">
                        <span class="tab-header">{{tab.name}}</span>
                    </div>
                    <span class="tab-subheader">{{tab.startDate | momentFormat: 'DD.MM.YYYY'}} - {{tab.endDate ? (tab.endDate | momentFormat: 'DD.MM.YYYY') : '...'}}</span>
                </ng-template>
                <div fxLayout="row" fxLayoutAlign="start start" class="workflow-form--panel u-w--100">
                    <div fxFlex="80%">
                        <app-workflow-period *ngIf="selectedIndex === i + 1" [periodId]="tab.id" [workflowId]="workflowId"></app-workflow-period>
                    </div>
                    <div fxFlex="20%" class="workflow-notes-wrapper">
                        <app-workflow-notes *ngIf="selectedIndex === i + 1" [topToolbarVisible]="topToolbarVisible" [workflowId]="workflowId" [alwaysVisible]="true"></app-workflow-notes>
                    </div>
                </div>
            </mat-tab>
        </mat-tab-group>
        <div fxLayout="row" [fxLayoutAlign]="_workflowDataService.getWorkflowProgress.currentStepIsForcefullyEditing ? 'space-between center' : 'end center'" class="workflow-controls" *ngIf="bottomToolbarVisible">
            <button mat-flat-button
                    class="button-cancel mat-elevation-z0 u-mr--16"
                    *ngIf="_workflowDataService.getWorkflowProgress?.currentStepIsForcefullyEditing"
                    appPreventDoubleClick (throttledClick)="cancelForceEdit()">
                Cancel
            </button>
            <button mat-flat-button
                    class="button-outlined mat-elevation-z0 u-mr--16"
                    *ngIf="_workflowDataService.getWorkflowProgress?.stepSpecificPermissions!['Edit']"
                    appPreventDoubleClick (throttledClick)="saveOrCompleteStep(true)">
                {{_workflowDataService.getWorkflowProgress.currentStepIsForcefullyEditing ? 'Save' : 'Save draft'}}
            </button>
            <button color="primary"
                    class="button-accept mat-elevation-z0"
                    mat-flat-button
                    *ngIf="_workflowDataService.getWorkflowProgress?.stepSpecificPermissions!['Completion']"
                    appPreventDoubleClick (throttledClick)="saveOrCompleteStep(false)">
                    Complete step
            </button>
        </div>
    </div>
</div>
